# PRD-004: 微信小程序用户认证系统

## 元数据
```yaml
prd_id: "PRD-004"
product_area: "Identity & Access"
owner: "Product Manager"
status: "Done"
created_date: "2025-01-06"
last_updated: "2025-01-12"
related_stories: ["US-014"]
```

## 变更日志
| 日期 | 变更 | 原因 | 操作人 |
|------|------|------|--------|
| 2025-01-06 | 创建 | 初始版本 | PM |
| 2025-01-12 | 重构 | 符合文档规范，移除技术实现细节 | AI |

---

## 问题陈述

微信小程序用户无法使用邮箱注册登录系统，导致移动端购票流程受阻。目标用户群体（追求便捷预订体验的休闲旅客）面临高摩擦的注册流程，造成 60% 的移动端用户流失。

## 解决方案概述

实现基于微信的无缝认证体验：
- **一键登录**：通过 wx.login + code2Session 实现微信授权一键登录
- **手机绑定**：可选的手机号授权绑定（采用微信新版 API，更安全）
- **自动建账**：首次登录自动创建用户账号，无需手动注册

用户从"2分钟邮箱注册"简化为"5秒微信授权"。

---

## 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 登录成功率 | >98% | API 监控 |
| 登录响应时间 | <500ms (P95) | APM 监控 |
| 注册转化率提升 | +30% | 对比邮箱注册 |
| 移动端 GMV 占比 | 40% (3个月内) | 销售数据 |
| 安全事故 | 0 | 安全审计 |

---

## 核心功能

| 功能 | 描述 | 关联 Story |
|------|------|-----------|
| 微信一键登录 | 用户通过微信授权一键登录，自动创建/登录账号，返回 JWT 令牌 | US-014 |
| 手机号绑定 | 用户可选择授权微信手机号，一键绑定无需手动输入 | US-014 |
| 会话管理 | JWT 令牌 7 天有效期，本地持久化存储，过期后重新登录 | US-014 |

---

## 业务规则摘要

1. **一个微信用户 = 一个系统账号**：通过 openid 唯一标识
2. **首次登录自动建账**：默认名称 "微信用户 XXXXXX"
3. **手机绑定可选**：不强制，在首次购买成功后提示
4. **不存储敏感密钥**：session_key 不落库（安全规范）
5. **复用现有认证体系**：JWT 中间件、用户表

---

## 风险与依赖

### 依赖
- ✅ JWT 认证中间件已存在
- ✅ 用户管理系统已完成 (US-009)
- ⬜ 微信小程序 AppID/AppSecret（需运营配置）
- ⬜ 微信开放平台企业认证（手机号 API 必需）

### 风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 微信 API 不可用 | 低 | 高 | 重试机制、优雅降级 |
| API 配额超限 | 中 | 中 | access_token 缓存 |
| 用户隐私顾虑 | 低 | 中 | 清晰隐私政策、最小数据收集 |

---

## 开放问题

- [x] 是否支持微信 + 邮箱账号合并？→ Phase 2
- [x] Web 端是否支持微信扫码登录？→ Phase 2
- [ ] 小程序认证资质获取进度？

---

## 相关文档

| 文档类型 | 文档 | 说明 |
|---------|------|------|
| Story | [US-014](../stories/US-014-wechat-miniprogram-auth.md) | 用户能力与验收标准 |
| Card | [wechat-auth-login](../cards/wechat-auth-login.md) | 登录 API 技术契约 |
| Card | [wechat-phone-binding](../cards/wechat-phone-binding.md) | 手机绑定技术契约 |
