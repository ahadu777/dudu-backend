---
id: US-017
title: "分销商账单与数据分析"
owner: Product
status: "Done"
priority: High
created_date: "2025-12-17"
last_updated: "2025-12-17"
business_requirement: "PRD-002"
depends_on:
  - US-012  # OTA 平台集成（票券批次生成）
enhances:
  - US-013  # 场馆核销（核销事件触发账单）
cards:
  - ota-premade-tickets  # 批次元数据中包含分销商信息
---

## 变更日志
| 日期 | 变更 | 原因 |
|------|------|------|
| 2025-12-17 | 创建 | 补充 PRD-005 缺失的 Story |

---

## 用户目标

**作为** OTA 合作伙伴或分销商
**我想要** 查看票券核销数据和佣金账单
**以便于** 我能准确对账并管理分销业务

---

## 范围

### 包含 (In Scope)
- 分销商信息管理（通过批次元数据）
- 按分销商查询核销数据
- 佣金计算和账单查询
- 批次级别的使用统计

### 不包含 (Out of Scope)
- 自动化账单生成（Phase 2 暂缓）
- 7年审计存档系统（Phase 3 暂缓）
- 争议管理工作流（线下处理）
- 自动付款通知

---

## 验收标准

### A. 分销商信息管理
- **Given** OTA 合作伙伴需要为下游分销商生成票券批次
- **When** 创建票券批次时填写分销商信息（名称、佣金率、结算周期）
- **Then** 分销商信息随批次保存，后续可用于账单查询

### B. 核销数据查询
- **Given** 分销商的票券已在场馆被核销
- **When** OTA 合作伙伴查询某分销商的核销记录
- **Then** 系统返回该分销商所有批次的核销统计（已核销数量、核销时间、场馆）

### C. 佣金账单查看
- **Given** 分销商有已核销的票券
- **When** 查询某时间段的账单数据
- **Then** 系统显示：
  - 各批次的核销数量
  - 按批次锁定价格计算的应付金额
  - 按分销商佣金率计算的佣金金额

### D. 批次使用统计
- **Given** OTA 合作伙伴需要了解批次销售情况
- **When** 查看批次详情
- **Then** 显示批次的激活率、核销率、剩余有效票券数

---

## 业务规则

1. **佣金计算基于核销**：只有已核销的票券才计入账单，未使用的票券不产生费用
2. **价格锁定**：账单金额按批次生成时的价格快照计算，不受后续价格变动影响
3. **分销商佣金率**：默认 10%，可在批次创建时自定义
4. **结算周期**：支持周结、月结、季结，默认月结
5. **数据来源**：分销商信息存储在批次元数据中，账单数据从核销记录聚合

---

## 关联 Cards

| Card | 状态 | 描述 |
|------|------|------|
| ota-premade-tickets | Done | 批次生成时包含分销商元数据 |

---

## 实现说明

当前实现采用轻量级方案：
- 分销商数据嵌入批次 `reseller_metadata` 字段
- 账单查询通过 API 手动聚合核销数据
- 暂不需要独立的分销商管理表

待业务规模增长后，可扩展为完整的自动化账单系统（Phase 2/3）。
