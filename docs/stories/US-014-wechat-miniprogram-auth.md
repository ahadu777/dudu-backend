---
id: US-014
title: "微信小程序用户认证"
owner: Product
status: "Done"
priority: High
created_date: "2025-01-06"
last_updated: "2025-01-12"
business_requirement: "PRD-004"
depends_on: []
enhances: ["US-001", "US-009", "US-010A"]
cards:
  - wechat-auth-login
  - wechat-phone-binding
---

# US-014: 微信小程序用户认证

## 变更日志
| 日期 | 变更 | 原因 |
|------|------|------|
| 2025-01-06 | 创建 | 初始版本 |
| 2025-01-12 | 重构 | 符合文档规范，移除技术实现细节至 Cards |

---

## 用户目标

**作为** 微信小程序用户
**我想要** 使用微信账号一键登录系统
**以便** 我可以快速购买船票和管理订单，无需繁琐的邮箱注册

---

## 范围

### 包含 (In Scope)
- 微信授权一键登录
- 首次登录自动创建账号
- 7 天登录状态保持
- 可选的手机号授权绑定
- 关闭小程序后重新打开仍保持登录

### 不包含 (Out of Scope)
- 微信与邮箱账号合并（Phase 2）
- Web 端微信扫码登录（Phase 2）
- Token 自动刷新机制（Phase 2）
- 用户头像/昵称同步（Phase 2）

---

## 验收标准

### A. 首次登录（新用户）
- **Given** 用户从未登录过小程序
- **When** 用户点击"微信登录"按钮并授权
- **Then** 系统自动为用户创建账号
- **And** 用户看到登录成功提示
- **And** 用户可以访问购票、订单等功能

### B. 再次登录（老用户）
- **Given** 用户之前已通过微信登录过
- **When** 用户再次点击"微信登录"
- **Then** 系统识别用户身份并登录
- **And** 用户可以看到之前的订单和船票

### C. 保持登录状态
- **Given** 用户已登录小程序
- **When** 用户关闭小程序后重新打开（7天内）
- **Then** 用户仍保持登录状态
- **And** 无需重新点击登录按钮

### D. 登录过期
- **Given** 用户已登录超过 7 天
- **When** 用户打开小程序
- **Then** 系统提示用户重新登录
- **And** 用户点击"微信登录"可恢复登录状态

### E. 手机号绑定（可选）
- **Given** 用户已通过微信登录
- **When** 用户点击"绑定手机号"并授权
- **Then** 系统获取并保存用户手机号
- **And** 用户看到手机号绑定成功提示

### F. 跳过手机绑定
- **Given** 用户已通过微信登录
- **When** 系统提示绑定手机号
- **Then** 用户可以选择"跳过"
- **And** 用户仍可正常使用系统功能

### G. 登录失败处理
- **Given** 用户尝试登录
- **When** 登录过程出现异常（网络问题等）
- **Then** 用户看到友好的错误提示
- **And** 用户可以点击"重试"

---

## 业务规则

1. **一个微信 = 一个账号**
   - 每个微信用户只能创建一个系统账号
   - 通过微信 openid 唯一标识用户

2. **自动创建账号**
   - 首次登录自动创建账号，无需手动注册
   - 默认用户名："微信用户 XXXXXX"（可修改）

3. **手机号绑定可选**
   - 不强制用户绑定手机号
   - 首次购买成功后提示绑定（可跳过）
   - 绑定后可用于订单通知、客服联系

4. **登录状态有效期**
   - 登录状态保持 7 天
   - 过期后需重新授权登录
   - 用户数据不会丢失

5. **隐私保护**
   - 仅获取必要的用户信息
   - 手机号需用户主动授权
   - 不存储微信敏感密钥

---

## 关联 Cards

| Card | 状态 | 描述 |
|------|------|------|
| [wechat-auth-login](../cards/wechat-auth-login.md) | Done | 微信登录 API 实现 |
| [wechat-phone-binding](../cards/wechat-phone-binding.md) | Done | 手机号绑定 API 实现 |

---

## 增强的 Stories

| Story | 增强方式 |
|-------|----------|
| US-001 | 微信用户可购买船票 |
| US-009 | 微信用户可访问个人中心 |
| US-010A | 解锁小程序旅客闭环体验 |
