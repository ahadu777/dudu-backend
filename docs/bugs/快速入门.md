# Bug 追踪系统 - 快速入门指南

## 📁 文件结构

```
docs/bugs/
├── _index.yaml                 # Bug 主索引（所有 bug 的注册表）
├── BUG_TEMPLATE_CN.md         # 中文模板（3 种格式可选）
├── 快速入门.md                # 本文件
├── ACTIVE/                    # 活跃的 bug
│   └── BUG-001-inventory-filter-null-check.md
└── RESOLVED/                  # 已解决的 bug（归档）
```

## 🚀 5分钟上手

### 1. 发现 Bug 后立即记录

```bash
# 复制模板
cp docs/bugs/BUG_TEMPLATE_CN.md docs/bugs/ACTIVE/BUG-002-你的问题描述.md

# 编辑文件
vim docs/bugs/ACTIVE/BUG-002-你的问题描述.md
```

### 2. 选择合适的格式

根据 bug 复杂度选择：

**简化格式** - 用于快速 bug（推荐新手使用）
```yaml
---
id: BUG-002
title: 支付回调超时
severity: High
status: Open
affected_cards: [wallyt-payment]
team: A - Commerce
---

# 支付回调超时

## 问题
大订单处理时 webhook 5秒超时

## 复现
POST /payments/wallyt/notify 订单包含 10+ 商品 → 504 超时

## 原因
同步发放票据阻塞响应
文件: src/modules/payments/router.ts:175

## 修复
改为异步队列处理
```

**标准格式** - 用于常规 bug
- 包含详细复现步骤
- 根本原因分析
- 修复方案
- 验证方式

**完整格式** - 用于复杂 bug
- 影响多个 cards/stories
- 需要详细文档
- 完整的事后分析

### 3. 更新主索引

编辑 `docs/bugs/_index.yaml`：

```yaml
bugs:
  - id: BUG-002
    title: 支付回调超时
    severity: High
    status: Open
    affected_cards: [wallyt-payment]
    affected_stories: [US-001]
    team: A - Commerce
    discovered_at: "2025-11-06T15:00:00+0800"
```

### 4. 关联到 Card（可选）

如果 bug 影响特定 card，在 card 的 frontmatter 中添加：

```yaml
# docs/cards/wallyt-payment.md
---
card: "Wallyt payment handler"
...
known_issues: ["BUG-002"]  # 添加这一行
---
```

### 5. 修复后归档

```bash
# 更新状态为 Resolved
# 在 bug 文件中：status: Resolved
# 在 _index.yaml 中：status: Resolved, resolved_at: "2025-11-07T10:00:00+0800"

# 移到 RESOLVED 目录
mv docs/bugs/ACTIVE/BUG-002-*.md docs/bugs/RESOLVED/
```

## 📊 严重性级别

| 级别 | 说明 | 示例 |
|------|------|------|
| **Critical** | 系统宕机、数据丢失、安全漏洞 | 数据库连接失败、用户数据泄露 |
| **High** | 功能完全损坏、阻塞用户故事 | 订单创建失败、支付无法处理 |
| **Medium** | 有临时方案的功能问题 | 错误提示不清晰、性能下降 |
| **Low** | 小问题、体验优化 | UI 错位、文档错误 |

## 🔄 状态生命周期

```
Open           发现 bug，待处理
   ↓
In Progress    开发人员已分配，开始修复
   ↓
PR            创建 Pull Request，等待审查
   ↓
Resolved      修复已合并到主分支
   ↓
Closed        已在生产环境验证，归档
```

## 💡 常用查询命令

```bash
# 查看所有高危 bug
grep "severity: Critical\|High" docs/bugs/_index.yaml

# 查找影响 US-001 的 bug
grep "US-001" docs/bugs/_index.yaml

# 列出所有待处理 bug
grep "status: Open" docs/bugs/_index.yaml

# 统计活跃 bug 数量
ls docs/bugs/ACTIVE/ | wc -l

# 查看最近解决的 bug
ls -lt docs/bugs/RESOLVED/ | head -5

# 按严重性统计
grep "severity:" docs/bugs/_index.yaml | sort | uniq -c
```

## 📝 实际案例

### 场景：发现库存检查 bug

```bash
# 1. 创建 bug 文件
vim docs/bugs/ACTIVE/BUG-001-inventory-filter-null-check.md

# 2. 填写内容（使用简化格式）
---
id: BUG-001
title: 库存为零时返回 null 导致 500 错误
severity: High
status: Open
affected_cards: [order-create]
team: A - Commerce
---

## 问题
产品库存为 0 时，返回 null 导致 500 错误

## 复现
curl -X POST http://localhost:8080/orders -d '{"product_id": 103}'
期望: 400 INSUFFICIENT_INVENTORY
实际: 500 Internal Server Error

## 原因
src/modules/orders/services/inventory.ts:47
return available > 0 ? {available} : null; // 应返回 {available: 0}

## 修复
return { available: product.sellable_quantity ?? 0 }

# 3. 更新索引
vim docs/bugs/_index.yaml
# 添加 BUG-001 条目

# 4. 关联 card
vim docs/cards/order-create.md
# 在 frontmatter 添加: known_issues: ["BUG-001"]

# 5. 开始修复
# ... 修改代码 ...

# 6. 提交代码
git add .
git commit -m "fix: 解决 BUG-001 库存检查 null 问题"

# 7. 更新状态
# 修改 bug 文件和 _index.yaml: status: In Progress → PR → Resolved

# 8. 归档
mv docs/bugs/ACTIVE/BUG-001-*.md docs/bugs/RESOLVED/
```

## 🎯 最佳实践

### ✅ 应该做的

1. **及时记录** - 发现 bug 立即创建文档
2. **详细复现** - 提供可执行的复现步骤
3. **明确影响** - 说清楚谁受影响、有多严重
4. **精确定位** - 指出具体文件和行号
5. **关联追踪** - 链接到相关 cards/stories
6. **及时更新** - 状态变化时同步更新
7. **及时归档** - 解决后移到 RESOLVED/

### ❌ 不应该做的

1. ❌ 只在 commit 中记录 bug，不写文档
2. ❌ Bug 描述含糊不清，无法复现
3. ❌ 忘记更新严重性和状态
4. ❌ 不关联到受影响的 cards
5. ❌ 修复后不归档，ACTIVE 目录混乱

## 🔗 团队分工

### Team A - Commerce（商务团队）
**负责**: 订单、支付、目录、定价、库存
**Bug 示例**:
- 库存检查错误
- 支付超时
- 定价计算错误

### Team B - Fulfillment（履约团队）
**负责**: 票据、权益、用户体验、QR 码
**Bug 示例**:
- 票据发放失败
- QR 码生成错误
- 用户数据同步问题

### Team C - Gate（闸机团队）
**负责**: 核销、操作员、验证、扫描
**Bug 示例**:
- 扫码失败
- 重复核销
- 操作员权限问题

## 📚 参考文档

- [BUG_TEMPLATE_CN.md](./BUG_TEMPLATE_CN.md) - 详细模板和格式说明
- [BUG-001 示例](./ACTIVE/BUG-001-inventory-filter-null-check.md) - 完整的真实案例
- [CLAUDE.md - Bug 报告流程](../../CLAUDE.md#bug-reporting-workflow) - 工作流程集成

## 💬 常见问题

**Q: 什么时候应该创建 bug 文档？**
A: 发现任何需要修复的问题时立即创建。不要等到"有时间"再记录。

**Q: 简化格式够用吗？**
A: 对于大多数 bug，简化格式足够。复杂 bug 再用完整格式。

**Q: 必须关联到 card 吗？**
A: 如果 bug 影响特定 card，建议关联。但不是强制的。

**Q: bug 修复后一定要移到 RESOLVED 吗？**
A: 建议移动，保持 ACTIVE 目录整洁。但至少要更新状态为 Resolved。

**Q: 可以删除已解决的 bug 吗？**
A: 不建议。保留一年作为历史参考和经验教训。

---

**开始使用**: `cp docs/bugs/BUG_TEMPLATE_CN.md docs/bugs/ACTIVE/BUG-XXX-你的问题.md`
