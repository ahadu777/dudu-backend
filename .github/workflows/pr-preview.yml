name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy PR Preview
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          
          echo "üöÄ Deploying to service: ${SERVICE_NAME}"
          
          # Railway CLI uses railway.toml for project context
          # Ensure railway.toml exists (it should from repo)
          if [ ! -f "railway.toml" ]; then
            cat > railway.toml << EOF
          [build]
          builder = "DOCKERFILE"
          
          [deploy]
          startCommand = "npm start"
          healthcheckPath = "/healthz"
          EOF
          fi
          
          # Deploy first to create service if it doesn't exist
          echo "üì¶ Deploying service..."
          railway up --service "$SERVICE_NAME" --detach || {
            echo "‚ö†Ô∏è Initial deployment failed, service may be created now"
          }
          
          # Wait for service to be ready
          sleep 5
          
          # Set environment variables using correct Railway CLI syntax
          # railway variables --set "KEY=value" --service <SERVICE>
          echo "üìù Setting environment variables..."
          railway variables \
            --set "NODE_ENV=preview" \
            --set "PORT=3000" \
            --set "PR_NUMBER=${PR_NUMBER}" \
            --set "DB_NAME=myapp_pr_${PR_NUMBER}" \
            --set "JWT_SECRET=preview-secret-${PR_NUMBER}" \
            --service "$SERVICE_NAME" \
            --skip-deploys || echo "‚ö†Ô∏è Variables set attempted"
          
          # Deploy again with environment variables
          echo "üöÄ Deploying with environment variables..."
          railway up --service "$SERVICE_NAME" --detach
          
          # Wait for deployment
          sleep 15
          
          # Railway auto-assigns domain
          PREVIEW_URL="https://${SERVICE_NAME}.up.railway.app"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ Preview URL: ${PREVIEW_URL}"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const pr = context.issue.number;
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr,
              body: `## üöÄ Preview Environment Ready\n\n**API URL:** ${url}\n\n‚ö†Ô∏è Ephemeral environment, deleted on PR close.`
            });
