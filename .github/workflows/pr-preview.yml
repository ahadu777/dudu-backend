name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI and jq
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          sudo apt-get update && sudo apt-get install -y jq

      - name: Deploy PR Preview
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          
          echo "üöÄ Deploying to service: ${SERVICE_NAME}"
          
          # Verify Railway token is set
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå RAILWAY_TOKEN is not set"
            exit 1
          fi
          
          echo "‚úÖ RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN})"
          echo "‚úÖ RAILWAY_PROJECT_ID: ${RAILWAY_PROJECT_ID}"
          
          # Create railway.toml with project ID for Railway CLI context
          cat > railway.toml << EOF
          project = "${RAILWAY_PROJECT_ID}"
          
          [build]
          builder = "DOCKERFILE"
          
          [deploy]
          startCommand = "npm start"
          healthcheckPath = "/healthz"
          EOF
          
          echo "‚úÖ Created railway.toml with project context"
          
          # Check if service exists, create via Railway GraphQL API if it doesn't
          # NOTE: This requires an Account Token (not Project Token)
          # Project Tokens cannot create services via API
          echo "üîç Checking if service exists..."
          RAILWAY_GRAPHQL="https://backboard.railway.app/graphql/v2"
          
          # Query to list services (using correct GraphQL connection syntax)
          LIST_QUERY='{"query":"query { project(id: \"'${RAILWAY_PROJECT_ID}'\") { services { edges { node { id name } } } } }"}'
          SERVICES_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$LIST_QUERY" \
            "$RAILWAY_GRAPHQL" 2>&1 || echo '{"data":{"project":{"services":{"edges":[]}}}}')
          
          # Check for errors
          if echo "$SERVICES_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è GraphQL query failed (may need Account Token):"
            echo "$SERVICES_RESPONSE" | jq '.errors' 2>/dev/null || echo "$SERVICES_RESPONSE"
            echo ""
            echo "üí° If using Project Token, services must be created manually first."
            echo "   Trying Railway CLI deployment anyway..."
            SERVICE_EXISTS=""
          else
            SERVICE_EXISTS=$(echo "$SERVICES_RESPONSE" | jq -r ".data.project.services.edges[].node | select(.name == \"${SERVICE_NAME}\") | .id" 2>/dev/null || echo "")
          fi
          
          if [ -z "$SERVICE_EXISTS" ] || [ "$SERVICE_EXISTS" == "null" ]; then
            echo "üì¶ Service doesn't exist, attempting to create via Railway API..."
            
            # Create service via GraphQL mutation
            CREATE_MUTATION='{"query":"mutation { serviceCreate(input: {name: \"'${SERVICE_NAME}'\", projectId: \"'${RAILWAY_PROJECT_ID}'\"}) { id name } }"}'
            CREATE_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer ${RAILWAY_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$CREATE_MUTATION" \
              "$RAILWAY_GRAPHQL" 2>&1 || echo "")
            
            # Check if creation succeeded
            if echo "$CREATE_RESPONSE" | jq -e '.data.serviceCreate.id' > /dev/null 2>&1; then
              SERVICE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.data.serviceCreate.id')
              echo "‚úÖ Service created successfully (ID: ${SERVICE_ID})"
              sleep 3
            else
              echo "‚ö†Ô∏è Service creation via API failed (requires Account Token)"
              echo "Response: ${CREATE_RESPONSE}"
              echo ""
              echo "üí° Trying Railway CLI - it may create service automatically..."
            fi
          else
            echo "‚úÖ Service already exists (ID: ${SERVICE_EXISTS})"
          fi
          
          # Deploy with Railway CLI
          # Railway CLI needs RAILWAY_TOKEN in environment, and may need explicit project context
          echo "üì¶ Deploying service..."
          
          # Verify Railway CLI can authenticate
          echo "üîê Verifying Railway CLI authentication..."
          railway whoami 2>&1 || echo "‚ö†Ô∏è Railway CLI auth check failed, but continuing..."
          
          # Deploy using Railway CLI
          # Use explicit project context via railway.toml (already created above)
          railway up --service "$SERVICE_NAME" --detach 2>&1 || {
            echo ""
            echo "‚ö†Ô∏è Railway CLI deployment failed, but service was created via API"
            echo "   Service ID: ${SERVICE_ID:-${SERVICE_EXISTS}}"
            echo "   Trying to set variables and redeploy..."
          }
          
          # Wait a moment
          sleep 5
          
          # Set environment variables using Railway CLI
          echo "üìù Setting environment variables..."
          railway variables \
            --set "NODE_ENV=preview" \
            --set "PORT=3000" \
            --set "PR_NUMBER=${PR_NUMBER}" \
            --set "DB_NAME=myapp_pr_${PR_NUMBER}" \
            --set "JWT_SECRET=preview-secret-${PR_NUMBER}" \
            --service "$SERVICE_NAME" \
            --skip-deploys 2>&1 || {
            echo "‚ö†Ô∏è Variables set failed, trying alternative method..."
            # Try setting variables one by one
            for var in "NODE_ENV=preview" "PORT=3000" "PR_NUMBER=${PR_NUMBER}" "DB_NAME=myapp_pr_${PR_NUMBER}" "JWT_SECRET=preview-secret-${PR_NUMBER}"; do
              railway variables --set "$var" --service "$SERVICE_NAME" --skip-deploys 2>&1 || echo "‚ö†Ô∏è Failed to set ${var%%=*}"
            done
          }
          
          # Deploy again with environment variables
          echo "üöÄ Deploying with environment variables..."
          railway up --service "$SERVICE_NAME" --detach 2>&1 || {
            echo "‚ö†Ô∏è Final deployment via CLI failed"
            echo "   Service was created successfully via API (ID: ${SERVICE_ID:-${SERVICE_EXISTS}})"
            echo "   You may need to deploy manually or check Railway dashboard"
            echo "   Service URL should be: https://${SERVICE_NAME}.up.railway.app"
            # Don't exit - service exists, just deployment might need manual trigger
          }
          
          # Wait for deployment
          sleep 15
          
          # Railway auto-assigns domain
          PREVIEW_URL="https://${SERVICE_NAME}.up.railway.app"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ Preview URL: ${PREVIEW_URL}"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const pr = context.issue.number;
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr,
              body: `## üöÄ Preview Environment Ready\n\n**API URL:** ${url}\n\n‚ö†Ô∏è Ephemeral environment, deleted on PR close.`
            });
