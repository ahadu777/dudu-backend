name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Link Railway project
        run: railway link $RAILWAY_PROJECT_ID

      - name: Deploy PR Preview
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          
          echo "ðŸš€ Deploying to service: ${SERVICE_NAME}"
          
          # Railway up automatically creates service if it doesn't exist
          railway up \
            --service $SERVICE_NAME \
            --env NODE_ENV=preview \
            --env PORT=3000 \
            --env PR_NUMBER=$PR_NUMBER \
            --env DB_NAME=myapp_pr_$PR_NUMBER \
            --env JWT_SECRET=preview-secret-$PR_NUMBER \
            --env USE_DATABASE=false \
            --env SWAGGER_ENABLED=true \
            --detach
          
          # Wait a moment for deployment to start
          sleep 10
          
          # Railway auto-assigns domain: https://${SERVICE_NAME}.up.railway.app
          PREVIEW_URL="https://${SERVICE_NAME}.up.railway.app"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Preview URL: ${PREVIEW_URL}"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const prNumber = '${{ github.event.pull_request.number }}';
            const prBranch = '${{ github.event.pull_request.head.ref }}';
            
            const commentBody = '## ðŸš€ Preview Environment Deployed\n\n' +
              '**Preview API URL:** ' + url + '\n\n' +
              '**PR Details:**\n' +
              '- PR #' + prNumber + '\n' +
              '- Branch: `' + prBranch + '`\n\n' +
              '**Environment:**\n' +
              '- NODE_ENV: `preview`\n' +
              '- PORT: `3000`\n' +
              '- PR_NUMBER: `' + prNumber + '`\n' +
              '- DB_NAME: `myapp_pr_' + prNumber + '`\n\n' +
              '**âš ï¸ Important Notes:**\n' +
              '- This is an ephemeral preview environment\n' +
              '- Data is isolated per PR and will be destroyed when PR is closed\n' +
              '- The environment is automatically updated on each push to this PR\n' +
              '- Access expires when PR is closed or merged\n\n' +
              '**Testing:**\n' +
              '- API Base URL: ' + url + '\n' +
              '- Health Check: ' + url + '/healthz\n' +
              '- Swagger Docs: ' + url + '/docs\n\n' +
              '---\n' +
              '*Automatically deployed by Railway PR Preview workflow*';

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸš€ Preview Environment Deployed')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('âœ… Updated existing preview comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('âœ… Created new preview comment');
            }
