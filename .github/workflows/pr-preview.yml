name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      # ğŸ”‘ REQUIRED: select project (no --project flag exists)
      - name: Link Railway project
        run: railway link "$RAILWAY_PROJECT_ID"

      - name: Deploy PR Preview
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e

          SERVICE_NAME="api-pr-${PR_NUMBER}"
          echo "Deploying service: $SERVICE_NAME"

          railway up \
            --service "$SERVICE_NAME" \
            --env NODE_ENV=preview \
            --env PORT=3000 \
            --env PR_NUMBER="$PR_NUMBER" \
            --env DB_NAME="myapp_pr_${PR_NUMBER}" \
            --env JWT_SECRET="preview-secret-${PR_NUMBER}" \
            --detach

          echo "url=https://${SERVICE_NAME}.up.railway.app" >> $GITHUB_OUTPUT

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `## ğŸš€ Railway Preview Ready

              **API URL:** ${url}

            ğŸ” This preview updates on every push to this PR.  
            ğŸ—‘ï¸ You can safely delete it when the PR is closed.`
                        });
