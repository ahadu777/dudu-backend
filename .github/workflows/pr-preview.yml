name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy PR Preview
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          railway up \
            --project "$RAILWAY_PROJECT_ID" \
            --service "$SERVICE_NAME" \
            --env NODE_ENV=preview \
            --env PORT=3000 \
            --env PR_NUMBER="$PR_NUMBER" \
            --env DB_NAME="myapp_pr_${PR_NUMBER}" \
            --env JWT_SECRET="preview-secret-${PR_NUMBER}" \
            --detach
          echo "url=https://${SERVICE_NAME}.up.railway.app" >> $GITHUB_OUTPUT

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const pr = context.issue.number;
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: pr,
              body: `## üöÄ Preview Environment Ready\n\n**API URL:** ${url}\n\n‚ö†Ô∏è Ephemeral environment, deleted on PR close.`
            });
