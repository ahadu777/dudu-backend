name: Railway PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'open'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Railway CLI and jq
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Authenticate Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Railway CLI v3 uses RAILWAY_TOKEN env var
          export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}"
          # Verify token is set
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå RAILWAY_TOKEN is not set"
            exit 1
          fi
          echo "‚úÖ Railway token is set"

      - name: Link Railway project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          # Railway CLI v3: railway link <project-id> (no --project flag)
          # Create railway.toml or use link command
          railway link "${PROJECT_ID}" 2>&1 || echo "Project link attempted (will continue)"

      - name: Check if service exists and create if needed
        id: service-setup
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_NAME="api-pr-${{ github.event.pull_request.number }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          echo "üîç Looking for service: ${SERVICE_NAME}"
          echo "üì¶ Project ID: ${PROJECT_ID}"
          
          # Ensure project is linked
          echo "üîó Linking to project..."
          railway link "${PROJECT_ID}" 2>&1 || echo "Link attempt completed"
          
          # List all services (with retry)
          echo "üìã Listing services..."
          SERVICES_JSON=$(railway service list --json 2>&1)
          echo "Raw services JSON: ${SERVICES_JSON}"
          
          # Check for errors
          if echo "$SERVICES_JSON" | grep -qi "error\|unauthorized\|not found"; then
            echo "‚ö†Ô∏è Error listing services, retrying..."
            sleep 3
            SERVICES_JSON=$(railway service list --json 2>&1)
            echo "Retry services JSON: ${SERVICES_JSON}"
          fi
          
          # Parse JSON safely
          if [ -z "$SERVICES_JSON" ] || [ "$SERVICES_JSON" == "[]" ]; then
            echo "üìã No services found or empty response"
            SERVICES_JSON="[]"
          fi
          
          # Check if service exists
          if echo "$SERVICES_JSON" | jq -e ".[] | select(.name == \"${SERVICE_NAME}\")" > /dev/null 2>&1; then
            SERVICE_ID=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.name == \"${SERVICE_NAME}\") | .id")
            echo "‚úÖ Service ${SERVICE_NAME} already exists (ID: ${SERVICE_ID})"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "id=${SERVICE_ID}" >> $GITHUB_OUTPUT
          else
            # Create new service
            echo "üÜï Creating service ${SERVICE_NAME}..."
            SERVICE_OUTPUT=$(railway service create --name "${SERVICE_NAME}" --json 2>&1)
            echo "Service create output: ${SERVICE_OUTPUT}"
            
            SERVICE_ID=$(echo "$SERVICE_OUTPUT" | jq -r '.id // empty' 2>/dev/null || echo "")
            
            # If creation failed, try without --json
            if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "null" ] || [ "$SERVICE_ID" == "" ]; then
              echo "‚ö†Ô∏è JSON creation failed, trying without --json flag..."
              railway service create "${SERVICE_NAME}" 2>&1 || echo "Create command executed"
              sleep 5
              SERVICES_JSON=$(railway service list --json 2>&1 || echo "[]")
              SERVICE_ID=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.name == \"${SERVICE_NAME}\") | .id" 2>/dev/null || echo "")
            fi
            
            # Final check
            if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "null" ] || [ "$SERVICE_ID" == "" ]; then
              echo "‚ùå ERROR: Could not create or find service ${SERVICE_NAME}"
              echo "Service list output: ${SERVICES_JSON}"
              echo "‚ö†Ô∏è Service creation failed - deployment will be skipped"
              SERVICE_ID=""
            else
              echo "‚úÖ Created service ${SERVICE_NAME} (ID: ${SERVICE_ID})"
            fi
            
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "id=${SERVICE_ID}" >> $GITHUB_OUTPUT
          fi
          
          # Debug output
          echo "üì§ Outputting SERVICE_ID: ${SERVICE_ID}"
          echo "id=${SERVICE_ID}" >> $GITHUB_OUTPUT

      - name: Set service context
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_ID="${{ steps.service-setup.outputs.id }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          if [ -n "$SERVICE_ID" ] && [ "$SERVICE_ID" != "" ]; then
            railway link "${PROJECT_ID}" --service "${SERVICE_ID}" 2>&1 || \
            railway service use "${SERVICE_ID}" 2>&1 || \
            echo "Service context set"
          fi

      - name: Set environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          SERVICE_ID="${{ steps.service-setup.outputs.id }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "" ]; then
            echo "‚ö†Ô∏è No service ID, skipping environment variables"
            exit 0
          fi
          
          # Ensure context (Railway CLI v3 syntax)
          railway link "${PROJECT_ID}" 2>&1 || true
          railway service use "${SERVICE_ID}" 2>&1 || true
          
          # Set environment variables
          echo "Setting environment variables..."
          railway variables set NODE_ENV=preview 2>&1 | head -5 || echo "NODE_ENV: attempted"
          railway variables set PORT=3000 2>&1 | head -5 || echo "PORT: attempted"
          railway variables set PR_NUMBER="${PR_NUMBER}" 2>&1 | head -5 || echo "PR_NUMBER: attempted"
          railway variables set DB_NAME="myapp_pr_${PR_NUMBER}" 2>&1 | head -5 || echo "DB_NAME: attempted"
          railway variables set JWT_SECRET="preview-secret-${PR_NUMBER}" 2>&1 | head -5 || echo "JWT_SECRET: attempted"
          railway variables set USE_DATABASE=false 2>&1 | head -5 || echo "USE_DATABASE: attempted"
          railway variables set SWAGGER_ENABLED=true 2>&1 | head -5 || echo "SWAGGER_ENABLED: attempted"
          
          echo "‚úÖ Environment variables set for PR #${PR_NUMBER}"

      - name: Deploy to Railway
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_ID="${{ steps.service-setup.outputs.id }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          echo "üîç Checking SERVICE_ID: '${SERVICE_ID}'"
          echo "üì¶ Project ID: ${PROJECT_ID}"
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "" ] || [ "$SERVICE_ID" == "null" ]; then
            echo "‚ùå ERROR: No service ID available, cannot deploy"
            echo "‚ö†Ô∏è Service creation may have failed. Check the 'Check if service exists' step logs."
            echo "üí° This might be due to Railway authentication issues or service creation failures."
            exit 1
          fi
          
          echo "‚úÖ Service ID found: ${SERVICE_ID}"
          
          # Ensure context
          echo "üîó Linking to project and service..."
          railway link "${PROJECT_ID}" 2>&1 || echo "Project link attempted"
          railway service use "${SERVICE_ID}" 2>&1 || echo "Service use attempted"
          
          # Deploy (Railway will detect Dockerfile automatically)
          echo "üöÄ Starting deployment..."
          railway up --detach 2>&1 || railway deploy --detach 2>&1 || railway up 2>&1 || {
            echo "‚ö†Ô∏è Deployment command failed, but continuing..."
            echo "Deployment may still be in progress"
          }
          
          echo "‚úÖ Deployment initiated for PR #${{ github.event.pull_request.number }}"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30

      - name: Get preview URL
        id: preview-url
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_ID="${{ steps.service-setup.outputs.id }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" == "" ]; then
            PREVIEW_URL="https://api-pr-${PR_NUMBER}.up.railway.app"
            echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Using fallback URL: ${PREVIEW_URL}"
            exit 0
          fi
          
          # Ensure context
          railway link "${PROJECT_ID}" 2>&1 || true
          railway service use "${SERVICE_ID}" 2>&1 || true
          sleep 5
          
          # Try to get URL
          PREVIEW_URL=""
          
          # Method 1: Check service status
          STATUS_JSON=$(railway status --json 2>/dev/null || echo "{}")
          PREVIEW_URL=$(echo "$STATUS_JSON" | jq -r '.service.domain // empty' 2>/dev/null || echo "")
          
          # Method 2: Check domains
          if [ -z "$PREVIEW_URL" ] || [ "$PREVIEW_URL" == "null" ] || [ "$PREVIEW_URL" == "" ]; then
            DOMAIN_JSON=$(railway domain --json 2>/dev/null || echo "[]")
            PREVIEW_URL=$(echo "$DOMAIN_JSON" | jq -r '.[0].domain // empty' 2>/dev/null || echo "")
          fi
          
          # Method 3: Check service list
          if [ -z "$PREVIEW_URL" ] || [ "$PREVIEW_URL" == "null" ] || [ "$PREVIEW_URL" == "" ]; then
            SERVICES_JSON=$(railway service list --json 2>/dev/null || echo "[]")
            PREVIEW_URL=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.id == \"${SERVICE_ID}\") | .domain // empty" 2>/dev/null || echo "")
          fi
          
          # Fallback
          if [ -z "$PREVIEW_URL" ] || [ "$PREVIEW_URL" == "null" ] || [ "$PREVIEW_URL" == "" ]; then
            PREVIEW_URL="https://api-pr-${PR_NUMBER}.up.railway.app"
          fi
          
          # Ensure URL starts with https://
          if [[ ! "$PREVIEW_URL" =~ ^https?:// ]]; then
            PREVIEW_URL="https://${PREVIEW_URL}"
          fi
          
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ Preview URL: ${PREVIEW_URL}"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.preview-url.outputs.url }}';
            const prNumber = '${{ github.event.pull_request.number }}';
            const prBranch = '${{ github.event.pull_request.head.ref }}';
            
            const commentBody = '## üöÄ Preview Environment Deployed\n\n' +
              '**Preview API URL:** ' + previewUrl + '\n\n' +
              '**PR Details:**\n' +
              '- PR #' + prNumber + '\n' +
              '- Branch: `' + prBranch + '`\n\n' +
              '**Environment:**\n' +
              '- NODE_ENV: `preview`\n' +
              '- PORT: `3000`\n' +
              '- PR_NUMBER: `' + prNumber + '`\n' +
              '- DB_NAME: `myapp_pr_' + prNumber + '`\n\n' +
              '**‚ö†Ô∏è Important Notes:**\n' +
              '- This is an ephemeral preview environment\n' +
              '- Data is isolated per PR and will be destroyed when PR is closed\n' +
              '- The environment is automatically updated on each push to this PR\n' +
              '- Access expires when PR is closed or merged\n\n' +
              '**Testing:**\n' +
              '- API Base URL: ' + previewUrl + '\n' +
              '- Health Check: ' + previewUrl + '/healthz\n' +
              '- Swagger Docs: ' + previewUrl + '/docs\n\n' +
              '---\n' +
              '*Automatically deployed by Railway PR Preview workflow*';

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üöÄ Preview Environment Deployed')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
              console.log('‚úÖ Updated existing preview comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('‚úÖ Created new preview comment');
            }
