name: Deploy to DigitalOcean

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: ticketing-api

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run build

      - name: Run linter
        run: npm run lint || true

      - name: Run tests
        run: npm test || true

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login

      - name: Tag image for registry
        run: docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Push image to DigitalOcean Container Registry
        run: docker push ${{ env.REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy to DigitalOcean App Platform
        run: |
          doctl apps update ${{ secrets.DO_APP_ID }} --spec=- <<EOF
          name: ticketing-api
          services:
          - name: api
            image:
              registry_type: DOCR
              repository: ${{ env.IMAGE_NAME }}
              tag: ${{ github.sha }}
            http_port: 8080
            instance_count: 1
            instance_size_slug: basic-xxs
            health_check:
              http_path: /healthz
              initial_delay_seconds: 10
              period_seconds: 10
            envs:
            - key: NODE_ENV
              value: production
            - key: PORT
              value: "8080"
            - key: DB_HOST
              value: ${{ secrets.DB_HOST }}
              type: SECRET
            - key: DB_PORT
              value: "3306"
            - key: DB_USERNAME
              value: ${{ secrets.DB_USERNAME }}
              type: SECRET
            - key: DB_PASSWORD
              value: ${{ secrets.DB_PASSWORD }}
              type: SECRET
            - key: DB_DATABASE
              value: ${{ secrets.DB_DATABASE }}
              type: SECRET
            - key: JWT_SECRET
              value: ${{ secrets.JWT_SECRET }}
              type: SECRET
          EOF