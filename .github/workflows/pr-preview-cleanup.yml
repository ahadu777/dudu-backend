name: Railway PR Preview Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: write

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Link Railway project
        run: railway link --project $RAILWAY_PROJECT_ID

      - name: Delete preview service
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          echo "üóëÔ∏è Deleting service: ${SERVICE_NAME}"
          railway service delete $SERVICE_NAME --yes || echo "Service may not exist"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            
            const commentBody = '## üßπ Preview Environment Cleaned Up\n\n' +
              'The preview environment for PR #' + prNumber + ' has been automatically destroyed.\n\n' +
              '**Service:** `api-pr-' + prNumber + '`\n\n' +
              'All resources associated with this preview environment have been removed.\n\n' +
              '---\n' +
              '*Automatically cleaned up by Railway PR Preview workflow*';

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('‚úÖ Posted cleanup comment');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not post cleanup comment (PR may be merged):', error.message);
            }
