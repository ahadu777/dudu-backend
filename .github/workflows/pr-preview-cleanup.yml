name: Railway PR Preview Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Install Railway CLI
        run: curl -fsSL https://railway.app/install.sh | sh

      - name: Add Railway to PATH
        run: echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Delete PR Service
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_NAME="api-pr-${PR_NUMBER}"
          echo "üóëÔ∏è Deleting service: ${SERVICE_NAME}"
          railway service delete "$SERVICE_NAME" --yes || echo "Service may not exist or already deleted"
