name: Railway PR Preview Cleanup

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Railway CLI and jq
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: Authenticate Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          export RAILWAY_TOKEN="${{ secrets.RAILWAY_TOKEN }}"
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå RAILWAY_TOKEN is not set"
            exit 1
          fi
          echo "‚úÖ Railway token is set"

      - name: Set Railway project context
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          # Railway CLI uses RAILWAY_PROJECT_ID env var automatically
          echo "‚úÖ Railway project context set via environment variable"

      - name: Delete preview service
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          SERVICE_NAME="api-pr-${{ github.event.pull_request.number }}"
          PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          
          # Railway CLI uses RAILWAY_PROJECT_ID env var automatically
          # Check if service exists
          SERVICES_JSON=$(railway service list --json 2>/dev/null || echo "[]")
          
          if echo "$SERVICES_JSON" | jq -e ".[] | select(.name == \"${SERVICE_NAME}\")" > /dev/null 2>&1; then
            SERVICE_ID=$(echo "$SERVICES_JSON" | jq -r ".[] | select(.name == \"${SERVICE_NAME}\") | .id")
            echo "üóëÔ∏è Deleting service ${SERVICE_NAME} (ID: ${SERVICE_ID})"
            
            railway service use "${SERVICE_ID}" 2>&1 || echo "Service use attempted"
            railway service delete --yes 2>&1 || railway service delete "${SERVICE_ID}" --yes 2>&1 || railway service delete "${SERVICE_NAME}" --yes 2>&1 || echo "Delete attempted"
            
            echo "‚úÖ Successfully deleted preview environment for PR #${{ github.event.pull_request.number }}"
          else
            echo "‚ÑπÔ∏è Service ${SERVICE_NAME} does not exist, nothing to clean up"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            
            const commentBody = '## üßπ Preview Environment Cleaned Up\n\n' +
              'The preview environment for PR #' + prNumber + ' has been automatically destroyed.\n\n' +
              '**Service:** `api-pr-' + prNumber + '`\n\n' +
              'All resources associated with this preview environment have been removed.\n\n' +
              '---\n' +
              '*Automatically cleaned up by Railway PR Preview workflow*';

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
              console.log('‚úÖ Posted cleanup comment');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not post cleanup comment (PR may be merged):', error.message);
            }
