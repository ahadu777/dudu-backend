<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synque Express - User Stories Demo Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .stories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .story-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .story-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .story-header {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }

        .story-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .story-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .story-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 10px;
        }

        .status-complete {
            background: #d4edda;
            color: #155724;
        }

        .status-ready {
            background: #fff3cd;
            color: #856404;
        }

        .story-content {
            padding: 20px;
        }

        .test-section {
            margin-bottom: 20px;
        }

        .test-section h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #117a8b;
        }

        .response-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
        }

        .loading {
            color: #007bff;
            font-style: italic;
        }

        .error {
            color: #dc3545;
        }

        .success {
            color: #28a745;
        }

        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .auth-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .token-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .footer {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            color: #6c757d;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .stories-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé´ Synque Express Demo</h1>
            <p>Interactive User Stories Dashboard - Test all implemented features</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-stories">9</div>
                <div class="stat-label">User Stories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-stories">6</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-endpoints">15+</div>
                <div class="stat-label">API Endpoints</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">üéØ</div>
                <div class="stat-label">Enhanced Demo</div>
            </div>
        </div>

        <div class="stories-grid">
            <!-- US-001: Buy package and redeem via QR -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-001: Buy Package & Redeem via QR</div>
                    <div class="story-description">Complete ticketing workflow from purchase to redemption</div>
                    <span class="story-status status-complete">‚úÖ Complete</span>
                </div>
                <div class="story-content">
                    <div class="test-section">
                        <h4>Test Workflow</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-catalog">1. View Catalog</button>
                            <button class="btn btn-primary" id="btn-order-create">2. Create Order</button>
                            <button class="btn btn-primary" id="btn-payment-webhook">3. Payment Notify</button>
                            <button class="btn btn-success" id="btn-us001-workflow">üöÄ Run Complete Flow</button>
                        </div>
                        <div class="links">
                            <a href="/docs#/catalog/get_catalog" class="btn btn-info" target="_blank">üìñ API Docs</a>
                            <button class="btn btn-secondary" id="btn-runbook-us001" data-story="US-001">üìã Runbook</button>
                        </div>
                    </div>
                    <div class="response-area" id="us001-response"></div>
                </div>
            </div>

            <!-- US-002: Operator scan & redemption -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-002: Operator Scan & Redemption</div>
                    <div class="story-description">Operator authentication and ticket scanning workflow</div>
                    <span class="story-status status-ready">üîÑ Ready</span>
                </div>
                <div class="story-content">
                    <div class="auth-section">
                        <h4>Operator Authentication</h4>
                        <div class="button-group" style="margin-bottom:8px; gap:8px; align-items:center;">
                            <input type="text" class="token-input" id="operator-username" placeholder="username" value="alice" style="max-width:200px;">
                            <input type="password" class="token-input" id="operator-password" placeholder="password" value="secret123" style="max-width:200px;">
                            <button class="btn btn-info" id="btn-operator-login">Login</button>
                        </div>
                        <input type="text" class="token-input" id="operator-token" placeholder="Operator token will appear here" readonly>
                    </div>

                    <div class="auth-section">
                        <h4>Validator Session</h4>
                        <div class="button-group" style="margin-bottom:8px; gap:8px; align-items:center;">
                            <input type="text" class="token-input" id="validator-device-id" placeholder="device_id" value="gate-01" style="max-width:200px;">
                            <input type="number" class="token-input" id="validator-location-id" placeholder="location_id (optional)" value="52" style="max-width:220px;">
                            <button class="btn btn-info" id="btn-validator-session">Start Session</button>
                        </div>
                        <input type="text" class="token-input" id="validator-session-id" placeholder="Session ID will appear here" readonly>
                    </div>

                    <div class="auth-section">
                        <h4>Scan Ticket</h4>
                        <div class="button-group" style="margin-bottom:8px; gap:8px; align-items:center;">
                            <input type="text" class="token-input" id="scan-function-code" placeholder="function_code (e.g., bus/ferry/metro)" style="max-width:280px;">
                            <input type="text" class="token-input" id="scan-qr-token" placeholder="Paste qr_token here or generate in US-003" style="flex:1;">
                            <button class="btn btn-primary" id="btn-ticket-scan">Scan</button>
                        </div>
                        <small>Tip: Use US-003 to view tickets and generate QR token. The token and suggested function_code will autopopulate here.</small>
                    </div>
                    <div class="test-section">
                        <h4>Test Workflow</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-runbook-us002" data-story="US-002">üìã Open Runbook</button>
                            <button class="btn btn-success" id="btn-simulate-redemption">üöÄ Simulate Redemption</button>
                            <button class="btn btn-secondary" id="btn-reset-mock">üßπ ‰∏ÄÈîÆÈáçÁΩÆ</button>
                        </div>
                        <div class="links"></div>
                    </div>
                    <div class="response-area" id="us002-response"></div>
                </div>
            </div>

            <!-- US-003: Buyer views tickets & QR -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-003: Buyer Views Tickets & QR</div>
                    <div class="story-description">User ticket management and QR code generation</div>
                    <span class="story-status status-complete">‚úÖ Complete</span>
                </div>
                <div class="story-content">
                    <div class="auth-section">
                        <h4>Authentication Required</h4>
                        <input type="text" class="token-input" id="user-token" placeholder="Enter JWT token or click Generate">
                        <button class="btn btn-info" id="btn-generate-token">Generate Test Token</button>
                    </div>
                    <div class="test-section">
                        <h4>Test Workflow</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-my-tickets">1. View My Tickets</button>
                            <button class="btn btn-primary" id="btn-qr-token">2. Generate QR Token</button>
                        </div>
                        <div class="button-group" style="gap:10px; align-items:center;">
                            <select id="user-ticket-select" class="token-input" style="max-width:320px; display:none;"></select>
                            <select id="user-ticket-fn-select" class="token-input" style="max-width:260px; display:none;"></select>
                            <small id="user-ticket-hint" style="color:#6c757d; display:none;">Select ticket and function_code before generating QR.</small>
                        </div>
                        <div class="links">
                            <button class="btn btn-secondary" id="btn-runbook-us003" data-story="US-003">üìã Runbook</button>
                        </div>
                    </div>
                    <div class="response-area" id="us003-response"></div>
                </div>
            </div>

            <!-- US-009: User Profile and Settings -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-009: User Profile & Settings</div>
                    <div class="story-description">User profile management and preferences</div>
                    <span class="story-status status-complete">‚úÖ Complete</span>
                </div>
                <div class="story-content">
                    <div class="auth-section">
                        <h4>Authentication Required</h4>
                        <input type="text" class="token-input" id="profile-token" placeholder="Enter JWT token or use same as above">
                        <button class="btn btn-info" id="btn-copy-token">Copy User Token</button>
                    </div>
                    <div class="test-section">
                        <h4>Test Workflow</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-get-profile">1. Get Profile</button>
                            <button class="btn btn-primary" id="btn-update-profile">2. Update Profile</button>
                            <button class="btn btn-primary" id="btn-get-settings">3. Get Settings</button>
                            <button class="btn btn-primary" id="btn-update-settings">4. Update Settings</button>
                            <button class="btn btn-primary" id="btn-get-activity">5. View Activity</button>
                            <button class="btn btn-success" id="btn-us009-workflow">üöÄ Run Complete Flow</button>
                        </div>
                        <div class="links">
                            <button class="btn btn-secondary" id="btn-runbook-us009" data-story="US-009">üìã Runbook</button>
                        </div>
                    </div>
                    <div class="response-area" id="us009-response"></div>
                </div>
            </div>

            <!-- US-008: Promotion Details -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-008: Enhanced Promotion Detail View</div>
                    <div class="story-description">Rich product information with badges, images, and time-limited offers</div>
                    <span class="story-status status-complete">‚úÖ Complete</span>
                </div>
                <div class="story-content">
                    <div class="test-section">
                        <h4>API Testing</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-promo-101">üöå Transport Pass</button>
                            <button class="btn btn-primary" id="btn-promo-102">üöá Day Pass</button>
                            <button class="btn btn-primary" id="btn-promo-103">üé® Museum Ticket</button>
                            <button class="btn btn-primary" id="btn-promo-104">üé¢ Park Pass</button>
                        </div>
                        <div class="button-group">
                            <a href="/demo/promotions" class="btn btn-success" target="_blank">üéØ Interactive Demo</a>
                            <button class="btn btn-info" id="btn-test-enhanced-features">‚ú® Test Enhanced Features</button>
                        </div>
                        <div class="links">
                            <button class="btn btn-secondary" id="btn-runbook-us008" data-story="US-008">üìã Runbook</button>
                        </div>
                    </div>
                    <div class="response-area" id="us008-response"></div>
                </div>
            </div>

            <!-- US-007: Ticket Cancellation -->
            <div class="story-card">
                <div class="story-header">
                    <div class="story-title">US-007: Ticket Cancellation & Refund</div>
                    <div class="story-description">Cancel tickets and process refunds based on policies</div>
                    <span class="story-status status-complete">‚úÖ Complete</span>
                </div>
                <div class="story-content">
                    <div class="test-section">
                        <h4>Test Workflow</h4>
                        <div class="button-group">
                            <button class="btn btn-primary" id="btn-policies">1. View Policies</button>
                            <button class="btn btn-primary" id="btn-cancel-ticket">2. Cancel Ticket</button>
                            <button class="btn btn-primary" id="btn-my-refunds">3. View Refunds</button>
                        </div>
                        <div class="links">
                            <button class="btn btn-secondary" id="btn-runbook-us007" data-story="US-007">üìã Runbook</button>
                        </div>
                    </div>
                    <div class="response-area" id="us007-response"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>üöÄ <strong>Synque Express Ticketing System</strong> - Complete integration proof with runbooks, examples, and E2E tests</p>
            <p>View <a href="/docs" target="_blank">API Documentation</a> | <a href="https://github.com/your-repo" target="_blank">GitHub Repository</a></p>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin;

        // Utility functions
        function showResponse(elementId, content, type = 'success') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response-area ${type}`;
            element.textContent = content;
        }

        function showLoading(elementId) {
            showResponse(elementId, 'Loading...', 'loading');
        }

        async function apiCall(url, options = {}) {
            console.log('Making API call to:', url, 'with options:', options);
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                console.log('Response status:', response.status, 'OK:', response.ok);

                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    console.log('Non-JSON response:', text);
                    data = { message: text };
                }

                return {
                    status: response.status,
                    ok: response.ok,
                    data
                };
            } catch (error) {
                console.error('API call failed:', error);
                return {
                    status: 0,
                    ok: false,
                    error: error.message
                };
            }
        }

        // Token management
        async function generateUserToken() {
            try {
                // Generate a real JWT token using the server's auth endpoint
                // For demo, we'll call a simple token generation endpoint
                showLoading('us003-response');

                // Call our token generation service
                const result = await apiCall(`${BASE_URL}/api/v1/auth/demo-token`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: 123,
                        email: 'john.doe@example.com'
                    })
                });

                if (result.ok && result.data.token) {
                    document.getElementById('user-token').value = result.data.token;
                    showResponse('us003-response', 'Test token generated! You can now test authenticated endpoints.', 'success');
                } else {
                    // Fallback: generate client-side (not secure, just for demo)
                    const demoToken = generateDemoJWT();
                    document.getElementById('user-token').value = demoToken;
                    showResponse('us003-response', 'Demo token generated (client-side fallback). You can now test authenticated endpoints.', 'success');
                }
            } catch (error) {
                // Fallback: generate client-side
                const demoToken = generateDemoJWT();
                document.getElementById('user-token').value = demoToken;
                showResponse('us003-response', 'Demo token generated (fallback). You can now test authenticated endpoints.', 'success');
            }
        }

        function generateDemoJWT() {
            // Simple base64 encoding for demo purposes (not a real JWT)
            const header = btoa(JSON.stringify({alg: "HS256", typ: "JWT"}));
            const payload = btoa(JSON.stringify({id: 123, email: "john.doe@example.com", exp: Math.floor(Date.now() / 1000) + 3600}));
            return `${header}.${payload}.demo-signature`;
        }

        function copyUserToken() {
            const userToken = document.getElementById('user-token').value;
            document.getElementById('profile-token').value = userToken;
            showResponse('us009-response', 'Token copied from user section.', 'success');
        }

        function getAuthHeaders(tokenInputId) {
            const token = document.getElementById(tokenInputId).value;
            if (!token) {
                throw new Error('Please enter or generate an auth token first');
            }
            return {
                'Authorization': `Bearer ${token}`
            };
        }

        // US-001: Catalog and Orders
        async function testCatalog() {
            showLoading('us001-response');
            const result = await apiCall(`${BASE_URL}/catalog`);

            if (result.ok) {
                const formatted = `‚úÖ Catalog Retrieved Successfully\n\nProducts Found: ${result.data.products.length}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us001-response', formatted, 'success');
            } else {
                showResponse('us001-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        async function testOrderCreate() {
            showLoading('us001-response');
            const orderData = {
                user_id: 123,
                items: [{ product_id: 101, qty: 2 }],
                channel_id: 1,
                out_trade_no: `demo-${Date.now()}`
            };

            const result = await apiCall(`${BASE_URL}/orders`, {
                method: 'POST',
                body: JSON.stringify(orderData)
            });

            if (result.ok) {
                const formatted = `‚úÖ Order Created Successfully\n\nOrder ID: ${result.data.order_id}\nStatus: ${result.data.status}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us001-response', formatted, 'success');
            } else {
                showResponse('us001-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        async function testPaymentWebhook() {
            showLoading('us001-response');
            try {
                // Create a demo order first (since webhook needs order_id)
                const orderData = {
                    user_id: 123,
                    items: [{ product_id: 101, qty: 1 }],
                    channel_id: 1,
                    out_trade_no: `demo-${Date.now()}`
                };

                const order = await apiCall(`${BASE_URL}/orders`, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                if (!order.ok) {
                    showResponse('us001-response', `‚ùå Order creation failed: ${order.data && (order.data.message || order.data.error)}`, 'error');
                    return;
                }

                const notifyBody = {
                    order_id: order.data.order_id,
                    payment_status: 'SUCCESS',
                    paid_at: new Date().toISOString(),
                    signature: 'demo'
                };

                const result = await apiCall(`${BASE_URL}/payments/notify`, {
                    method: 'POST',
                    body: JSON.stringify(notifyBody)
                });

                if (result.ok) {
                    const formatted = `‚úÖ Payment Processed Successfully\n\nOrder: ${order.data.order_id}\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us001-response', formatted, 'success');
                } else {
                    showResponse('us001-response', `‚ùå Webhook error: ${result.data.message || result.error}`, 'error');
                }
            } catch (e) {
                showResponse('us001-response', `‚ùå Error: ${e.message}`, 'error');
            }
        }

        async function runUS001Workflow() {
            showLoading('us001-response');
            let output = 'üöÄ Running Complete US-001 Workflow...\n\n';

            try {
                // Step 1: Get catalog
                output += '1Ô∏è‚É£ Getting catalog...\n';
                const catalog = await apiCall(`${BASE_URL}/catalog`);
                if (catalog.ok) {
                    output += `‚úÖ Found ${catalog.data.products.length} products\n\n`;
                } else {
                    throw new Error('Catalog fetch failed');
                }

                // Step 2: Create order
                output += '2Ô∏è‚É£ Creating order...\n';
                const orderData = {
                    user_id: 123,
                    items: [{ product_id: 101, qty: 1 }],
                    channel_id: 1,
                    out_trade_no: `workflow-${Date.now()}`
                };

                const order = await apiCall(`${BASE_URL}/orders`, {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                if (order.ok) {
                    output += `‚úÖ Order ${order.data.order_id} created\n\n`;
                } else {
                    throw new Error('Order creation failed');
                }

                // Step 3: Process payment
                output += '3Ô∏è‚É£ Processing payment...\n';
                const payment = await apiCall(`${BASE_URL}/payments/notify`, {
                    method: 'POST',
                    body: JSON.stringify({
                        order_id: order.data.order_id,
                        payment_status: 'SUCCESS',
                        paid_at: new Date().toISOString(),
                        signature: 'demo'
                    })
                });

                if (payment.ok) {
                    output += `‚úÖ Payment processed, tickets issued\n\n`;
                } else {
                    throw new Error('Payment processing failed');
                }

                output += 'üéâ Complete workflow successful!\nTickets are now available for the user.';
                showResponse('us001-response', output, 'success');

            } catch (error) {
                output += `‚ùå Workflow failed: ${error.message}`;
                showResponse('us001-response', output, 'error');
            }
        }

        // US-003: User Tickets
        async function testMyTickets() {
            showLoading('us003-response');
            try {
                const headers = getAuthHeaders('user-token');
                const result = await apiCall(`${BASE_URL}/my/tickets`, { headers });

                if (result.ok) {
                    const formatted = `‚úÖ User Tickets Retrieved\n\nTickets Found: ${result.data.tickets.length}\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us003-response', formatted, 'success');

                    // Populate selectors for ticket and function_code
                    const selTicket = document.getElementById('user-ticket-select');
                    const selFn = document.getElementById('user-ticket-fn-select');
                    const hint = document.getElementById('user-ticket-hint');
                    if (selTicket && selFn && hint) {
                        // Reset options
                        selTicket.innerHTML = '';
                        selFn.innerHTML = '';

                        const tickets = result.data.tickets || [];
                        tickets.forEach(t => {
                            const opt = document.createElement('option');
                            const remain = (t.entitlements||[]).reduce((s,e)=>s+Number(e.remaining_uses||0),0);
                            opt.value = t.ticket_code;
                            opt.textContent = `${t.ticket_code} ‚Ä¢ ${t.product_name || ''} ‚Ä¢ remaining=${remain}`.trim();
                            selTicket.appendChild(opt);
                        });

                        // Attach change handler to populate functions
                        selTicket.onchange = () => {
                            const code = selTicket.value;
                            const t = tickets.find(x => x.ticket_code === code) || tickets[0];
                            selFn.innerHTML = '';
                            (t?.entitlements||[]).forEach(e => {
                                const opt = document.createElement('option');
                                opt.value = e.function_code;
                                opt.textContent = `${e.function_code} (${e.remaining_uses})`;
                                opt.disabled = Number(e.remaining_uses||0) <= 0;
                                selFn.appendChild(opt);
                            });
                            // Select first available (>0) by default
                            const firstUsable = Array.from(selFn.options).find(o => !o.disabled);
                            if (firstUsable) selFn.value = firstUsable.value;
                        };

                        // Trigger once to init functions list
                        if (tickets.length > 0) {
                            selTicket.value = tickets[0].ticket_code;
                            selTicket.onchange();
                        }

                        // Show selectors
                        selTicket.style.display = 'block';
                        selFn.style.display = 'block';
                        hint.style.display = 'inline-block';
                    }
                } else {
                    showResponse('us003-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us003-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testQRToken() {
            showLoading('us003-response');
            try {
                const headers = getAuthHeaders('user-token');
                // Prefer selection if available, otherwise fetch and pick
                const selTicket = document.getElementById('user-ticket-select');
                const selFn = document.getElementById('user-ticket-fn-select');
                let ticketCode = selTicket && selTicket.value;
                let fnPref = selFn && selFn.value;

                let ticketsData = null;
                if (!ticketCode) {
                    const ticketsRes = await apiCall(`${BASE_URL}/my/tickets`, { headers });
                    if (!ticketsRes.ok || !ticketsRes.data.tickets || ticketsRes.data.tickets.length === 0) {
                        showResponse('us003-response', `‚ùå No tickets available for this user`, 'error');
                        return;
                    }
                    ticketsData = ticketsRes.data.tickets;
                    const pickTicket = ticketsData.find(t => (t.entitlements || []).some(e => e.remaining_uses > 0)) || ticketsData[0];
                    ticketCode = pickTicket.ticket_code;
                    fnPref = ((pickTicket.entitlements||[]).find(e => e.remaining_uses > 0) || (pickTicket.entitlements||[])[0])?.function_code;
                }

                const result = await apiCall(`${BASE_URL}/tickets/${ticketCode}/qr-token`, { method: 'POST', headers });
                if (!result.ok) {
                    showResponse('us003-response', `‚ùå No tickets available for this user`, 'error');
                }

                // Autopopulate US-002 scan fields
                const token = result.data.token;
                // If we didn't have selection, we might need entitlements to hint function code
                let fnCode = fnPref || '';
                if (!fnCode) {
                    const tickets = ticketsData || (await apiCall(`${BASE_URL}/my/tickets`, { headers })).data.tickets;
                    const t = tickets.find(x => x.ticket_code === ticketCode) || tickets[0];
                    const ent = (t?.entitlements || []).find(e => e.remaining_uses > 0) || (t?.entitlements || [])[0];
                    fnCode = ent ? ent.function_code : '';
                }

                const scanTokenEl = document.getElementById('scan-qr-token');
                const fnInputEl = document.getElementById('scan-function-code');
                if (scanTokenEl) scanTokenEl.value = token;
                if (fnInputEl && fnCode) fnInputEl.value = fnCode;

                const formatted = `‚úÖ QR Token Generated\n\nTicket: ${ticketCode}\nSuggested function_code: ${fnCode || '-'}\nToken: ${token}\nExpires in: ${result.data.expires_in} seconds\n`;
                showResponse('us003-response', formatted, 'success');
            } catch (error) {
                showResponse('us003-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // US-009: User Profile
        async function testGetProfile() {
            showLoading('us009-response');
            try {
                const headers = getAuthHeaders('profile-token');
                const result = await apiCall(`${BASE_URL}/profile`, { headers });

                if (result.ok) {
                    const formatted = `‚úÖ Profile Retrieved\n\nUser: ${result.data.name}\nEmail: ${result.data.email}\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us009-response', formatted, 'success');
                } else {
                    showResponse('us009-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us009-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testUpdateProfile() {
            showLoading('us009-response');
            try {
                const headers = getAuthHeaders('profile-token');
                const updates = {
                    name: 'Demo User Updated',
                    preferences: {
                        language: 'en',
                        timezone: 'America/New_York'
                    }
                };

                const result = await apiCall(`${BASE_URL}/profile`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(updates)
                });

                if (result.ok) {
                    const formatted = `‚úÖ Profile Updated\n\nUpdated: ${JSON.stringify(updates, null, 2)}\n\nResult:\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us009-response', formatted, 'success');
                } else {
                    showResponse('us009-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us009-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testGetSettings() {
            showLoading('us009-response');
            try {
                const headers = getAuthHeaders('profile-token');
                const result = await apiCall(`${BASE_URL}/profile/settings`, { headers });

                if (result.ok) {
                    const formatted = `‚úÖ Settings Retrieved\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us009-response', formatted, 'success');
                } else {
                    showResponse('us009-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us009-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testUpdateSettings() {
            showLoading('us009-response');
            try {
                const headers = getAuthHeaders('profile-token');
                const settings = {
                    notification_settings: {
                        email_notifications: false,
                        promotional_emails: true
                    },
                    display_preferences: {
                        currency_display: 'EUR'
                    }
                };

                const result = await apiCall(`${BASE_URL}/profile/settings`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(settings)
                });

                if (result.ok) {
                    const formatted = `‚úÖ Settings Updated\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us009-response', formatted, 'success');
                } else {
                    showResponse('us009-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us009-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testGetActivity() {
            showLoading('us009-response');
            try {
                const headers = getAuthHeaders('profile-token');
                const result = await apiCall(`${BASE_URL}/profile/activity?limit=5`, { headers });

                if (result.ok) {
                    const formatted = `‚úÖ Activity History Retrieved\n\nTotal: ${result.data.total}\nShowing: ${result.data.activities.length}\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us009-response', formatted, 'success');
                } else {
                    showResponse('us009-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
                }
            } catch (error) {
                showResponse('us009-response', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function runUS009Workflow() {
            showLoading('us009-response');
            let output = 'üöÄ Running Complete US-009 Profile Workflow...\n\n';

            try {
                const headers = getAuthHeaders('profile-token');

                // Step 1: Get profile
                output += '1Ô∏è‚É£ Getting profile...\n';
                const profile = await apiCall(`${BASE_URL}/profile`, { headers });
                if (profile.ok) {
                    output += `‚úÖ Profile loaded for ${profile.data.name}\n\n`;
                } else {
                    throw new Error('Profile fetch failed');
                }

                // Step 2: Update profile
                output += '2Ô∏è‚É£ Updating profile...\n';
                const updates = { name: 'Workflow Test User' };
                const updateResult = await apiCall(`${BASE_URL}/profile`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(updates)
                });

                if (updateResult.ok) {
                    output += `‚úÖ Profile updated to "${updateResult.data.name}"\n\n`;
                } else {
                    throw new Error('Profile update failed');
                }

                // Step 3: Get settings
                output += '3Ô∏è‚É£ Getting settings...\n';
                const settings = await apiCall(`${BASE_URL}/profile/settings`, { headers });
                if (settings.ok) {
                    output += `‚úÖ Settings loaded\n\n`;
                } else {
                    throw new Error('Settings fetch failed');
                }

                // Step 4: Get activity
                output += '4Ô∏è‚É£ Getting activity history...\n';
                const activity = await apiCall(`${BASE_URL}/profile/activity?limit=3`, { headers });
                if (activity.ok) {
                    output += `‚úÖ Activity history loaded (${activity.data.total} total activities)\n\n`;
                } else {
                    throw new Error('Activity fetch failed');
                }

                output += 'üéâ Complete profile workflow successful!\nAll profile features are working correctly.';
                showResponse('us009-response', output, 'success');

            } catch (error) {
                output += `‚ùå Workflow failed: ${error.message}`;
                showResponse('us009-response', output, 'error');
            }
        }

        // US-008: Promotion Details
        async function testPromotionDetail(productId) {
            showLoading('us008-response');
            const result = await apiCall(`${BASE_URL}/catalog/promotions/${productId}`);

            if (result.ok) {
                const promo = result.data.promotion;
                const formatted = `‚úÖ Promotion Detail Retrieved\n\nProduct: ${promo.name}\nPrice: $${promo.unit_price}\nStatus: ${promo.status}\nAvailable: ${promo.inventory.available}\n\nFeatures:\n${promo.features.map(f => `‚Ä¢ ${f}`).join('\n')}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us008-response', formatted, 'success');
            } else {
                showResponse('us008-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        async function testEnhancedFeatures() {
            showLoading('us008-response');
            let output = 'üéØ Testing Enhanced Promotion Features...\n\n';

            try {
                // Test Transport Pass with enhanced features
                output += '1Ô∏è‚É£ Testing Transport Pass (with badges & sale dates)...\n';
                const transport = await apiCall(`${BASE_URL}/catalog/promotions/101`);

                if (transport.ok) {
                    const promo = transport.data.promotion;
                    output += `‚úÖ ${promo.name} - $${promo.unit_price}\n`;
                    output += `üè∑Ô∏è Badges: ${promo.badges.join(', ')}\n`;
                    output += `‚è∞ Sale Period: ${promo.sale_start_at} to ${promo.sale_end_at}\n`;
                    output += `üñºÔ∏è Images: ${promo.images.length} professional images\n`;
                    output += `üí∞ Value Props: ${promo.features.filter(f => f.includes('Save')).join(', ')}\n\n`;
                } else {
                    throw new Error('Transport Pass test failed');
                }

                // Test Theme Park with winter special
                output += '2Ô∏è‚É£ Testing Theme Park Pass (winter special)...\n';
                const park = await apiCall(`${BASE_URL}/catalog/promotions/104`);

                if (park.ok) {
                    const promo = park.data.promotion;
                    output += `‚úÖ ${promo.name} - $${promo.unit_price}\n`;
                    output += `‚ùÑÔ∏è Winter Special: ${promo.badges.includes('‚ùÑÔ∏è Winter Special') ? 'YES' : 'NO'}\n`;
                    output += `‚ö° Fast Pass: ${promo.badges.includes('‚ö° Fast Pass Included') ? 'YES' : 'NO'}\n`;
                    output += `üìÖ Valid Until: ${promo.sale_end_at}\n\n`;
                } else {
                    throw new Error('Theme Park test failed');
                }

                // Test all promotions have enhanced data
                output += '3Ô∏è‚É£ Validating all promotions have enhanced features...\n';
                const catalog = await apiCall(`${BASE_URL}/catalog`);

                if (catalog.ok) {
                    let enhancedCount = 0;
                    for (const product of catalog.data.products) {
                        const detail = await apiCall(`${BASE_URL}/catalog/promotions/${product.id}`);
                        if (detail.ok && detail.data.promotion.badges && detail.data.promotion.images) {
                            enhancedCount++;
                        }
                    }
                    output += `‚úÖ ${enhancedCount}/${catalog.data.products.length} products have enhanced features\n\n`;
                } else {
                    throw new Error('Catalog validation failed');
                }

                output += 'üéâ All enhanced features working perfectly!\n\n';
                output += 'üìã Enhanced Features Confirmed:\n';
                output += '‚Ä¢ üè∑Ô∏è Dynamic badges for marketing\n';
                output += '‚Ä¢ üñºÔ∏è Real Unsplash images\n';
                output += '‚Ä¢ ‚è∞ Time-limited sale periods\n';
                output += '‚Ä¢ üí∞ Enhanced value propositions\n';
                output += '‚Ä¢ üìä Real-time inventory displays\n';
                output += '‚Ä¢ üé® Professional marketing content\n\n';
                output += 'üöÄ Ready for frontend integration!';

                showResponse('us008-response', output, 'success');

            } catch (error) {
                output += `‚ùå Enhanced features test failed: ${error.message}`;
                showResponse('us008-response', output, 'error');
            }
        }

        // US-007: Cancellation
        async function testCancellationPolicies() {
            showLoading('us007-response');
            const result = await apiCall(`${BASE_URL}/cancellation-policies`);

            if (result.ok) {
                const formatted = `‚úÖ Cancellation Policies Retrieved\n\nPolicies: ${result.data.policies.length}\nExamples: ${result.data.examples.length}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us007-response', formatted, 'success');
            } else {
                showResponse('us007-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        async function testTicketCancellation() {
            showLoading('us007-response');
            // Demo with a test ticket code
            const ticketCode = 'TEST-001';
            const result = await apiCall(`${BASE_URL}/tickets/${ticketCode}/cancel`, {
                method: 'POST',
                body: JSON.stringify({ reason: 'Demo cancellation test' })
            });

            if (result.ok) {
                const formatted = `‚úÖ Ticket Cancellation Processed\n\nTicket: ${ticketCode}\nRefund Amount: $${result.data.refund_amount}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us007-response', formatted, 'success');
            } else {
                showResponse('us007-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        async function testMyRefunds() {
            showLoading('us007-response');
            const result = await apiCall(`${BASE_URL}/my/refunds`);

            if (result.ok) {
                const formatted = `‚úÖ User Refunds Retrieved\n\nRefunds: ${result.data.refunds.length}\n\n${JSON.stringify(result.data, null, 2)}`;
                showResponse('us007-response', formatted, 'success');
            } else {
                showResponse('us007-response', `‚ùå Error: ${result.data.message || result.error}`, 'error');
            }
        }

        // US-002: Implemented actions
        async function testOperatorLogin() {
            showLoading('us002-response');
            const username = (document.getElementById('operator-username') || {}).value || 'alice';
            const password = (document.getElementById('operator-password') || {}).value || 'secret123';
            try {
                const result = await apiCall(`${BASE_URL}/operators/login`, {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                if (result.ok && result.data.operator_token) {
                    const token = result.data.operator_token;
                    const tokenEl = document.getElementById('operator-token');
                    if (tokenEl) tokenEl.value = token;
                    showResponse('us002-response', `‚úÖ Operator login success\nUser: ${username}`, 'success');
                } else {
                    showResponse('us002-response', `‚ùå Login failed: ${result.data && (result.data.message || result.data.error)}`, 'error');
                }
            } catch (e) {
                showResponse('us002-response', `‚ùå Login error: ${e.message}`, 'error');
            }
        }

        async function testValidatorSession() {
            showLoading('us002-response');
            const deviceId = (document.getElementById('validator-device-id') || {}).value || 'gate-01';
            const locationId = (document.getElementById('validator-location-id') || {}).value;
            const operatorToken = (document.getElementById('operator-token') || {}).value;
            if (!operatorToken) {
                showResponse('us002-response', '‚ùå Please login operator first', 'error');
                return;
            }
            try {
                const headers = { 'Authorization': `Bearer ${operatorToken}` };
                const body = { device_id: deviceId };
                if (locationId) body.location_id = Number(locationId);
                const result = await apiCall(`${BASE_URL}/validators/sessions`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });
                if (result.ok && result.data.session_id) {
                    const sessEl = document.getElementById('validator-session-id');
                    if (sessEl) sessEl.value = result.data.session_id;
                    showResponse('us002-response', `‚úÖ Session created\nSession: ${result.data.session_id}\nExpires in: ${result.data.expires_in}s`, 'success');
                } else {
                    showResponse('us002-response', `‚ùå Session failed: ${result.data && (result.data.message || result.data.error)}`, 'error');
                }
            } catch (e) {
                showResponse('us002-response', `‚ùå Session error: ${e.message}`, 'error');
            }
        }

        async function testTicketScan() {
            showLoading('us002-response');
            const qrToken = (document.getElementById('scan-qr-token') || {}).value;
            const functionCode = (document.getElementById('scan-function-code') || {}).value;
            const operatorToken = (document.getElementById('operator-token') || {}).value;
            const venueCode = (document.getElementById('venue-code') || {}).value || 'central-pier';
            if (!qrToken || !functionCode) {
                showResponse('us002-response', '‚ùå Missing required fields: qr_token/function_code', 'error');
                return;
            }
            try {
                const body = { qr_token: qrToken, function_code: functionCode, venue_code: venueCode };
                const headers = operatorToken ? { 'Authorization': `Bearer ${operatorToken}` } : {};
                const result = await apiCall(`${BASE_URL}/venue/scan`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                if (result.ok) {
                    const formatted = `‚úÖ Scan success\nResult: ${result.data.result}\nStatus: ${result.data.ticket_status}\n\n${JSON.stringify(result.data, null, 2)}`;
                    showResponse('us002-response', formatted, 'success');
                } else {
                    const err = result.data && (result.data.message || result.data.error) || 'Unknown';
                    showResponse('us002-response', `‚ùå Scan failed (${result.status}): ${err}`, 'error');
                }
            } catch (e) {
                showResponse('us002-response', `‚ùå Scan error: ${e.message}`, 'error');
            }
        }

        // One-click simulation: Token -> Tickets -> QR -> Operator Login -> Session -> Scan
        async function simulateRedemptionFlow() {
            showLoading('us002-response');
            let log = 'üöÄ Simulating end-to-end redemption...\n\n';
            try {
                // 1) Ensure user token
                let userTokenEl = document.getElementById('user-token');
                let userToken = userTokenEl && userTokenEl.value;
                if (!userToken) {
                    const demo = await apiCall(`${BASE_URL}/api/v1/auth/demo-token`, {
                        method: 'POST',
                        body: JSON.stringify({ user_id: 123, email: 'demo@example.com' })
                    });
                    if (!demo.ok) throw new Error('Failed to generate user token');
                    userToken = demo.data.token;
                    if (userTokenEl) userTokenEl.value = userToken;
                }
                const userHeaders = { 'Authorization': `Bearer ${userToken}` };
                log += '‚úÖ User token ready\n';

                // 2) Fetch tickets; if none, fallback: create order + notify; if still none, try user_id=1
                let ticketsRes = await apiCall(`${BASE_URL}/my/tickets`, { headers: userHeaders });
                if (!ticketsRes.ok || !ticketsRes.data || (ticketsRes.data.tickets||[]).length === 0) {
                    // Fallback path: switch to user_id=1 to match backend order creation default
                    const demo1 = await apiCall(`${BASE_URL}/api/v1/auth/demo-token`, {
                        method: 'POST',
                        body: JSON.stringify({ user_id: 1, email: 'user1@example.com' })
                    });
                    if (demo1.ok) {
                        const token1 = demo1.data.token;
                        if (userTokenEl) userTokenEl.value = token1;
                        userToken = token1;
                    }
                    const headers1 = { 'Authorization': `Bearer ${userToken}` };
                    // Create order
                    const orderData = { user_id: 1, items: [{ product_id: 101, qty: 1 }], channel_id: 1, out_trade_no: `sim-${Date.now()}` };
                    const order = await apiCall(`${BASE_URL}/orders`, { method: 'POST', body: JSON.stringify(orderData) });
                    if (!order.ok) throw new Error(`Order creation failed: ${order.data && (order.data.message || order.data.error)}`);
                    // Notify payment
                    const notifyBody = { order_id: order.data.order_id, payment_status: 'SUCCESS', paid_at: new Date().toISOString(), signature: 'demo' };
                    const notify = await apiCall(`${BASE_URL}/payments/notify`, { method: 'POST', body: JSON.stringify(notifyBody) });
                    if (!notify.ok) throw new Error(`Payment notify failed: ${notify.data && (notify.data.message || notify.data.error)}`);
                    // Refetch tickets
                    ticketsRes = await apiCall(`${BASE_URL}/my/tickets`, { headers: headers1 });
                }
                if (!ticketsRes.ok || !ticketsRes.data || (ticketsRes.data.tickets||[]).length === 0) {
                    throw new Error('No tickets available after payment');
                }
                const tickets = ticketsRes.data.tickets;
                const pickTicket = tickets.find(t => (t.entitlements||[]).some(e => e.remaining_uses > 0)) || tickets[0];
                const fnCode = ((pickTicket.entitlements||[]).find(e => e.remaining_uses > 0) || (pickTicket.entitlements||[])[0]).function_code;
                log += `‚úÖ Using ticket ${pickTicket.ticket_code} with function_code=${fnCode}\n`;

                // 3) Generate QR code
                const qrRes = await apiCall(`${BASE_URL}/qr/${pickTicket.ticket_code}`, { method: 'POST', headers: { 'Authorization': `Bearer ${userToken}` } });
                if (!qrRes.ok) throw new Error(`QR generation failed: ${qrRes.data && (qrRes.data.message || qrRes.data.error)}`);
                const qrToken = qrRes.data.encrypted_data;
                const scanTokenEl = document.getElementById('scan-qr-token');
                const fnInputEl = document.getElementById('scan-function-code');
                if (scanTokenEl) scanTokenEl.value = qrToken;
                if (fnInputEl) fnInputEl.value = fnCode;
                log += '‚úÖ QR code generated\n';

                // 4) Operator login
                const opLogin = await apiCall(`${BASE_URL}/operators/login`, { method: 'POST', body: JSON.stringify({ username: 'alice', password: 'secret123' }) });
                if (!opLogin.ok) throw new Error(`Operator login failed: ${opLogin.data && (opLogin.data.message || opLogin.data.error)}`);
                const opToken = opLogin.data.operator_token;
                const opTokenEl = document.getElementById('operator-token');
                if (opTokenEl) opTokenEl.value = opToken;
                log += '‚úÖ Operator logged in (JWT obtained)\n';

                // 5) Scan & redeem (using /venue/scan - no session needed)
                const scan = await apiCall(`${BASE_URL}/venue/scan`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${opToken}` },
                    body: JSON.stringify({ qr_token: qrToken, function_code: fnCode, venue_code: 'central-pier', terminal_device_id: 'gate-01' })
                });
                if (!scan.ok) {
                    const err = scan.data && (scan.data.message || scan.data.error) || 'Unknown';
                    throw new Error(`Scan failed: ${err}`);
                }
                log += `üéâ Scan success! Status: ${scan.data.ticket_status}\n`;
                log += `${JSON.stringify(scan.data, null, 2)}\n`;
                showResponse('us002-response', log, 'success');
            } catch (e) {
                log += `‚ùå Simulation error: ${e.message}`;
                showResponse('us002-response', log, 'error');
            }
        }

        // One-click reset: reset mock store to initial seed (requires operator login)
        async function resetMockData() {
            showLoading('us002-response');
            const operatorToken = (document.getElementById('operator-token') || {}).value;
            if (!operatorToken) {
                showResponse('us002-response', '‚ùå Please login operator first', 'error');
                return;
            }
            try {
                const result = await apiCall(`${BASE_URL}/dev/reset`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${operatorToken}` }
                });
                if (result.ok) {
                    const stats = result.data.stats || {};
                    // Clear fields for clarity
                    const scanTokenEl = document.getElementById('scan-qr-token');
                    const fnInputEl = document.getElementById('scan-function-code');
                    const sessEl = document.getElementById('validator-session-id');
                    if (scanTokenEl) scanTokenEl.value = '';
                    if (fnInputEl) fnInputEl.value = '';
                    if (sessEl) sessEl.value = '';
                    showResponse('us002-response', `‚úÖ Mock data reset to seed\nTickets: ${stats.tickets || 0}, Products: ${stats.products || 0}`, 'success');
                } else {
                    const err = result.data && (result.data.message || result.data.error) || 'Unknown';
                    showResponse('us002-response', `‚ùå Reset failed (${result.status}): ${err}`, 'error');
                }
            } catch (e) {
                showResponse('us002-response', `‚ùå Reset error: ${e.message}`, 'error');
            }
        }

        // Runbook display
        function showRunbook(storyId) {
            const runbookUrl = `${BASE_URL}/docs/integration/${storyId}-runbook.md`;
            window.open(runbookUrl, '_blank');
        }

        // Auto-generate token on page load for convenience
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing demo...');
            
            try {
                // Generate a fresh token for this session
                generateFreshToken();
                
                console.log('Dashboard loaded with fresh token');
                showResponse('us003-response', 'üé´ Dashboard loaded! Fresh token generated for testing authenticated endpoints.', 'success');

                // Set up event listeners for all buttons to avoid CSP issues
                setupEventListeners();
            } catch (error) {
                console.error('Error initializing demo:', error);
            }
        });

        // Generate fresh token function
        async function generateFreshToken() {
            try {
                const result = await apiCall(`${BASE_URL}/api/v1/auth/demo-token`, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: 123,
                        email: 'demo@example.com'
                    })
                });

                if (result.ok && result.data.token) {
                    const token = result.data.token;
                    
                    const userTokenEl = document.getElementById('user-token');
                    const profileTokenEl = document.getElementById('profile-token');
                    
                    if (userTokenEl) userTokenEl.value = token;
                    if (profileTokenEl) profileTokenEl.value = token;
                    
                    console.log('Fresh token generated and set');
                } else {
                    throw new Error('Failed to generate token');
                }
            } catch (error) {
                console.error('Error generating fresh token:', error);
                // Fallback to a working token
                const fallbackToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzLCJlbWFpbCI6ImRlbW9AZXhhbXBsZS5jb20iLCJpYXQiOjE3NjEwMzY5NTEsImV4cCI6MTc2MTY0MTc1MX0.sI2cnGdV7e1v5v6Dx2MKPuHfOPsmjByXI9vrVZBhSPo';
                
                const userTokenEl = document.getElementById('user-token');
                const profileTokenEl = document.getElementById('profile-token');
                
                if (userTokenEl) userTokenEl.value = fallbackToken;
                if (profileTokenEl) profileTokenEl.value = fallbackToken;
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Set up all button click events to bypass CSP restrictions
            const buttonMap = {
                'btn-catalog': testCatalog,
                'btn-order-create': testOrderCreate,
                'btn-payment-webhook': testPaymentWebhook,
                'btn-us001-workflow': runUS001Workflow,
                'btn-my-tickets': testMyTickets,
                'btn-qr-token': testQRToken,
                'btn-get-profile': testGetProfile,
                'btn-update-profile': testUpdateProfile,
                'btn-get-settings': testGetSettings,
                'btn-update-settings': testUpdateSettings,
                'btn-get-activity': testGetActivity,
                'btn-us009-workflow': runUS009Workflow,
                'btn-promo-101': () => testPromotionDetail(101),
                'btn-promo-102': () => testPromotionDetail(102),
                'btn-promo-103': () => testPromotionDetail(103),
                'btn-promo-104': () => testPromotionDetail(104),
                'btn-test-enhanced-features': testEnhancedFeatures,
                'btn-policies': testCancellationPolicies,
                'btn-cancel-ticket': testTicketCancellation,
                'btn-my-refunds': testMyRefunds,
                'btn-generate-token': generateUserToken,
                'btn-copy-token': copyUserToken,
                // selectors are handled dynamically after tickets loaded
                // US-002 implemented buttons
                'btn-operator-login': testOperatorLogin,
                'btn-validator-session': testValidatorSession,
                'btn-ticket-scan': testTicketScan,
                'btn-runbook-us002': () => showRunbook('US-002'),
                'btn-simulate-redemption': simulateRedemptionFlow,
                'btn-reset-mock': resetMockData
            };

            // Add event listeners
            let listenersAdded = 0;
            Object.entries(buttonMap).forEach(([id, handler]) => {
                const element = document.getElementById(id);
                if (element) {
                    try {
                        element.addEventListener('click', handler);
                        listenersAdded++;
                        console.log(`Added listener for ${id}`);
                    } catch (error) {
                        console.error(`Error adding listener for ${id}:`, error);
                    }
                } else {
                    console.warn(`Element ${id} not found`);
                }
            });

            // Set up runbook buttons with data attributes
            const runbookButtons = document.querySelectorAll('[id^="btn-runbook-"]');
            runbookButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const story = this.getAttribute('data-story');
                    showRunbook(story);
                });
            });

            console.log(`Event listeners setup complete. Added ${listenersAdded} listeners.`);
        }
    </script>
</body>
</html>
