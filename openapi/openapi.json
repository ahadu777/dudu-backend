{
  "openapi": "3.0.3",
  "info": {
    "title": "Synque Express Ticketing API",
    "version": "0.1.0",
    "description": "Complete ticketing and event management API with user profile management, promotions, and cancellation support"
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Development server"
    },
    {
      "url": "https://api.ticketing.com",
      "description": "Production server"
    }
  ],
  "paths": {
    "/healthz": {
      "get": {
        "tags": [
          "Infrastructure"
        ],
        "summary": "Health check endpoint",
        "description": "Liveness probe for service health monitoring",
        "responses": {
          "200": {
            "description": "Service is healthy",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": {
                      "type": "string",
                      "example": "ok"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/version": {
      "get": {
        "tags": [
          "Infrastructure"
        ],
        "summary": "Service version information",
        "description": "Returns service name and version",
        "responses": {
          "200": {
            "description": "Version information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string",
                      "example": "ticketing-api"
                    },
                    "version": {
                      "type": "string",
                      "example": "0.1.0"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/packages/templates": {
      "post": {
        "tags": [
          "Admin"
        ],
        "summary": "Create or update package template with entitlements",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PackageTemplateUpsert"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Template updated (idempotent)"
          },
          "201": {
            "description": "Template created"
          },
          "409": {
            "description": "Template version conflict"
          }
        }
      }
    },
    "/admin/packages/templates/{templateId}/versions": {
      "get": {
        "tags": [
          "Admin"
        ],
        "summary": "List template version history",
        "parameters": [
          {
            "in": "path",
            "name": "templateId",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Version history returned"
          },
          "404": {
            "description": "Template not found"
          }
        }
      }
    },
    "/admin/routes/fares/{routeCode}": {
      "put": {
        "tags": [
          "Admin"
        ],
        "summary": "Upsert route fare table per passenger type",
        "parameters": [
          {
            "in": "path",
            "name": "routeCode",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RouteFareUpsert"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Updated (idempotent supported)"
          }
        }
      }
    },
    "/admin/routes/fares/{routeCode}/history": {
      "get": {
        "tags": [
          "Admin"
        ],
        "summary": "Retrieve route fare revision history",
        "parameters": [
          {
            "in": "path",
            "name": "routeCode",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "History returned"
          },
          "404": {
            "description": "Route not found"
          }
        }
      }
    },
    "/admin/routes/fares/{routeCode}/restore": {
      "post": {
        "tags": [
          "Admin"
        ],
        "summary": "Restore previous route fare revision",
        "parameters": [
          {
            "in": "path",
            "name": "routeCode",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Previous revision restored"
          },
          "404": {
            "description": "Route not found"
          },
          "409": {
            "description": "No previous revision available"
          }
        }
      }
    },
    "/cancellation-policies": {
      "get": {
        "tags": [
          "Policies"
        ],
        "summary": "Get cancellation policies and refund rules",
        "description": "Returns business rules for ticket cancellation and refund calculation",
        "responses": {
          "200": {
            "description": "Cancellation policies",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "policies": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "rule_type": {
                            "type": "string",
                            "enum": [
                              "redemption_based",
                              "time_based",
                              "product_based"
                            ]
                          },
                          "description": {
                            "type": "string"
                          },
                          "refund_percentage": {
                            "type": "number",
                            "format": "decimal",
                            "minimum": 0,
                            "maximum": 1
                          },
                          "conditions": {
                            "type": "object"
                          }
                        }
                      }
                    },
                    "examples": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "scenario": {
                            "type": "string"
                          },
                          "ticket_status": {
                            "type": "string"
                          },
                          "redemptions_used": {
                            "type": "integer"
                          },
                          "total_redemptions": {
                            "type": "integer"
                          },
                          "refund_percentage": {
                            "type": "number"
                          },
                          "explanation": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/pricing/calculate": {
      "post": {
        "tags": [
          "PricingEngine"
        ],
        "summary": "Calculate total price for complex booking",
        "description": "Calculates pricing based on multiple variables - dates, customer types, package tiers, add-ons",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "product_id",
                  "booking_dates",
                  "customer_breakdown"
                ],
                "properties": {
                  "product_id": {
                    "type": "integer",
                    "description": "Product to price"
                  },
                  "booking_dates": {
                    "type": "array",
                    "items": {
                      "type": "string",
                      "format": "date"
                    },
                    "description": "Dates for usage/booking"
                  },
                  "customer_breakdown": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "customer_type": {
                          "type": "string",
                          "enum": [
                            "adult",
                            "child",
                            "elderly"
                          ]
                        },
                        "count": {
                          "type": "integer",
                          "minimum": 1
                        }
                      }
                    }
                  },
                  "addons": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "addon_id": {
                          "type": "string"
                        },
                        "quantity": {
                          "type": "integer"
                        }
                      }
                    }
                  },
                  "package_tier": {
                    "type": "string",
                    "enum": [
                      "premium",
                      "pet",
                      "deluxe_tea_set"
                    ],
                    "description": "Optional package tier override"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Pricing calculation successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "base_price": {
                      "type": "number",
                      "format": "decimal"
                    },
                    "adjustments": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "rule_type": {
                            "type": "string"
                          },
                          "description": {
                            "type": "string"
                          },
                          "amount": {
                            "type": "number"
                          }
                        }
                      }
                    },
                    "addons_total": {
                      "type": "number",
                      "format": "decimal"
                    },
                    "final_total": {
                      "type": "number",
                      "format": "decimal"
                    },
                    "breakdown": {
                      "type": "object",
                      "properties": {
                        "per_customer_costs": {
                          "type": "array"
                        },
                        "addon_details": {
                          "type": "array"
                        },
                        "tax_info": {
                          "type": "object"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid request parameters"
          },
          "404": {
            "description": "Product not found or pricing not available"
          },
          "422": {
            "description": "Invalid date range or customer breakdown"
          }
        }
      }
    },
    "/pricing/rules/{product_id}": {
      "get": {
        "tags": [
          "PricingEngine"
        ],
        "summary": "Get pricing rules for product",
        "description": "Returns all pricing rules, tiers, and add-on options for a product",
        "parameters": [
          {
            "name": "product_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Pricing rules retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "base_prices": {
                      "type": "object"
                    },
                    "time_rules": {
                      "type": "array"
                    },
                    "customer_rules": {
                      "type": "array"
                    },
                    "special_dates": {
                      "type": "array"
                    },
                    "package_tiers": {
                      "type": "array"
                    },
                    "available_addons": {
                      "type": "array"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/tickets/validate": {
      "post": {
        "tags": [
          "Customer Reservation"
        ],
        "summary": "Validate ticket code before reservation",
        "description": "Check if ticket exists, is activated, and has no existing reservation.\nFirst step in customer reservation flow.\n",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ticket_code"
                ],
                "properties": {
                  "ticket_code": {
                    "type": "string",
                    "example": "TKT-2025-ABC123-DEF456",
                    "description": "Unique ticket identifier"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Ticket is valid and can be reserved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "ticket_id": {
                          "type": "integer",
                          "example": 123
                        },
                        "ticket_code": {
                          "type": "string",
                          "example": "TKT-2025-ABC123-DEF456"
                        },
                        "status": {
                          "type": "string",
                          "enum": [
                            "ACTIVATED"
                          ],
                          "example": "ACTIVATED"
                        },
                        "product_id": {
                          "type": "integer",
                          "example": 5
                        },
                        "order_id": {
                          "type": "integer",
                          "example": 456
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid ticket or validation error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string",
                          "enum": [
                            "TICKET_NOT_FOUND",
                            "TICKET_ALREADY_RESERVED",
                            "TICKET_NOT_ACTIVATED",
                            "TICKET_EXPIRED"
                          ],
                          "example": "TICKET_ALREADY_RESERVED"
                        },
                        "message": {
                          "type": "string",
                          "example": "This ticket is already reserved for 2025-11-20"
                        },
                        "reserved_date": {
                          "type": "string",
                          "format": "date",
                          "nullable": true,
                          "example": "2025-11-20"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/reservation-slots/available": {
      "get": {
        "tags": [
          "Reservation Management"
        ],
        "summary": "Get available reservation slots for calendar display",
        "description": "Returns slots for specified month with real-time capacity data.\nUsed by customer reservation UI to display calendar and time slots.\n",
        "parameters": [
          {
            "name": "month",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "YYYY-MM",
              "example": "2025-11",
              "description": "Month to query (default: current month)"
            }
          },
          {
            "name": "orq",
            "in": "query",
            "required": true,
            "schema": {
              "type": "integer",
              "example": 1,
              "description": "Organization ID"
            }
          },
          {
            "name": "date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date",
              "example": "2025-11-14",
              "description": "Specific date filter (returns only slots for that date)"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Available slots retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ReservationSlot"
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "month": {
                          "type": "string",
                          "example": "2025-11"
                        },
                        "total_slots": {
                          "type": "integer",
                          "example": 120
                        },
                        "unique_dates": {
                          "type": "integer",
                          "example": 30
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid month format"
          },
          "401": {
            "description": "Unauthorized"
          }
        }
      }
    },
    "/api/reservations/create": {
      "post": {
        "tags": [
          "Customer Reservation"
        ],
        "summary": "Create reservation for ticket",
        "description": "Reserve ticket for specific date/time slot.\nTransaction-safe with capacity enforcement via row-level locking.\n",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ticket_id",
                  "slot_id",
                  "customer_email",
                  "customer_phone"
                ],
                "properties": {
                  "ticket_id": {
                    "type": "integer",
                    "example": 123
                  },
                  "slot_id": {
                    "type": "integer",
                    "example": 10,
                    "description": "ID from reservation_slots table"
                  },
                  "customer_email": {
                    "type": "string",
                    "format": "email",
                    "example": "john@example.com"
                  },
                  "customer_phone": {
                    "type": "string",
                    "format": "E.164",
                    "example": "+12025551234"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reservation created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "reservation_id": {
                          "type": "integer",
                          "example": 789
                        },
                        "ticket_code": {
                          "type": "string",
                          "example": "TKT-2025-ABC123-DEF456"
                        },
                        "slot": {
                          "type": "object",
                          "properties": {
                            "date": {
                              "type": "string",
                              "format": "date",
                              "example": "2025-11-14"
                            },
                            "start_time": {
                              "type": "string",
                              "format": "time",
                              "example": "12:00:00"
                            },
                            "end_time": {
                              "type": "string",
                              "format": "time",
                              "example": "14:00:00"
                            }
                          }
                        },
                        "confirmation_sent": {
                          "type": "boolean",
                          "example": true,
                          "description": "Email confirmation sent"
                        },
                        "qr_code": {
                          "type": "string",
                          "example": "data:image/png;base64,QR_CODE_FOR_TKT-2025-ABC123-DEF456",
                          "description": "Base64-encoded QR code image (mock data in MVP)"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Validation error (missing fields, ticket not activated)"
          },
          "409": {
            "description": "Conflict - slot full or ticket already reserved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string",
                          "enum": [
                            "SLOT_FULL",
                            "TICKET_ALREADY_RESERVED"
                          ],
                          "example": "SLOT_FULL"
                        },
                        "message": {
                          "type": "string",
                          "example": "This time slot is full. Please select another time."
                        },
                        "alternative_slots": {
                          "type": "array",
                          "description": "Suggested alternative slots",
                          "items": {
                            "type": "object",
                            "properties": {
                              "slot_id": {
                                "type": "integer",
                                "example": 11
                              },
                              "date": {
                                "type": "string",
                                "format": "date",
                                "example": "2025-11-14"
                              },
                              "start_time": {
                                "type": "string",
                                "format": "time",
                                "example": "14:00:00"
                              },
                              "available_count": {
                                "type": "integer",
                                "example": 180
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/merchant/tickets/scan": {
      "post": {
        "tags": [
          "Merchant"
        ],
        "summary": "Scan order or ticket QR and redeem items",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "code",
                  "session_id"
                ],
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "QR token or order code"
                  },
                  "session_id": {
                    "type": "string"
                  },
                  "location_id": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Redemption result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "result": {
                      "type": "string",
                      "enum": [
                        "success",
                        "partial",
                        "reject"
                      ]
                    },
                    "tickets": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/MerchantTicket"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Session invalid or expired"
          },
          "409": {
            "description": "Ticket not redeemable"
          }
        }
      }
    },
    "/merchant/orders/{orderId}": {
      "get": {
        "tags": [
          "Merchant"
        ],
        "summary": "View order-level entitlements grouped by passenger",
        "parameters": [
          {
            "name": "orderId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Order entitlement summary",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "order_id": {
                      "type": "string"
                    },
                    "passengers": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/PassengerEntitlements"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/merchant/redemptions": {
      "get": {
        "tags": [
          "Merchant"
        ],
        "summary": "List redemption history for reconciliation",
        "parameters": [
          {
            "name": "date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            }
          },
          {
            "name": "cursor",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Redemption history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "items": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/RedemptionLog"
                      }
                    },
                    "next_cursor": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/miniprogram/orders": {
      "post": {
        "tags": [
          "Miniprogram - Orders"
        ],
        "summary": "创建订单",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "order_no",
                  "product_id",
                  "travel_date",
                  "customer_breakdown"
                ],
                "properties": {
                  "order_no": {
                    "type": "string",
                    "description": "订单号（前端生成，用于幂等）",
                    "example": "MP202512010001"
                  },
                  "product_id": {
                    "type": "integer",
                    "description": "产品ID",
                    "example": 106
                  },
                  "travel_date": {
                    "type": "string",
                    "format": "date",
                    "description": "出行日期",
                    "example": "2025-12-15"
                  },
                  "customer_breakdown": {
                    "type": "array",
                    "description": "客户明细",
                    "items": {
                      "type": "object",
                      "required": [
                        "customer_type",
                        "count"
                      ],
                      "properties": {
                        "customer_type": {
                          "type": "string",
                          "enum": [
                            "adult",
                            "child",
                            "elderly"
                          ]
                        },
                        "count": {
                          "type": "integer",
                          "minimum": 1
                        }
                      }
                    }
                  },
                  "addons": {
                    "type": "array",
                    "description": "附加项（可选）",
                    "items": {
                      "type": "object",
                      "properties": {
                        "addon_id": {
                          "type": "string",
                          "enum": [
                            "tokens-plan-a",
                            "tokens-plan-b",
                            "tokens-plan-c"
                          ]
                        },
                        "quantity": {
                          "type": "integer"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "订单创建成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrderResponse"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误 / 库存不足"
          },
          "401": {
            "description": "未授权"
          },
          "404": {
            "description": "产品不存在"
          }
        }
      },
      "get": {
        "tags": [
          "Miniprogram - Orders"
        ],
        "summary": "获取订单列表",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "page_size",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 50
            }
          }
        ],
        "responses": {
          "200": {
            "description": "订单列表",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "orders": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/OrderListItem"
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "page": {
                      "type": "integer"
                    },
                    "page_size": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/miniprogram/orders/{orderId}": {
      "get": {
        "tags": [
          "Miniprogram - Orders"
        ],
        "summary": "获取订单详情",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "orderId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "订单详情",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OrderDetailResponse"
                }
              }
            }
          },
          "404": {
            "description": "订单不存在"
          }
        }
      }
    },
    "/miniprogram/orders/{orderId}/cancel": {
      "post": {
        "tags": [
          "Miniprogram - Orders"
        ],
        "summary": "取消订单",
        "description": "取消待支付的订单，释放预留库存。\n\n**功能特性：**\n1. 仅允许取消 PENDING 状态的订单\n2. 取消后自动释放预留库存\n3. 支持幂等调用（已取消的订单再次取消返回成功）\n\n**使用场景：**\n- 用户主动取消未支付订单\n- 前端检测到订单超时（expires_at）后自动调用\n",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "orderId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "取消成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "订单已取消"
                    },
                    "order": {
                      "$ref": "#/components/schemas/OrderResponse"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "订单状态不允许取消",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INVALID_ORDER_STATUS"
                    },
                    "message": {
                      "type": "string",
                      "example": "只能取消待支付的订单"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "未授权"
          },
          "404": {
            "description": "订单不存在"
          }
        }
      }
    },
    "/miniprogram/orders/{orderId}/simulate-payment": {
      "post": {
        "tags": [
          "Miniprogram - Orders"
        ],
        "summary": "模拟支付成功（仅测试环境）",
        "description": "将订单状态从 PENDING 更新为 PAID，确认库存，自动生成票券。\n**注意：此接口仅用于开发测试，生产环境应禁用。**\n",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "orderId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "模拟支付成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "模拟支付成功"
                    },
                    "order": {
                      "$ref": "#/components/schemas/OrderDetailResponse"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "订单状态不是 PENDING",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INVALID_ORDER_STATUS"
                    },
                    "message": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "未授权"
          },
          "404": {
            "description": "订单不存在"
          }
        }
      }
    },
    "/miniprogram/tickets/{code}/qr": {
      "post": {
        "tags": [
          "Miniprogram - Tickets"
        ],
        "summary": "为票券生成二维码",
        "description": "为指定票券生成加密二维码，特性：\n1. 验证票券所有权（必须是当前用户的票券）\n2. 生成新二维码时，旧二维码自动失效（通过 jti 机制）\n3. 默认有效期 30 分钟\n",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "code",
            "in": "path",
            "required": true,
            "description": "票券编码 (ticket_code)",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "expiry_minutes": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 1440,
                    "default": 30,
                    "description": "二维码有效期（分钟）"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "二维码生成成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TicketQRResponse"
                }
              }
            }
          },
          "400": {
            "description": "无效的票券编码或有效期参数"
          },
          "401": {
            "description": "未授权"
          },
          "403": {
            "description": "票券不属于当前用户"
          },
          "404": {
            "description": "票券不存在"
          }
        }
      }
    },
    "/miniprogram/products": {
      "get": {
        "tags": [
          "Miniprogram - Products"
        ],
        "summary": "获取小程序商品列表（仅展示 direct channel 有库存的商品）",
        "parameters": [
          {
            "name": "category",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "商品分类过滤"
          },
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "商品列表",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "total": {
                      "type": "integer",
                      "description": "总商品数"
                    },
                    "page": {
                      "type": "integer"
                    },
                    "page_size": {
                      "type": "integer"
                    },
                    "products": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "integer",
                            "example": 101
                          },
                          "sku": {
                            "type": "string",
                            "example": "PASS-3IN1"
                          },
                          "name": {
                            "type": "string",
                            "example": "3-in-1 Transport Pass"
                          },
                          "description": {
                            "type": "string"
                          },
                          "category": {
                            "type": "string"
                          },
                          "base_price": {
                            "type": "number",
                            "example": 288
                          },
                          "image_url": {
                            "type": "string",
                            "format": "uri",
                            "description": "商品展示图片URL",
                            "example": "https://example.com/images/product-101.jpg"
                          },
                          "weekend_premium": {
                            "type": "number",
                            "example": 30
                          },
                          "customer_discounts": {
                            "type": "object",
                            "description": "乘客类型折扣"
                          },
                          "entitlements": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "type": {
                                  "type": "string"
                                },
                                "description": {
                                  "type": "string"
                                }
                              }
                            }
                          },
                          "functions": {
                            "type": "array",
                            "description": "商品包含的功能/权益",
                            "items": {
                              "type": "object",
                              "properties": {
                                "function_code": {
                                  "type": "string"
                                },
                                "label": {
                                  "type": "string"
                                },
                                "quantity": {
                                  "type": "integer"
                                }
                              }
                            }
                          },
                          "availability": {
                            "type": "object",
                            "properties": {
                              "available": {
                                "type": "integer",
                                "description": "direct channel 可售数量"
                              },
                              "allocated": {
                                "type": "integer"
                              },
                              "status": {
                                "type": "string",
                                "enum": [
                                  "in_stock",
                                  "low_stock",
                                  "out_of_stock"
                                ]
                              }
                            }
                          },
                          "sale_period": {
                            "type": "object",
                            "properties": {
                              "start_at": {
                                "type": "string",
                                "format": "date-time"
                              },
                              "end_at": {
                                "type": "string",
                                "format": "date-time"
                              }
                            }
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "active",
                              "inactive"
                            ]
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/miniprogram/products/{productId}": {
      "get": {
        "tags": [
          "Miniprogram - Products"
        ],
        "summary": "获取商品详情",
        "parameters": [
          {
            "name": "productId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "商品详情",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "integer"
                    },
                    "sku": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "description": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string"
                    },
                    "base_price": {
                      "type": "number"
                    },
                    "image_url": {
                      "type": "string",
                      "format": "uri",
                      "description": "商品展示图片URL"
                    },
                    "weekend_premium": {
                      "type": "number"
                    },
                    "customer_discounts": {
                      "type": "object"
                    },
                    "entitlements": {
                      "type": "array"
                    },
                    "functions": {
                      "type": "array"
                    },
                    "availability": {
                      "type": "object",
                      "properties": {
                        "channel": {
                          "type": "string",
                          "default": "direct"
                        },
                        "available": {
                          "type": "integer"
                        },
                        "allocated": {
                          "type": "integer"
                        },
                        "reserved": {
                          "type": "integer"
                        },
                        "sold": {
                          "type": "integer"
                        },
                        "status": {
                          "type": "string"
                        }
                      }
                    },
                    "sale_period": {
                      "type": "object"
                    },
                    "status": {
                      "type": "string"
                    },
                    "images": {
                      "type": "array",
                      "items": {
                        "type": "string",
                        "format": "uri"
                      }
                    },
                    "terms_and_conditions": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "商品不存在或不在 direct channel 销售"
          }
        }
      }
    },
    "/miniprogram/products/{productId}/availability": {
      "get": {
        "tags": [
          "Miniprogram - Products"
        ],
        "summary": "实时查询商品库存",
        "parameters": [
          {
            "name": "productId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "quantity",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 1
            },
            "description": "查询指定数量是否可售"
          }
        ],
        "responses": {
          "200": {
            "description": "库存信息",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "product_id": {
                      "type": "integer"
                    },
                    "channel": {
                      "type": "string",
                      "default": "direct"
                    },
                    "available": {
                      "type": "integer"
                    },
                    "allocated": {
                      "type": "integer"
                    },
                    "reserved": {
                      "type": "integer"
                    },
                    "sold": {
                      "type": "integer"
                    },
                    "is_available": {
                      "type": "boolean",
                      "description": "指定数量是否可售"
                    },
                    "requested_quantity": {
                      "type": "integer"
                    },
                    "status": {
                      "type": "string",
                      "enum": [
                        "in_stock",
                        "low_stock",
                        "out_of_stock"
                      ]
                    },
                    "last_updated": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "商品不存在"
          }
        }
      }
    },
    "/miniprogram/profile": {
      "get": {
        "tags": [
          "MiniprogramProfile"
        ],
        "summary": "Get current user's profile",
        "description": "Retrieve authenticated WeChat user's profile data",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Profile retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MiniprogramUserProfile"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          }
        }
      },
      "post": {
        "tags": [
          "MiniprogramProfile"
        ],
        "summary": "Update user profile",
        "description": "Update authenticated user's profile (partial update supported)",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 50,
                    "description": "Display name"
                  },
                  "nickname": {
                    "type": "string",
                    "maxLength": 50,
                    "description": "WeChat nickname (stored in wechat_extra)"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Profile updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MiniprogramUserProfile"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid input"
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          },
          "422": {
            "description": "Validation failed"
          }
        }
      }
    },
    "/my/tickets": {
      "get": {
        "tags": [
          "Tickets"
        ],
        "summary": "List buyer's tickets",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "tickets": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Ticket"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/notifications/templates": {
      "post": {
        "tags": [
          "Notifications"
        ],
        "summary": "Upsert notification templates and channel config",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "event",
                  "channel",
                  "template_id"
                ],
                "properties": {
                  "event": {
                    "type": "string",
                    "enum": [
                      "order.paid",
                      "order.cancelled",
                      "ticket.refunded",
                      "ticket.expired",
                      "ticket.redeemed"
                    ]
                  },
                  "channel": {
                    "type": "string",
                    "enum": [
                      "wechat"
                    ]
                  },
                  "template_id": {
                    "type": "string"
                  },
                  "enabled": {
                    "type": "boolean",
                    "default": true
                  },
                  "payload_schema": {
                    "type": "object"
                  }
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "Notifications"
        ],
        "summary": "List configured notification templates",
        "responses": {
          "200": {
            "description": "Templates"
          }
        }
      }
    },
    "/notifications/preview": {
      "post": {
        "tags": [
          "Notifications"
        ],
        "summary": "Render notification payload for QA",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "event",
                  "data"
                ],
                "properties": {
                  "event": {
                    "type": "string"
                  },
                  "data": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rendered payload"
          }
        }
      }
    },
    "/api/operator/login": {
      "post": {
        "tags": [
          "Operator Authentication"
        ],
        "summary": "Authenticate venue operator",
        "description": "Simple authentication for operators.\nReturns JWT token with 8-hour expiration.\nAlternative: Use existing multi-org auth with OPERATOR role.\n",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "username",
                  "password"
                ],
                "properties": {
                  "username": {
                    "type": "string",
                    "example": "operator01",
                    "description": "Operator username or PIN"
                  },
                  "password": {
                    "type": "string",
                    "format": "password",
                    "example": "secure_password"
                  },
                  "venue_id": {
                    "type": "integer",
                    "nullable": true,
                    "example": 1,
                    "description": "Optional venue assignment"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Authentication successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "token": {
                          "type": "string",
                          "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
                          "description": "JWT token for subsequent requests"
                        },
                        "operator_id": {
                          "type": "integer",
                          "example": 5
                        },
                        "operator_name": {
                          "type": "string",
                          "example": "Jane Smith"
                        },
                        "role": {
                          "type": "string",
                          "example": "OPERATOR"
                        },
                        "venue_id": {
                          "type": "integer",
                          "nullable": true,
                          "example": 1
                        },
                        "expires_at": {
                          "type": "string",
                          "format": "date-time",
                          "example": "2025-11-14T18:30:00Z"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Invalid credentials",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string",
                          "example": "INVALID_CREDENTIALS"
                        },
                        "message": {
                          "type": "string",
                          "example": "Invalid username or password"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "429": {
            "description": "Too many failed attempts (rate limiting)"
          }
        }
      }
    },
    "/api/operator/validate-ticket": {
      "post": {
        "tags": [
          "Operator Scanning"
        ],
        "summary": "Validate ticket for venue entry",
        "description": "Check ticket status, reservation, and date matching.\nReturns color-coded validation result for operator display.\nDoes NOT modify ticket status (use verify-ticket for that).\n",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ticket_code"
                ],
                "properties": {
                  "ticket_code": {
                    "type": "string",
                    "example": "TKT-2025-ABC123-DEF456",
                    "description": "Extracted from QR code or manual entry"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Validation completed (check validation_status for result)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "ticket_id": {
                          "type": "integer",
                          "example": 123
                        },
                        "ticket_code": {
                          "type": "string",
                          "example": "TKT-2025-ABC123-DEF456"
                        },
                        "status": {
                          "type": "string",
                          "enum": [
                            "PENDING_PAYMENT",
                            "ACTIVATED",
                            "RESERVED",
                            "VERIFIED",
                            "EXPIRED"
                          ],
                          "example": "RESERVED"
                        },
                        "customer_email": {
                          "type": "string",
                          "example": "john@example.com"
                        },
                        "customer_phone": {
                          "type": "string",
                          "example": "+12025551234"
                        },
                        "reservation": {
                          "type": "object",
                          "nullable": true,
                          "properties": {
                            "reservation_id": {
                              "type": "integer",
                              "example": 789
                            },
                            "date": {
                              "type": "string",
                              "format": "date",
                              "example": "2025-11-14"
                            },
                            "start_time": {
                              "type": "string",
                              "format": "time",
                              "example": "12:00:00"
                            },
                            "end_time": {
                              "type": "string",
                              "format": "time",
                              "example": "14:00:00"
                            },
                            "is_today": {
                              "type": "boolean",
                              "example": true,
                              "description": "Whether reservation date matches current date"
                            }
                          }
                        },
                        "validation_status": {
                          "type": "string",
                          "enum": [
                            "VALID",
                            "INVALID",
                            "WRONG_DATE",
                            "NO_RESERVATION",
                            "ALREADY_VERIFIED"
                          ],
                          "example": "VALID",
                          "description": "Validation result code"
                        },
                        "color_code": {
                          "type": "string",
                          "enum": [
                            "GREEN",
                            "RED",
                            "YELLOW"
                          ],
                          "example": "GREEN",
                          "description": "UI color indicator"
                        },
                        "reason": {
                          "type": "string",
                          "nullable": true,
                          "example": null,
                          "description": "Human-readable reason if validation failed"
                        },
                        "operator_action": {
                          "type": "string",
                          "enum": [
                            "allow_entry",
                            "deny_entry",
                            "warning"
                          ],
                          "example": "allow_entry"
                        },
                        "verified_info": {
                          "type": "object",
                          "nullable": true,
                          "description": "Present if ticket already verified",
                          "properties": {
                            "verified_at": {
                              "type": "string",
                              "format": "date-time",
                              "example": "2025-11-14T09:30:00Z"
                            },
                            "verified_by": {
                              "type": "integer",
                              "example": 5
                            },
                            "operator_name": {
                              "type": "string",
                              "example": "Jane Smith"
                            }
                          }
                        },
                        "current_date": {
                          "type": "string",
                          "format": "date",
                          "example": "2025-11-14",
                          "description": "Server's current date for reference"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing operator token"
          },
          "404": {
            "description": "Ticket not found (returns as validation_status=INVALID)"
          }
        }
      }
    },
    "/api/operator/verify-ticket": {
      "post": {
        "tags": [
          "Operator Scanning"
        ],
        "summary": "Mark ticket as verified (allow entry)",
        "description": "Updates ticket status to VERIFIED.\nRecords verification timestamp and operator ID.\nShould only be called after validate-ticket returns VALID.\n",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ticket_id",
                  "operator_id"
                ],
                "properties": {
                  "ticket_id": {
                    "type": "integer",
                    "example": 123
                  },
                  "operator_id": {
                    "type": "integer",
                    "example": 5,
                    "description": "ID of operator performing verification"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Ticket verified successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "ticket_id": {
                          "type": "integer",
                          "example": 123
                        },
                        "ticket_code": {
                          "type": "string",
                          "example": "TKT-2025-ABC123-DEF456"
                        },
                        "status": {
                          "type": "string",
                          "enum": [
                            "VERIFIED"
                          ],
                          "example": "VERIFIED"
                        },
                        "verified_at": {
                          "type": "string",
                          "format": "date-time",
                          "example": "2025-11-14T10:30:00Z"
                        },
                        "verified_by": {
                          "type": "integer",
                          "example": 5
                        },
                        "operator_name": {
                          "type": "string",
                          "example": "Jane Smith"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid request or ticket not in RESERVED status"
          },
          "401": {
            "description": "Unauthorized"
          },
          "404": {
            "description": "Ticket not found"
          },
          "409": {
            "description": "Ticket already verified (idempotent - returns existing verification)"
          }
        }
      }
    },
    "/operators/login": {
      "post": {
        "tags": [
          "Operators"
        ],
        "summary": "Operator login (get operator_token)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "username",
                  "password"
                ],
                "properties": {
                  "username": {
                    "type": "string"
                  },
                  "password": {
                    "type": "string",
                    "format": "password"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "operator_token": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "invalid credentials"
          }
        }
      }
    },
    "/api/ota/orders": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "List all confirmed OTA orders",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 50,
              "maximum": 100
            },
            "description": "Maximum number of orders to return"
          },
          {
            "name": "offset",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 0
            },
            "description": "Number of orders to skip"
          },
          {
            "name": "status",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "confirmed",
                "completed",
                "cancelled"
              ]
            },
            "description": "Filter by order status"
          }
        ],
        "responses": {
          "200": {
            "description": "Orders retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "orders": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "order_id": {
                            "type": "string",
                            "example": "ORD-1762273241549"
                          },
                          "product_id": {
                            "type": "integer",
                            "example": 106
                          },
                          "customer_name": {
                            "type": "string",
                            "example": "Maria Garcia"
                          },
                          "customer_email": {
                            "type": "string",
                            "example": "maria.garcia@example.com"
                          },
                          "total_amount": {
                            "type": "string",
                            "example": "382.00"
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "confirmed",
                              "completed",
                              "cancelled"
                            ]
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "confirmation_code": {
                            "type": "string",
                            "example": "CONF-1762273241549"
                          }
                        }
                      }
                    },
                    "total_count": {
                      "type": "integer",
                      "example": 2
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ota/orders/{id}/tickets": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Get QR codes and ticket details for order",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "example": "ORD-1762273241549"
            },
            "description": "Order ID to retrieve tickets for"
          }
        ],
        "responses": {
          "200": {
            "description": "Tickets retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "tickets": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "ticket_code": {
                            "type": "string",
                            "example": "CRUISE-2025-FERRY-1762273144582"
                          },
                          "qr_code": {
                            "type": "string",
                            "description": "Base64 encoded QR code for scanning",
                            "example": "data:image/png;base64,eyJ0aWNrZXRfaWQiOjE3NjI..."
                          },
                          "entitlements": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "function_code": {
                                  "type": "string",
                                  "example": "ferry"
                                },
                                "remaining_uses": {
                                  "type": "integer",
                                  "example": 1
                                }
                              }
                            }
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "ACTIVE",
                              "REDEEMED",
                              "EXPIRED"
                            ],
                            "example": "ACTIVE"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Access denied to order"
          },
          "404": {
            "description": "Order not found"
          }
        }
      }
    },
    "/api/ota/tickets/{code}/pdf": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Export ticket as PDF",
        "description": "Generates a PDF document for a single ticket containing:\n- Title: [ E-Ticket ]\n- Ticket code\n- QR code\n",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "code",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Ticket code",
            "example": "BATCH-20251218-partner-ABC123"
          }
        ],
        "responses": {
          "200": {
            "description": "PDF generated successfully",
            "content": {
              "application/pdf": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            },
            "headers": {
              "Content-Disposition": {
                "schema": {
                  "type": "string"
                },
                "example": "attachment; filename=\"BATCH-20251218-partner-ABC123.pdf\""
              },
              "Content-Type": {
                "schema": {
                  "type": "string"
                },
                "example": "application/pdf"
              }
            }
          },
          "403": {
            "description": "Unauthorized - ticket not owned by partner",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "example": "Ticket does not belong to this partner"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Ticket not found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "TICKET_NOT_FOUND"
                    },
                    "message": {
                      "type": "string",
                      "example": "Ticket not found"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ota/batches/{id}/pdf": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Export all tickets in a batch as a single PDF",
        "description": "Generates a PDF document containing all tickets in a batch.\nEach ticket occupies one page.\n",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Batch ID",
            "example": "BATCH-20251218-partner-ABC123"
          }
        ],
        "responses": {
          "200": {
            "description": "PDF generated successfully",
            "content": {
              "application/pdf": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            },
            "headers": {
              "Content-Disposition": {
                "schema": {
                  "type": "string"
                },
                "example": "attachment; filename=\"BATCH-20251218-partner-ABC123.pdf\""
              }
            }
          },
          "403": {
            "description": "Unauthorized - batch not owned by partner"
          },
          "404": {
            "description": "Batch not found"
          }
        }
      }
    },
    "/api/ota/batches/{id}/export-zip": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Export all tickets as individual PDFs in a ZIP",
        "description": "Exports all tickets in a batch as individual PDF files,\npackaged in a ZIP archive. Uses streaming for large batches\n(5000+ tickets).\n\nFeatures:\n- Each ticket is a separate PDF file\n- Streaming download (starts immediately)\n- Supports batches up to 10,000+ tickets\n- 10-minute timeout for large exports\n",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Batch ID",
            "example": "BATCH-20251218-partner-ABC123"
          }
        ],
        "responses": {
          "200": {
            "description": "ZIP archive with PDF files",
            "content": {
              "application/zip": {
                "schema": {
                  "type": "string",
                  "format": "binary"
                }
              }
            },
            "headers": {
              "Content-Disposition": {
                "schema": {
                  "type": "string"
                },
                "example": "attachment; filename=\"BATCH-20251218-partner-ABC123.zip\""
              },
              "Transfer-Encoding": {
                "schema": {
                  "type": "string"
                },
                "example": "chunked"
              }
            }
          },
          "403": {
            "description": "Unauthorized - batch not owned by partner"
          },
          "404": {
            "description": "Batch not found"
          }
        }
      }
    },
    "/api/ota/batches": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "List ticket batches with pagination and filters",
        "description": "Returns a paginated list of ticket batches for the authenticated OTA partner.\nSupports filtering by status, product_id, reseller, and date range.\n",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "active",
                "expired",
                "depleted"
              ]
            },
            "description": "Filter by batch status",
            "example": "active"
          },
          {
            "name": "product_id",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer"
            },
            "description": "Filter by product ID",
            "example": 106
          },
          {
            "name": "reseller",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Filter by reseller name (from reseller_metadata.intended_reseller)",
            "example": "Travel Agency ABC"
          },
          {
            "name": "created_after",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Filter batches created after this date (ISO 8601)",
            "example": "2025-11-01T00:00:00Z"
          },
          {
            "name": "created_before",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Filter batches created before this date (ISO 8601)",
            "example": "2025-12-31T23:59:59Z"
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            },
            "description": "Page number",
            "example": 1
          },
          {
            "name": "limit",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            },
            "description": "Results per page (max 100)",
            "example": 20
          }
        ],
        "responses": {
          "200": {
            "description": "Batch list retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "items": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "batch_id": {
                            "type": "string",
                            "example": "BATCH-20251210-test_partner-BK19PI"
                          },
                          "product_id": {
                            "type": "integer",
                            "example": 107
                          },
                          "distribution_mode": {
                            "type": "string",
                            "enum": [
                              "direct_sale",
                              "reseller_batch"
                            ],
                            "example": "direct_sale"
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "active",
                              "expired",
                              "depleted"
                            ],
                            "example": "active"
                          },
                          "total_quantity": {
                            "type": "integer",
                            "description": "Total tickets in batch",
                            "example": 1000
                          },
                          "tickets_activated": {
                            "type": "integer",
                            "description": "Number of activated tickets",
                            "example": 150
                          },
                          "tickets_redeemed": {
                            "type": "integer",
                            "description": "Number of redeemed tickets",
                            "example": 45
                          },
                          "reseller_name": {
                            "type": "string",
                            "nullable": true,
                            "description": "Reseller name (if reseller_batch mode)",
                            "example": "Travel Agency ABC"
                          },
                          "campaign_type": {
                            "type": "string",
                            "nullable": true,
                            "description": "Campaign type from batch_metadata",
                            "example": "flash_sale"
                          },
                          "expires_at": {
                            "type": "string",
                            "format": "date-time",
                            "nullable": true,
                            "example": "2025-12-17T03:36:35.000Z"
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time",
                            "example": "2025-12-10T03:36:35.000Z"
                          }
                        }
                      }
                    },
                    "total": {
                      "type": "integer",
                      "description": "Total count of batches matching filters",
                      "example": 154
                    },
                    "page": {
                      "type": "integer",
                      "example": 1
                    },
                    "page_size": {
                      "type": "integer",
                      "example": 20
                    },
                    "has_more": {
                      "type": "boolean",
                      "example": true
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Missing or invalid API key"
          },
          "500": {
            "description": "Internal server error"
          }
        }
      }
    },
    "/api/ota/tickets": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "List pre-made tickets with optional filters",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "PRE_GENERATED",
                "ACTIVE",
                "USED",
                "EXPIRED",
                "CANCELLED"
              ]
            },
            "description": "Filter by ticket status",
            "example": "PRE_GENERATED"
          },
          {
            "name": "batch_id",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Filter by batch ID",
            "example": "BATCH-20251105-001"
          },
          {
            "name": "created_after",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Filter tickets created after this date (ISO 8601)",
            "example": "2025-11-01T00:00:00Z"
          },
          {
            "name": "created_before",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Filter tickets created before this date (ISO 8601)",
            "example": "2025-12-31T23:59:59Z"
          },
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            },
            "description": "Page number",
            "example": 1
          },
          {
            "name": "limit",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "default": 100
            },
            "description": "Results per page (max 1000)",
            "example": 100
          }
        ],
        "responses": {
          "200": {
            "description": "Ticket list retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "tickets": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "ticket_code": {
                            "type": "string",
                            "example": "CRUISE-2025-FERRY-1762330663284"
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "PRE_GENERATED",
                              "ACTIVE",
                              "USED",
                              "EXPIRED",
                              "CANCELLED"
                            ],
                            "description": "Ticket lifecycle status:\n- PRE_GENERATED: Newly generated, not yet activated\n- ACTIVE: Activated by customer, ready for redemption\n- USED: All entitlements fully consumed (automatic)\n- EXPIRED: Past valid date\n- CANCELLED: Manually cancelled by partner\n"
                          },
                          "batch_id": {
                            "type": "string",
                            "example": "BATCH-20251105-001"
                          },
                          "product_id": {
                            "type": "integer",
                            "example": 106
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "activated_at": {
                            "type": "string",
                            "format": "date-time",
                            "nullable": true
                          },
                          "order_id": {
                            "type": "string",
                            "nullable": true
                          },
                          "customer_name": {
                            "type": "string",
                            "nullable": true
                          },
                          "customer_email": {
                            "type": "string",
                            "nullable": true
                          },
                          "qr_code": {
                            "type": "string",
                            "format": "base64",
                            "description": "Base64-encoded QR code image (data URI format)",
                            "example": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..."
                          }
                        }
                      }
                    },
                    "total_count": {
                      "type": "integer",
                      "example": 100
                    },
                    "page": {
                      "type": "integer",
                      "example": 1
                    },
                    "page_size": {
                      "type": "integer",
                      "example": 100
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Invalid query parameters",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "error": {
                      "type": "string",
                      "example": "INVALID_PARAMETER"
                    },
                    "message": {
                      "type": "string",
                      "example": "page must be a positive integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ota/tickets/bulk-generate": {
      "post": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Generate pre-made tickets for OTA sales",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "product_id",
                  "quantity",
                  "batch_id"
                ],
                "properties": {
                  "product_id": {
                    "type": "integer",
                    "description": "Package product ID",
                    "example": 106
                  },
                  "quantity": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 100,
                    "description": "Number of pre-made tickets to generate",
                    "example": 50
                  },
                  "batch_id": {
                    "type": "string",
                    "description": "Batch identifier for tracking",
                    "example": "BATCH_2025_Q1_001"
                  },
                  "distribution_mode": {
                    "type": "string",
                    "enum": [
                      "direct_sale",
                      "reseller_batch"
                    ],
                    "description": "Distribution strategy for batch",
                    "default": "direct_sale",
                    "example": "reseller_batch"
                  },
                  "reseller_metadata": {
                    "type": "object",
                    "description": "Required for reseller_batch mode",
                    "properties": {
                      "intended_reseller": {
                        "type": "string",
                        "description": "Reseller company/partner name",
                        "example": "Travel Agency ABC"
                      },
                      "batch_purpose": {
                        "type": "string",
                        "description": "Purpose of this reseller batch",
                        "example": "Q1 2025 Spring Campaign"
                      },
                      "distribution_notes": {
                        "type": "string",
                        "description": "Additional distribution information",
                        "example": "For regional cruise promotion"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Pre-made tickets successfully generated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "batch_id": {
                      "type": "string",
                      "example": "BATCH_2025_Q1_001"
                    },
                    "distribution_mode": {
                      "type": "string",
                      "example": "reseller_batch"
                    },
                    "reseller_metadata": {
                      "type": "object",
                      "properties": {
                        "intended_reseller": {
                          "type": "string",
                          "example": "Travel Agency ABC"
                        },
                        "batch_purpose": {
                          "type": "string",
                          "example": "Q1 2025 Spring Campaign"
                        }
                      }
                    },
                    "expires_at": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Batch expiry (extended for reseller_batch)"
                    },
                    "pricing_snapshot": {
                      "type": "object",
                      "description": "Locked pricing captured at generation time",
                      "properties": {
                        "base_price": {
                          "type": "number",
                          "example": 288
                        },
                        "customer_type_pricing": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "customer_type": {
                                "type": "string",
                                "enum": [
                                  "adult",
                                  "child",
                                  "elderly"
                                ]
                              },
                              "unit_price": {
                                "type": "number"
                              },
                              "discount_applied": {
                                "type": "number"
                              }
                            }
                          }
                        },
                        "currency": {
                          "type": "string",
                          "example": "HKD"
                        },
                        "captured_at": {
                          "type": "string",
                          "format": "date-time"
                        }
                      }
                    },
                    "tickets": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "ticket_code": {
                            "type": "string",
                            "example": "CRUISE-2025-FERRY-1762274285982"
                          },
                          "qr_code": {
                            "type": "string",
                            "description": "Base64 encoded QR code"
                          },
                          "status": {
                            "type": "string",
                            "enum": [
                              "PRE_GENERATED"
                            ]
                          },
                          "entitlements": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "function_code": {
                                  "type": "string"
                                },
                                "remaining_uses": {
                                  "type": "integer"
                                }
                              }
                            }
                          }
                        }
                      }
                    },
                    "total_generated": {
                      "type": "integer",
                      "example": 50
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ota/tickets/{code}/activate": {
      "post": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Activate pre-made ticket with customer details",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "code",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "example": "CRUISE-2025-FERRY-1762274285982"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "customer_details",
                  "customer_type",
                  "payment_reference"
                ],
                "properties": {
                  "customer_details": {
                    "type": "object",
                    "required": [
                      "name",
                      "email",
                      "phone"
                    ],
                    "properties": {
                      "name": {
                        "type": "string",
                        "example": "John Smith"
                      },
                      "email": {
                        "type": "string",
                        "format": "email",
                        "example": "john.smith@example.com"
                      },
                      "phone": {
                        "type": "string",
                        "example": "+1234567890"
                      }
                    }
                  },
                  "customer_type": {
                    "type": "string",
                    "enum": [
                      "adult",
                      "child",
                      "elderly"
                    ],
                    "description": "Customer type for pricing (determines final ticket price)",
                    "example": "adult"
                  },
                  "visit_date": {
                    "type": "string",
                    "format": "date",
                    "description": "Intended visit date (YYYY-MM-DD) - OPTIONAL. Used for weekend pricing calculation. If provided and is a weekend (Saturday/Sunday), weekend_premium will be added to the base price.",
                    "example": "2025-11-23"
                  },
                  "payment_reference": {
                    "type": "string",
                    "description": "OTA payment transaction reference",
                    "example": "PAY-OTA-2025-001"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Ticket successfully activated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ticket_code": {
                      "type": "string",
                      "example": "CRUISE-2025-FERRY-1762274285982"
                    },
                    "order_id": {
                      "type": "string",
                      "example": "ORD-1762274304824"
                    },
                    "customer_name": {
                      "type": "string",
                      "example": "John Smith"
                    },
                    "customer_type": {
                      "type": "string",
                      "enum": [
                        "adult",
                        "child",
                        "elderly"
                      ],
                      "example": "adult"
                    },
                    "ticket_price": {
                      "type": "number",
                      "description": "Final ticket price (includes weekend premium if applicable)",
                      "example": 318
                    },
                    "currency": {
                      "type": "string",
                      "example": "HKD"
                    },
                    "status": {
                      "type": "string",
                      "enum": [
                        "ACTIVE"
                      ]
                    },
                    "activated_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid request data"
          },
          "404": {
            "description": "Ticket not found or already activated"
          },
          "409": {
            "description": "Ticket already activated"
          }
        }
      }
    },
    "/api/ota/reservations": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "List all active reservations for monitoring",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Active reservations retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reservations": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/ChannelReservation"
                      }
                    },
                    "total_count": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ota/reservations/{id}": {
      "get": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Get specific reservation details",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "example": "res_mhksku1s_lj1nqt"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Reservation details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ChannelReservation"
                }
              }
            }
          },
          "404": {
            "description": "Reservation not found"
          }
        }
      },
      "delete": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Cancel reservation and release inventory",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Reservation cancelled successfully"
          },
          "404": {
            "description": "Reservation not found"
          },
          "409": {
            "description": "Reservation cannot be cancelled (already activated)"
          }
        }
      }
    },
    "/api/ota/reservations/{id}/activate": {
      "post": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Convert reservation to confirmed order",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "customer_name",
                  "customer_email"
                ],
                "properties": {
                  "customer_name": {
                    "type": "string",
                    "example": "Maria Garcia"
                  },
                  "customer_email": {
                    "type": "string",
                    "format": "email",
                    "example": "maria@example.com"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reservation activated to order",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "order_id": {
                      "type": "string"
                    },
                    "reservation_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "enum": [
                        "activated"
                      ]
                    }
                  }
                }
              }
            }
          },
          "403": {
            "description": "Insufficient permissions for activation"
          },
          "404": {
            "description": "Reservation not found"
          },
          "409": {
            "description": "Reservation expired or already activated"
          }
        }
      }
    },
    "/api/ota/reservations/cleanup": {
      "post": {
        "tags": [
          "OTA Integration"
        ],
        "summary": "Manually trigger cleanup of expired reservations",
        "security": [
          {
            "ApiKeyAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Cleanup completed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "message": {
                      "type": "string",
                      "example": "Cleanup completed"
                    },
                    "expired_reservations": {
                      "type": "integer",
                      "example": 3
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/catalog/promotions/{id}": {
      "get": {
        "tags": [
          "Catalog"
        ],
        "summary": "Get detailed promotion information",
        "description": "Returns enhanced product details including description, pricing, features, inventory, and marketing content",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer",
              "minimum": 1
            },
            "description": "Product ID to get promotion details for"
          }
        ],
        "responses": {
          "200": {
            "description": "Promotion details retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "promotion": {
                      "$ref": "#/components/schemas/PromotionDetail"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid product ID format",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Promotion not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/payments/refund": {
      "post": {
        "tags": [
          "Payments"
        ],
        "summary": "Internal refund processing endpoint",
        "description": "Called by cancellation service to process refunds",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "order_id",
                  "amount",
                  "reason"
                ],
                "properties": {
                  "order_id": {
                    "type": "integer"
                  },
                  "amount": {
                    "type": "number",
                    "format": "decimal"
                  },
                  "reason": {
                    "type": "string",
                    "enum": [
                      "ticket_cancellation",
                      "partial_cancellation"
                    ]
                  },
                  "ticket_id": {
                    "type": "integer"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Refund initiated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "refund_id": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "enum": [
                        "pending",
                        "processing"
                      ]
                    },
                    "amount": {
                      "type": "number"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid refund request"
          },
          "404": {
            "description": "Order not found"
          },
          "422": {
            "description": "Order cannot be refunded"
          }
        }
      }
    },
    "/my/refunds": {
      "get": {
        "tags": [
          "Payments"
        ],
        "summary": "List user's refunds",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User's refund history",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "refunds": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "refund_id": {
                            "type": "string"
                          },
                          "order_id": {
                            "type": "integer"
                          },
                          "amount": {
                            "type": "number"
                          },
                          "status": {
                            "type": "string"
                          },
                          "reason": {
                            "type": "string"
                          },
                          "created_at": {
                            "type": "string",
                            "format": "date-time"
                          },
                          "completed_at": {
                            "type": "string",
                            "format": "date-time"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/reports/redemptions": {
      "get": {
        "tags": [
          "Reports"
        ],
        "summary": "List redemption events for reporting",
        "parameters": [
          {
            "in": "query",
            "name": "from",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "in": "query",
            "name": "to",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "in": "query",
            "name": "function",
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "query",
            "name": "location_id",
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "events": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "ticket_id": {
                            "type": "integer"
                          },
                          "function_code": {
                            "type": "string"
                          },
                          "operator_id": {
                            "type": "integer"
                          },
                          "location_id": {
                            "type": "integer"
                          },
                          "result": {
                            "type": "string",
                            "enum": [
                              "success",
                              "reject"
                            ]
                          },
                          "ts": {
                            "type": "string",
                            "format": "date-time"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/reservation-slots/create": {
      "post": {
        "tags": [
          "Reservation Management",
          "Admin"
        ],
        "summary": "Create new reservation slot (Admin only - Future phase)",
        "description": "Admin endpoint to create custom time slots.\nMVP: Use database seeds instead.\n",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "date",
                  "start_time",
                  "end_time",
                  "total_capacity",
                  "orq"
                ],
                "properties": {
                  "date": {
                    "type": "string",
                    "format": "date",
                    "example": "2025-11-14"
                  },
                  "start_time": {
                    "type": "string",
                    "format": "time",
                    "example": "12:00:00"
                  },
                  "end_time": {
                    "type": "string",
                    "format": "time",
                    "example": "14:00:00"
                  },
                  "venue_id": {
                    "type": "integer",
                    "nullable": true,
                    "example": null
                  },
                  "total_capacity": {
                    "type": "integer",
                    "example": 200
                  },
                  "orq": {
                    "type": "integer",
                    "example": 1
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Slot created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "success": {
                      "type": "boolean"
                    },
                    "data": {
                      "$ref": "#/components/schemas/ReservationSlot"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Validation error"
          },
          "409": {
            "description": "Conflict - slot already exists for this date/time"
          }
        }
      }
    },
    "/admin/routes": {
      "post": {
        "tags": [
          "Admin - Routes"
        ],
        "summary": "Create a new route",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "name",
                  "origin",
                  "destination",
                  "route_type",
                  "operator_id"
                ],
                "properties": {
                  "name": {
                    "type": "string",
                    "example": "Central to Cheung Chau Ferry"
                  },
                  "origin": {
                    "type": "string",
                    "example": "Central Pier 5"
                  },
                  "destination": {
                    "type": "string",
                    "example": "Cheung Chau Ferry Pier"
                  },
                  "route_type": {
                    "type": "string",
                    "enum": [
                      "ferry",
                      "bus",
                      "train"
                    ]
                  },
                  "operator_id": {
                    "type": "string",
                    "example": "cheung_chau_ferry_co"
                  },
                  "description": {
                    "type": "string"
                  },
                  "duration_minutes": {
                    "type": "integer",
                    "example": 50
                  },
                  "distance_km": {
                    "type": "number",
                    "example": 18.5
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Route created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "route_id": {
                      "type": "integer"
                    },
                    "name": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string",
                      "enum": [
                        "active",
                        "inactive"
                      ]
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "409": {
            "description": "Route already exists"
          }
        }
      },
      "get": {
        "tags": [
          "Admin - Routes"
        ],
        "summary": "List all routes",
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "active",
                "inactive",
                "all"
              ],
              "default": "active"
            }
          },
          {
            "name": "route_type",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "ferry",
                "bus",
                "train"
              ]
            }
          },
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1
            }
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Routes list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "total": {
                      "type": "integer"
                    },
                    "page": {
                      "type": "integer"
                    },
                    "page_size": {
                      "type": "integer"
                    },
                    "routes": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Route"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/routes/{routeId}": {
      "get": {
        "tags": [
          "Admin - Routes"
        ],
        "summary": "Get route details",
        "parameters": [
          {
            "name": "routeId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Route details"
          },
          "404": {
            "description": "Route not found"
          }
        }
      },
      "put": {
        "tags": [
          "Admin - Routes"
        ],
        "summary": "Update route",
        "parameters": [
          {
            "name": "routeId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "active",
                      "inactive"
                    ]
                  },
                  "description": {
                    "type": "string"
                  },
                  "duration_minutes": {
                    "type": "integer"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Route updated"
          },
          "404": {
            "description": "Route not found"
          }
        }
      },
      "delete": {
        "tags": [
          "Admin - Routes"
        ],
        "summary": "Delete route (soft delete)",
        "parameters": [
          {
            "name": "routeId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Route deleted"
          },
          "404": {
            "description": "Route not found"
          },
          "409": {
            "description": "Cannot delete - has active schedules"
          }
        }
      }
    },
    "/admin/routes/{routeId}/schedules": {
      "post": {
        "tags": [
          "Admin - Schedules"
        ],
        "summary": "Create schedule for a route",
        "parameters": [
          {
            "name": "routeId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "departure_time",
                  "arrival_time",
                  "weekdays",
                  "seat_classes"
                ],
                "properties": {
                  "departure_time": {
                    "type": "string",
                    "format": "time",
                    "example": "08:00:00"
                  },
                  "arrival_time": {
                    "type": "string",
                    "format": "time",
                    "example": "08:50:00"
                  },
                  "weekdays": {
                    "type": "array",
                    "items": {
                      "type": "integer",
                      "minimum": 0,
                      "maximum": 6
                    },
                    "example": [
                      1,
                      2,
                      3,
                      4,
                      5
                    ],
                    "description": "0=Sunday, 6=Saturday"
                  },
                  "seat_classes": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": [
                        "class_type",
                        "capacity"
                      ],
                      "properties": {
                        "class_type": {
                          "type": "string",
                          "enum": [
                            "standard",
                            "vip"
                          ]
                        },
                        "capacity": {
                          "type": "integer",
                          "example": 300
                        },
                        "base_price": {
                          "type": "number",
                          "example": 50
                        }
                      }
                    }
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "active",
                      "suspended"
                    ],
                    "default": "active"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Schedule created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "schedule_id": {
                      "type": "integer"
                    },
                    "route_id": {
                      "type": "integer"
                    },
                    "departure_time": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid input"
          },
          "404": {
            "description": "Route not found"
          }
        }
      },
      "get": {
        "tags": [
          "Admin - Schedules"
        ],
        "summary": "List schedules for a route",
        "parameters": [
          {
            "name": "routeId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "status",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "active",
                "suspended",
                "all"
              ],
              "default": "active"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Schedules list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "route_id": {
                      "type": "integer"
                    },
                    "schedules": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/Schedule"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/schedules/{scheduleId}": {
      "put": {
        "tags": [
          "Admin - Schedules"
        ],
        "summary": "Update schedule",
        "parameters": [
          {
            "name": "scheduleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "departure_time": {
                    "type": "string",
                    "format": "time"
                  },
                  "arrival_time": {
                    "type": "string",
                    "format": "time"
                  },
                  "weekdays": {
                    "type": "array",
                    "items": {
                      "type": "integer"
                    }
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "active",
                      "suspended"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Schedule updated"
          },
          "404": {
            "description": "Schedule not found"
          }
        }
      },
      "delete": {
        "tags": [
          "Admin - Schedules"
        ],
        "summary": "Delete schedule (soft delete)",
        "parameters": [
          {
            "name": "scheduleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Schedule deleted"
          },
          "404": {
            "description": "Schedule not found"
          }
        }
      }
    },
    "/admin/schedules/inventory/allocate": {
      "post": {
        "tags": [
          "Admin - Inventory"
        ],
        "summary": "Allocate inventory for schedule across channels",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "schedule_id",
                  "date",
                  "seat_class",
                  "channel_allocations"
                ],
                "properties": {
                  "schedule_id": {
                    "type": "integer"
                  },
                  "date": {
                    "type": "string",
                    "format": "date",
                    "example": "2025-12-01"
                  },
                  "seat_class": {
                    "type": "string",
                    "enum": [
                      "standard",
                      "vip"
                    ]
                  },
                  "channel_allocations": {
                    "type": "object",
                    "properties": {
                      "direct": {
                        "type": "object",
                        "properties": {
                          "allocated": {
                            "type": "integer",
                            "example": 200
                          }
                        }
                      },
                      "ota": {
                        "type": "object",
                        "properties": {
                          "allocated": {
                            "type": "integer",
                            "example": 80
                          }
                        }
                      },
                      "reseller": {
                        "type": "object",
                        "properties": {
                          "allocated": {
                            "type": "integer",
                            "example": 20
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Inventory allocated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "schedule_id": {
                      "type": "integer"
                    },
                    "date": {
                      "type": "string"
                    },
                    "total_allocated": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid allocation (exceeds capacity)"
          },
          "404": {
            "description": "Schedule not found"
          }
        }
      }
    },
    "/schedules/{scheduleId}/availability": {
      "get": {
        "tags": [
          "Public - Schedules"
        ],
        "summary": "Check schedule availability for a specific date",
        "parameters": [
          {
            "name": "scheduleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "date",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "format": "date"
            }
          },
          {
            "name": "channel",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "direct",
                "ota",
                "reseller"
              ],
              "default": "direct"
            }
          },
          {
            "name": "seat_class",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "standard",
                "vip"
              ]
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Availability information",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "schedule_id": {
                      "type": "integer"
                    },
                    "date": {
                      "type": "string"
                    },
                    "availability": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "seat_class": {
                            "type": "string"
                          },
                          "channel": {
                            "type": "string"
                          },
                          "available": {
                            "type": "integer"
                          },
                          "allocated": {
                            "type": "integer"
                          },
                          "reserved": {
                            "type": "integer"
                          },
                          "sold": {
                            "type": "integer"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Schedule not found or no inventory for date"
          }
        }
      }
    },
    "/admin/schedules/pricing/rules": {
      "post": {
        "tags": [
          "Admin - Pricing"
        ],
        "summary": "Create or update pricing rule for schedule(s)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "rule_name",
                  "rule_type",
                  "conditions",
                  "adjustments"
                ],
                "properties": {
                  "rule_name": {
                    "type": "string",
                    "example": "Weekend Premium Pricing"
                  },
                  "rule_type": {
                    "type": "string",
                    "enum": [
                      "time_based",
                      "date_based",
                      "passenger_based",
                      "seat_class_based"
                    ]
                  },
                  "applies_to": {
                    "type": "object",
                    "properties": {
                      "schedule_ids": {
                        "type": "array",
                        "items": {
                          "type": "integer"
                        },
                        "description": "Specific schedules (empty = all schedules)"
                      },
                      "route_ids": {
                        "type": "array",
                        "items": {
                          "type": "integer"
                        },
                        "description": "All schedules on these routes"
                      },
                      "route_types": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "enum": [
                            "ferry",
                            "bus",
                            "train"
                          ]
                        }
                      }
                    }
                  },
                  "conditions": {
                    "type": "object",
                    "properties": {
                      "time_range": {
                        "type": "object",
                        "properties": {
                          "start": {
                            "type": "string",
                            "format": "time",
                            "example": "07:00:00"
                          },
                          "end": {
                            "type": "string",
                            "format": "time",
                            "example": "09:00:00"
                          }
                        },
                        "description": "Peak hours"
                      },
                      "weekdays": {
                        "type": "array",
                        "items": {
                          "type": "integer"
                        },
                        "example": [
                          0,
                          6
                        ],
                        "description": "0=Sunday, 6=Saturday"
                      },
                      "date_range": {
                        "type": "object",
                        "properties": {
                          "start": {
                            "type": "string",
                            "format": "date"
                          },
                          "end": {
                            "type": "string",
                            "format": "date"
                          }
                        },
                        "description": "Seasonal pricing"
                      },
                      "seat_class": {
                        "type": "string",
                        "enum": [
                          "standard",
                          "vip"
                        ]
                      },
                      "passenger_type": {
                        "type": "string",
                        "enum": [
                          "adult",
                          "child",
                          "senior",
                          "student"
                        ]
                      }
                    }
                  },
                  "adjustments": {
                    "type": "object",
                    "properties": {
                      "type": {
                        "type": "string",
                        "enum": [
                          "multiplier",
                          "fixed_amount",
                          "percentage_discount"
                        ]
                      },
                      "value": {
                        "type": "number",
                        "example": 1.3,
                        "description": "For multiplier: 1.3 = 30% increase. For fixed: absolute amount. For percentage: 0.2 = 20% discount"
                      }
                    }
                  },
                  "priority": {
                    "type": "integer",
                    "default": 0,
                    "description": "Higher priority rules apply first (for conflicting rules)"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "active",
                      "inactive"
                    ],
                    "default": "active"
                  },
                  "effective_from": {
                    "type": "string",
                    "format": "date-time"
                  },
                  "effective_until": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Optional expiration date"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Pricing rule created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "rule_id": {
                      "type": "integer"
                    },
                    "rule_name": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid rule configuration"
          }
        }
      },
      "get": {
        "tags": [
          "Admin - Pricing"
        ],
        "summary": "List all pricing rules",
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "active",
                "inactive",
                "all"
              ],
              "default": "active"
            }
          },
          {
            "name": "rule_type",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "time_based",
                "date_based",
                "passenger_based",
                "seat_class_based"
              ]
            }
          },
          {
            "name": "schedule_id",
            "in": "query",
            "schema": {
              "type": "integer"
            },
            "description": "Filter rules applicable to specific schedule"
          }
        ],
        "responses": {
          "200": {
            "description": "Pricing rules list",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "total": {
                      "type": "integer"
                    },
                    "rules": {
                      "type": "array",
                      "items": {
                        "$ref": "#/components/schemas/PricingRule"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/admin/schedules/pricing/rules/{ruleId}": {
      "get": {
        "tags": [
          "Admin - Pricing"
        ],
        "summary": "Get pricing rule details",
        "parameters": [
          {
            "name": "ruleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Rule details"
          },
          "404": {
            "description": "Rule not found"
          }
        }
      },
      "put": {
        "tags": [
          "Admin - Pricing"
        ],
        "summary": "Update pricing rule",
        "parameters": [
          {
            "name": "ruleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "rule_name": {
                    "type": "string"
                  },
                  "conditions": {
                    "type": "object"
                  },
                  "adjustments": {
                    "type": "object"
                  },
                  "priority": {
                    "type": "integer"
                  },
                  "status": {
                    "type": "string",
                    "enum": [
                      "active",
                      "inactive"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rule updated"
          },
          "404": {
            "description": "Rule not found"
          }
        }
      },
      "delete": {
        "tags": [
          "Admin - Pricing"
        ],
        "summary": "Delete pricing rule",
        "parameters": [
          {
            "name": "ruleId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "Rule deleted"
          },
          "404": {
            "description": "Rule not found"
          }
        }
      }
    },
    "/pricing/schedules/calculate": {
      "post": {
        "tags": [
          "Public - Pricing"
        ],
        "summary": "Calculate price for schedule ticket(s)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "schedule_id",
                  "travel_date",
                  "passengers"
                ],
                "properties": {
                  "schedule_id": {
                    "type": "integer"
                  },
                  "travel_date": {
                    "type": "string",
                    "format": "date",
                    "example": "2025-12-01"
                  },
                  "seat_class": {
                    "type": "string",
                    "enum": [
                      "standard",
                      "vip"
                    ],
                    "default": "standard"
                  },
                  "passengers": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": [
                        "passenger_type",
                        "quantity"
                      ],
                      "properties": {
                        "passenger_type": {
                          "type": "string",
                          "enum": [
                            "adult",
                            "child",
                            "senior",
                            "student"
                          ]
                        },
                        "quantity": {
                          "type": "integer",
                          "minimum": 1
                        }
                      }
                    },
                    "example": [
                      {
                        "passenger_type": "adult",
                        "quantity": 2
                      },
                      {
                        "passenger_type": "child",
                        "quantity": 1
                      }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Price calculated",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "schedule_id": {
                      "type": "integer"
                    },
                    "travel_date": {
                      "type": "string"
                    },
                    "seat_class": {
                      "type": "string"
                    },
                    "price_breakdown": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "passenger_type": {
                            "type": "string"
                          },
                          "quantity": {
                            "type": "integer"
                          },
                          "base_price": {
                            "type": "number"
                          },
                          "applied_rules": {
                            "type": "array",
                            "items": {
                              "type": "object",
                              "properties": {
                                "rule_name": {
                                  "type": "string"
                                },
                                "adjustment_type": {
                                  "type": "string"
                                },
                                "adjustment_value": {
                                  "type": "number"
                                },
                                "price_impact": {
                                  "type": "number"
                                }
                              }
                            }
                          },
                          "unit_price": {
                            "type": "number"
                          },
                          "subtotal": {
                            "type": "number"
                          }
                        }
                      }
                    },
                    "total_price": {
                      "type": "number"
                    },
                    "currency": {
                      "type": "string",
                      "default": "HKD"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Schedule not found or no pricing configured"
          }
        }
      }
    },
    "/tickets/{code}/cancel": {
      "post": {
        "tags": [
          "Tickets"
        ],
        "summary": "Cancel ticket and initiate refund",
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "code",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "reason": {
                    "type": "string",
                    "description": "Optional cancellation reason"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Ticket cancelled successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ticket_status": {
                      "type": "string",
                      "enum": [
                        "void"
                      ]
                    },
                    "refund_amount": {
                      "type": "number",
                      "format": "decimal"
                    },
                    "refund_id": {
                      "type": "string"
                    },
                    "cancelled_at": {
                      "type": "string",
                      "format": "date-time"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          },
          "404": {
            "description": "Ticket not found or not owned by user"
          },
          "409": {
            "description": "Ticket cannot be cancelled (already used/expired)"
          }
        }
      }
    },
    "/profile/activity": {
      "get": {
        "tags": [
          "ProfileManagement"
        ],
        "summary": "Get user activity history",
        "description": "Retrieve authenticated user's activity history with filtering and pagination",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "limit",
            "in": "query",
            "description": "Number of activities to return (max 100)",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100,
              "default": 20
            }
          },
          {
            "name": "offset",
            "in": "query",
            "description": "Number of activities to skip for pagination",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 0,
              "default": 0
            }
          },
          {
            "name": "type",
            "in": "query",
            "description": "Filter by activity type",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "profile",
                "order",
                "ticket",
                "login",
                "settings",
                "all"
              ],
              "default": "all"
            }
          },
          {
            "name": "from_date",
            "in": "query",
            "description": "Filter activities from this date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "to_date",
            "in": "query",
            "description": "Filter activities to this date (ISO 8601)",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Activity history retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ActivityHistory"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid query parameters"
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          },
          "422": {
            "description": "Validation failed - invalid date format or parameters"
          }
        }
      }
    },
    "/profile": {
      "get": {
        "tags": [
          "ProfileManagement"
        ],
        "summary": "Get current user's profile information",
        "description": "Retrieve authenticated user's profile data including personal information and preferences",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "Profile information retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserProfile"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          },
          "404": {
            "description": "User profile not found"
          }
        }
      },
      "put": {
        "tags": [
          "ProfileManagement"
        ],
        "summary": "Update user profile information",
        "description": "Update authenticated user's profile details",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 100
                  },
                  "email": {
                    "type": "string",
                    "format": "email"
                  },
                  "preferences": {
                    "type": "object",
                    "properties": {
                      "language": {
                        "type": "string",
                        "enum": [
                          "en",
                          "es",
                          "fr"
                        ]
                      },
                      "timezone": {
                        "type": "string"
                      },
                      "notification_email": {
                        "type": "boolean"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Profile updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserProfile"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid input format"
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          },
          "422": {
            "description": "Validation failed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/profile/settings": {
      "get": {
        "tags": [
          "ProfileManagement"
        ],
        "summary": "Get user settings and preferences",
        "description": "Retrieve authenticated user's settings including notifications, privacy, and display preferences",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "responses": {
          "200": {
            "description": "User settings retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserSettings"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          }
        }
      },
      "put": {
        "tags": [
          "ProfileManagement"
        ],
        "summary": "Update user settings and preferences",
        "description": "Update authenticated user's settings and preferences",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "notification_settings": {
                    "type": "object",
                    "properties": {
                      "email_notifications": {
                        "type": "boolean"
                      },
                      "sms_notifications": {
                        "type": "boolean"
                      },
                      "push_notifications": {
                        "type": "boolean"
                      },
                      "order_updates": {
                        "type": "boolean"
                      },
                      "promotional_emails": {
                        "type": "boolean"
                      }
                    }
                  },
                  "privacy_settings": {
                    "type": "object",
                    "properties": {
                      "profile_visibility": {
                        "type": "string",
                        "enum": [
                          "public",
                          "private"
                        ]
                      },
                      "show_purchase_history": {
                        "type": "boolean"
                      },
                      "data_sharing_consent": {
                        "type": "boolean"
                      }
                    }
                  },
                  "display_preferences": {
                    "type": "object",
                    "properties": {
                      "language": {
                        "type": "string",
                        "enum": [
                          "en",
                          "es",
                          "fr",
                          "de"
                        ]
                      },
                      "timezone": {
                        "type": "string"
                      },
                      "date_format": {
                        "type": "string",
                        "enum": [
                          "MM/DD/YYYY",
                          "DD/MM/YYYY",
                          "YYYY-MM-DD"
                        ]
                      },
                      "currency_display": {
                        "type": "string",
                        "enum": [
                          "USD",
                          "EUR",
                          "GBP",
                          "CAD"
                        ]
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Settings updated successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserSettings"
                }
              }
            }
          },
          "400": {
            "description": "Bad request - invalid input format"
          },
          "401": {
            "description": "Unauthorized - invalid or missing token"
          },
          "422": {
            "description": "Validation failed",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidationError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/wechat/login": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Authenticate WeChat mini-program user via temporary code",
        "description": "Exchanges WeChat temporary code (from wx.login()) for user authentication.\nAutomatically creates new user account on first login.\nReturns JWT token for authenticated API access.\n\nSecurity: ❌ Does NOT store WeChat session_key (security best practice)\n",
        "operationId": "wechatLogin",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "code"
                ],
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "Temporary code from wx.login() (5-minute validity)",
                    "example": "081AbcDEF2GH3jI4KLmN5OP0AbcDEF17",
                    "minLength": 1,
                    "maxLength": 128
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Login successful, JWT token issued",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "token",
                    "user",
                    "needs_phone"
                  ],
                  "properties": {
                    "token": {
                      "type": "string",
                      "description": "JWT token for authenticated API access (7-day validity)",
                      "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                    },
                    "user": {
                      "type": "object",
                      "description": "User profile information",
                      "required": [
                        "user_id",
                        "name",
                        "auth_type",
                        "created_at"
                      ],
                      "properties": {
                        "user_id": {
                          "type": "integer",
                          "description": "Unique user identifier",
                          "example": 123
                        },
                        "name": {
                          "type": "string",
                          "description": "User display name",
                          "example": "WeChat User ABC123"
                        },
                        "avatar_url": {
                          "type": "string",
                          "nullable": true,
                          "description": "User avatar URL",
                          "example": null
                        },
                        "phone": {
                          "type": "string",
                          "nullable": true,
                          "description": "User phone number (if bound)",
                          "example": null
                        },
                        "auth_type": {
                          "type": "string",
                          "enum": [
                            "wechat",
                            "email",
                            "phone"
                          ],
                          "description": "Authentication method",
                          "example": "wechat"
                        },
                        "created_at": {
                          "type": "string",
                          "format": "date-time",
                          "description": "Account creation timestamp",
                          "example": "2025-01-06T10:30:00Z"
                        },
                        "last_login_at": {
                          "type": "string",
                          "format": "date-time",
                          "description": "Last login timestamp",
                          "example": "2025-01-06T10:30:00Z"
                        }
                      }
                    },
                    "needs_phone": {
                      "type": "boolean",
                      "description": "Indicates whether user should be prompted to bind phone number",
                      "example": true
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request (missing or invalid parameters)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INVALID_REQUEST"
                    },
                    "message": {
                      "type": "string",
                      "example": "WeChat code is required"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "WeChat authentication failed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "WECHAT_AUTH_FAILED"
                    },
                    "message": {
                      "type": "string",
                      "example": "WeChat authentication failed"
                    },
                    "details": {
                      "type": "string",
                      "example": "Code2Session API error: invalid code or expired (errcode: 40029)"
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Validation failed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INVALID_CODE"
                    },
                    "message": {
                      "type": "string",
                      "example": "WeChat code is invalid or expired"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INTERNAL_SERVER_ERROR"
                    },
                    "message": {
                      "type": "string",
                      "example": "Login failed due to server error"
                    }
                  }
                }
              }
            }
          }
        },
        "x-code-samples": [
          {
            "lang": "curl",
            "source": "curl -X POST http://localhost:8080/auth/wechat/login \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"code\":\"081AbcDEF2GH3jI4KLmN5OP0AbcDEF17\"}'\n"
          },
          {
            "lang": "JavaScript (Mini-Program)",
            "source": "wx.login({\n  success: (res) => {\n    wx.request({\n      url: 'https://your-api.com/auth/wechat/login',\n      method: 'POST',\n      data: { code: res.code },\n      success: (res) => {\n        wx.setStorageSync('token', res.data.token);\n        console.log('Login successful', res.data.user);\n      }\n    });\n  }\n});\n"
          }
        ]
      }
    },
    "/auth/wechat/phone": {
      "post": {
        "tags": [
          "Authentication"
        ],
        "summary": "Bind user's phone number via WeChat authorization",
        "description": "Binds user's phone number using WeChat's new getPhoneNumber API (2021+).\nNo session_key decryption needed - WeChat API returns plaintext phone number.\n\nSecurity: Requires JWT token (user must be logged in)\n",
        "operationId": "bindWeChatPhone",
        "security": [
          {
            "BearerAuth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "code"
                ],
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "Phone authorization code from WeChat getPhoneNumber button",
                    "example": "021XyZaBcDeF3GH4jI5KLmN6OP7XyZaBc18",
                    "minLength": 1,
                    "maxLength": 128
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Phone number bound successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": [
                    "phone",
                    "user"
                  ],
                  "properties": {
                    "phone": {
                      "type": "string",
                      "description": "Bound phone number (E.164 format)",
                      "example": "+8613800138000"
                    },
                    "user": {
                      "type": "object",
                      "description": "Updated user profile",
                      "required": [
                        "user_id",
                        "name",
                        "phone",
                        "auth_type"
                      ],
                      "properties": {
                        "user_id": {
                          "type": "integer",
                          "example": 123
                        },
                        "name": {
                          "type": "string",
                          "example": "WeChat User ABC123"
                        },
                        "phone": {
                          "type": "string",
                          "example": "+8613800138000"
                        },
                        "avatar_url": {
                          "type": "string",
                          "nullable": true,
                          "example": null
                        },
                        "auth_type": {
                          "type": "string",
                          "example": "wechat"
                        },
                        "updated_at": {
                          "type": "string",
                          "format": "date-time",
                          "example": "2025-01-06T10:45:00Z"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized (no JWT token or invalid token)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "UNAUTHORIZED"
                    },
                    "message": {
                      "type": "string",
                      "example": "Please log in first"
                    }
                  }
                }
              }
            }
          },
          "422": {
            "description": "Invalid phone authorization code",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "INVALID_PHONE_CODE"
                    },
                    "message": {
                      "type": "string",
                      "example": "Phone authorization code is invalid or expired"
                    },
                    "details": {
                      "type": "string",
                      "example": "WeChat API error: errcode 40001 (invalid access_token)"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "string",
                      "example": "PHONE_BINDING_FAILED"
                    },
                    "message": {
                      "type": "string",
                      "example": "Failed to bind phone number"
                    }
                  }
                }
              }
            }
          }
        },
        "x-code-samples": [
          {
            "lang": "curl",
            "source": "curl -X POST http://localhost:8080/auth/wechat/phone \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\" \\\n  -d '{\"code\":\"021XyZaBcDeF3GH4jI5KLmN6OP7XyZaBc18\"}'\n"
          },
          {
            "lang": "JavaScript (Mini-Program)",
            "source": "// In WXML\n<button open-type=\"getPhoneNumber\" bindgetphonenumber=\"getPhoneNumber\">\n  Bind Phone Number\n</button>\n\n// In JS\ngetPhoneNumber(e) {\n  if (e.detail.code) {\n    const token = wx.getStorageSync('token');\n    wx.request({\n      url: 'https://your-api.com/auth/wechat/phone',\n      method: 'POST',\n      data: { code: e.detail.code },\n      header: { 'Authorization': `Bearer ${token}` },\n      success: (res) => {\n        console.log('Phone bound:', res.data.phone);\n        wx.showToast({ title: 'Phone number bound' });\n      },\n      fail: () => {\n        wx.showToast({ title: 'Binding failed', icon: 'error' });\n      }\n    });\n  } else {\n    console.log('User refused phone authorization');\n  }\n}\n"
          }
        ]
      }
    }
  },
  "components": {
    "schemas": {
      "OrderResponse": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "order_no": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "confirmed",
              "in_progress",
              "completed",
              "cancelled",
              "refunded"
            ]
          },
          "product_id": {
            "type": "integer"
          },
          "product_name": {
            "type": "string"
          },
          "travel_date": {
            "type": "string",
            "format": "date"
          },
          "quantity": {
            "type": "integer"
          },
          "total": {
            "type": "number"
          },
          "pricing_context": {
            "$ref": "#/components/schemas/PricingContext"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "PricingContext": {
        "type": "object",
        "properties": {
          "travel_date": {
            "type": "string"
          },
          "is_weekend": {
            "type": "boolean"
          },
          "customer_breakdown": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "customer_type": {
                  "type": "string"
                },
                "count": {
                  "type": "integer"
                },
                "unit_price": {
                  "type": "number"
                },
                "total": {
                  "type": "number"
                }
              }
            }
          },
          "addons": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "addon_id": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "quantity": {
                  "type": "integer"
                },
                "unit_price": {
                  "type": "number"
                },
                "total": {
                  "type": "number"
                }
              }
            }
          },
          "subtotal": {
            "type": "number"
          },
          "addons_total": {
            "type": "number"
          }
        }
      },
      "OrderListItem": {
        "type": "object",
        "properties": {
          "order_id": {
            "type": "integer"
          },
          "order_no": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "product_id": {
            "type": "integer"
          },
          "product_name": {
            "type": "string"
          },
          "travel_date": {
            "type": "string"
          },
          "quantity": {
            "type": "integer"
          },
          "total": {
            "type": "number"
          },
          "created_at": {
            "type": "string"
          },
          "paid_at": {
            "type": "string"
          }
        }
      },
      "OrderDetailResponse": {
        "allOf": [
          {
            "$ref": "#/components/schemas/OrderResponse"
          },
          {
            "type": "object",
            "properties": {
              "paid_at": {
                "type": "string"
              },
              "tickets": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "ticket_id": {
                      "type": "integer"
                    },
                    "ticket_code": {
                      "type": "string"
                    },
                    "customer_type": {
                      "type": "string"
                    },
                    "status": {
                      "type": "string"
                    },
                    "qr_code": {
                      "type": "string"
                    },
                    "entitlements": {
                      "type": "array",
                      "description": "票券权益（与OTA票券结构一致）",
                      "items": {
                        "type": "object",
                        "properties": {
                          "function_code": {
                            "type": "string",
                            "description": "权益代码（ferry, playground_tokens等）"
                          },
                          "remaining_uses": {
                            "type": "integer",
                            "description": "剩余使用次数"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        ]
      },
      "TicketQRResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "qr_image": {
            "type": "string",
            "description": "Base64 编码的二维码图片"
          },
          "encrypted_data": {
            "type": "string",
            "description": "加密的票券数据"
          },
          "ticket_code": {
            "type": "string",
            "description": "票券编码"
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "description": "二维码过期时间"
          },
          "valid_for_seconds": {
            "type": "integer",
            "description": "二维码有效秒数"
          },
          "issued_at": {
            "type": "string",
            "format": "date-time",
            "description": "二维码签发时间"
          },
          "jti": {
            "type": "string",
            "description": "二维码唯一标识（用于失效旧码）"
          }
        }
      },
      "MiniprogramUserProfile": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "nickname": {
            "type": "string",
            "description": "From wechat_extra.nickname"
          },
          "phone": {
            "type": "string",
            "description": "Bound phone number"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ChannelReservation": {
        "type": "object",
        "properties": {
          "reservation_id": {
            "type": "string",
            "example": "res_mhksku1s_lj1nqt"
          },
          "product_id": {
            "type": "integer",
            "example": 106
          },
          "quantity": {
            "type": "integer",
            "example": 5
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "expired",
              "activated",
              "cancelled"
            ]
          },
          "expires_at": {
            "type": "string",
            "format": "date-time",
            "example": "2025-11-05T16:37:14.000Z"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "example": "2025-11-04T08:37:14.759Z"
          },
          "order_id": {
            "type": "integer",
            "nullable": true,
            "description": "Set when reservation is activated"
          }
        }
      },
      "PromotionDetail": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "sku": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "unit_price": {
            "type": "number",
            "format": "decimal"
          },
          "status": {
            "type": "string",
            "enum": [
              "draft",
              "active",
              "archived"
            ]
          },
          "sale_start_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "sale_end_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          },
          "functions": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/FunctionSpec"
            }
          },
          "inventory": {
            "type": "object",
            "properties": {
              "sellable_cap": {
                "type": "integer"
              },
              "reserved_count": {
                "type": "integer"
              },
              "sold_count": {
                "type": "integer"
              },
              "available": {
                "type": "integer"
              }
            }
          },
          "features": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "images": {
            "type": "array",
            "items": {
              "type": "string",
              "format": "uri"
            }
          }
        }
      },
      "ReservationSlot": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 10
          },
          "date": {
            "type": "string",
            "format": "date",
            "example": "2025-11-14"
          },
          "start_time": {
            "type": "string",
            "format": "time",
            "example": "12:00:00"
          },
          "end_time": {
            "type": "string",
            "format": "time",
            "example": "14:00:00"
          },
          "venue_id": {
            "type": "integer",
            "nullable": true,
            "example": null
          },
          "total_capacity": {
            "type": "integer",
            "example": 200,
            "description": "Maximum reservations allowed"
          },
          "booked_count": {
            "type": "integer",
            "example": 150,
            "description": "Current number of reservations"
          },
          "available_count": {
            "type": "integer",
            "example": 50,
            "description": "Remaining capacity (computed)"
          },
          "status": {
            "type": "string",
            "enum": [
              "ACTIVE",
              "FULL",
              "CLOSED"
            ],
            "example": "ACTIVE"
          },
          "capacity_status": {
            "type": "string",
            "enum": [
              "AVAILABLE",
              "LIMITED",
              "FULL"
            ],
            "example": "LIMITED",
            "description": "UI indicator: AVAILABLE (>50%), LIMITED (10-50%), FULL (0%)"
          },
          "orq": {
            "type": "integer",
            "example": 1
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Route": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "name": {
            "type": "string"
          },
          "origin": {
            "type": "string"
          },
          "destination": {
            "type": "string"
          },
          "route_type": {
            "type": "string",
            "enum": [
              "ferry",
              "bus",
              "train"
            ]
          },
          "operator_id": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "duration_minutes": {
            "type": "integer"
          },
          "distance_km": {
            "type": "number"
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "inactive"
            ]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Schedule": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "route_id": {
            "type": "integer"
          },
          "departure_time": {
            "type": "string",
            "format": "time"
          },
          "arrival_time": {
            "type": "string",
            "format": "time"
          },
          "weekdays": {
            "type": "array",
            "items": {
              "type": "integer"
            }
          },
          "seat_classes": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "class_type": {
                  "type": "string"
                },
                "capacity": {
                  "type": "integer"
                },
                "base_price": {
                  "type": "number"
                }
              }
            }
          },
          "status": {
            "type": "string",
            "enum": [
              "active",
              "suspended"
            ]
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "PricingRule": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer"
          },
          "rule_name": {
            "type": "string"
          },
          "rule_type": {
            "type": "string"
          },
          "applies_to": {
            "type": "object"
          },
          "conditions": {
            "type": "object"
          },
          "adjustments": {
            "type": "object"
          },
          "priority": {
            "type": "integer"
          },
          "status": {
            "type": "string"
          },
          "effective_from": {
            "type": "string",
            "format": "date-time"
          },
          "effective_until": {
            "type": "string",
            "format": "date-time"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "ActivityHistory": {
        "type": "object",
        "properties": {
          "activities": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ActivityEntry"
            }
          },
          "total": {
            "type": "integer",
            "description": "Total number of activities matching filters"
          },
          "pagination": {
            "type": "object",
            "properties": {
              "limit": {
                "type": "integer"
              },
              "offset": {
                "type": "integer"
              },
              "has_more": {
                "type": "boolean"
              }
            }
          }
        }
      },
      "ActivityEntry": {
        "type": "object",
        "properties": {
          "activity_id": {
            "type": "string"
          },
          "type": {
            "type": "string",
            "enum": [
              "profile",
              "order",
              "ticket",
              "login",
              "settings"
            ]
          },
          "action": {
            "type": "string",
            "description": "Specific action taken (e.g., profile_updated, order_created)"
          },
          "description": {
            "type": "string",
            "description": "Human-readable description of the activity"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "metadata": {
            "type": "object",
            "description": "Additional context data for the activity",
            "properties": {
              "ip_address": {
                "type": "string"
              },
              "user_agent": {
                "type": "string"
              },
              "resource_id": {
                "type": "string"
              },
              "changes": {
                "type": "object"
              }
            }
          },
          "severity": {
            "type": "string",
            "enum": [
              "info",
              "warning",
              "critical"
            ],
            "description": "Importance level of the activity"
          }
        }
      },
      "UserProfile": {
        "type": "object",
        "properties": {
          "user_id": {
            "type": "string"
          },
          "name": {
            "type": "string"
          },
          "email": {
            "type": "string",
            "format": "email"
          },
          "preferences": {
            "type": "object",
            "properties": {
              "language": {
                "type": "string"
              },
              "timezone": {
                "type": "string"
              },
              "notification_email": {
                "type": "boolean"
              }
            }
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "UserSettings": {
        "type": "object",
        "properties": {
          "notification_settings": {
            "type": "object",
            "properties": {
              "email_notifications": {
                "type": "boolean"
              },
              "sms_notifications": {
                "type": "boolean"
              },
              "push_notifications": {
                "type": "boolean"
              },
              "order_updates": {
                "type": "boolean"
              },
              "promotional_emails": {
                "type": "boolean"
              }
            }
          },
          "privacy_settings": {
            "type": "object",
            "properties": {
              "profile_visibility": {
                "type": "string",
                "enum": [
                  "public",
                  "private"
                ]
              },
              "show_purchase_history": {
                "type": "boolean"
              },
              "data_sharing_consent": {
                "type": "boolean"
              }
            }
          },
          "display_preferences": {
            "type": "object",
            "properties": {
              "language": {
                "type": "string",
                "enum": [
                  "en",
                  "es",
                  "fr",
                  "de"
                ]
              },
              "timezone": {
                "type": "string"
              },
              "date_format": {
                "type": "string",
                "enum": [
                  "MM/DD/YYYY",
                  "DD/MM/YYYY",
                  "YYYY-MM-DD"
                ]
              },
              "currency_display": {
                "type": "string",
                "enum": [
                  "USD",
                  "EUR",
                  "GBP",
                  "CAD"
                ]
              }
            }
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT token for authenticated API access"
      },
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key",
        "description": "API key for B2B integrations"
      }
    }
  }
}