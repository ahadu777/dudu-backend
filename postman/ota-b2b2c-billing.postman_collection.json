{
  "info": {
    "name": "OTA B2B2C Billing - E2E Tests",
    "description": "Complete end-to-end testing for B2B2C reseller billing workflow",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "api_key",
      "value": "ota_test_key_12345",
      "type": "string"
    },
    {
      "key": "batch_id",
      "value": "NEWMAN_TEST_{{$timestamp}}",
      "type": "string"
    },
    {
      "key": "ticket_code",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Health Check",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Server is healthy', function() {",
              "    pm.response.to.have.status(200);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/healthz",
          "host": ["{{base_url}}"],
          "path": ["healthz"]
        }
      }
    },
    {
      "name": "Generate B2B2C Reseller Batch",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Bulk generation successful', function() {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "pm.test('Response has required fields', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('batch_id');",
              "    pm.expect(json).to.have.property('tickets');",
              "    pm.expect(json).to.have.property('total_generated');",
              "    pm.expect(json.total_generated).to.equal(5);",
              "});",
              "",
              "pm.test('Pricing snapshot captured', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('pricing_snapshot');",
              "    pm.expect(json.pricing_snapshot).to.have.property('base_price');",
              "    pm.expect(json.pricing_snapshot).to.have.property('currency');",
              "});",
              "",
              "pm.test('Reseller metadata preserved', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('reseller_metadata');",
              "    pm.expect(json.reseller_metadata.intended_reseller).to.equal('Newman Test Reseller');",
              "});",
              "",
              "pm.test('Tickets have valid structure', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json.tickets).to.be.an('array');",
              "    pm.expect(json.tickets[0]).to.have.property('ticket_code');",
              "    pm.expect(json.tickets[0]).to.have.property('qr_code');",
              "    pm.expect(json.tickets[0]).to.have.property('entitlements');",
              "    pm.expect(json.tickets[0].status).to.equal('PRE_GENERATED');",
              "});",
              "",
              "// Store first ticket code for activation test",
              "if (pm.response.code === 201) {",
              "    const json = pm.response.json();",
              "    pm.collectionVariables.set('ticket_code', json.tickets[0].ticket_code);",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "X-API-Key",
            "value": "{{api_key}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"batch_id\": \"{{batch_id}}\",\n  \"partner_id\": \"test_partner\",\n  \"product_id\": 106,\n  \"quantity\": 5,\n  \"distribution_mode\": \"reseller_batch\",\n  \"reseller_metadata\": {\n    \"intended_reseller\": \"Newman Test Reseller\",\n    \"commission_rate\": 0.20,\n    \"markup_percentage\": 0.35,\n    \"payment_terms\": \"net_30\",\n    \"auto_invoice\": true,\n    \"billing_contact\": \"billing@newmantest.com\"\n  },\n  \"batch_metadata\": {\n    \"campaign_type\": \"early_bird\",\n    \"campaign_name\": \"Newman E2E Test Campaign\",\n    \"promotion_code\": \"NEWMAN2024\",\n    \"target_demographic\": \"test_users\",\n    \"geographic_focus\": \"Test Region\"\n  }\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "tickets", "bulk-generate"]
        }
      }
    },
    {
      "name": "Activate Pre-Generated Ticket",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Activation successful', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Activation response valid', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('ticket_code');",
              "    pm.expect(json).to.have.property('order_id');",
              "    pm.expect(json).to.have.property('status');",
              "    pm.expect(json.status).to.equal('ACTIVE');",
              "});",
              "",
              "pm.test('Customer details preserved', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('customer_name');",
              "    pm.expect(json.customer_name).to.equal('Newman Test User');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "X-API-Key",
            "value": "{{api_key}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"customer_details\": {\n    \"name\": \"Newman Test User\",\n    \"email\": \"newman.test@example.com\",\n    \"phone\": \"+1234567890\"\n  },\n  \"payment_reference\": \"PAY-NEWMAN-{{$timestamp}}\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/ota/tickets/{{ticket_code}}/activate",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "tickets", "{{ticket_code}}", "activate"]
        }
      }
    },
    {
      "name": "Test API Key Required",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('API key required error', function() {",
              "    pm.response.to.have.status(401);",
              "});",
              "",
              "pm.test('Error message correct', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json.error).to.equal('API_KEY_REQUIRED');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"batch_id\": \"SHOULD_FAIL\",\n  \"product_id\": 106,\n  \"quantity\": 1\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "tickets", "bulk-generate"]
        }
      }
    },
    {
      "name": "Test Missing Intended Reseller",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Validation error for missing intended_reseller', function() {",
              "    pm.response.to.have.status(400);",
              "});",
              "",
              "pm.test('Error message mentions intended_reseller', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json.message).to.include('intended_reseller');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "X-API-Key",
            "value": "{{api_key}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"batch_id\": \"VALIDATION_TEST_{{$timestamp}}\",\n  \"product_id\": 106,\n  \"quantity\": 1,\n  \"distribution_mode\": \"reseller_batch\",\n  \"reseller_metadata\": {\n    \"commission_rate\": 0.15\n  }\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "tickets", "bulk-generate"]
        }
      }
    }
  ]
}