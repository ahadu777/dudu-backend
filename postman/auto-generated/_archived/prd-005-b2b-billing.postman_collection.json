{
  "info": {
    "_postman_id": "prd-005-b2b-billing-collection",
    "name": "PRD-005 B2B Billing & Analytics Tests",
    "description": "Tests for PRD-005 - B2B Billing & Analytics. Tests reseller management, billing summary, and batch analytics.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "ota_api_key",
      "value": "ota_full_access_key_99999",
      "type": "string"
    },
    {
      "key": "batch_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "reseller_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "5.1 Query Resellers List",
      "description": "财务人员查看所有分销商列表，了解合作伙伴基本信息",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/ota/resellers",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "resellers"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Returns paginated resellers', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('items');",
              "    pm.expect(data.items).to.be.an('array');",
              "    pm.expect(data).to.have.property('total');",
              "});",
              "",
              "pm.test('Save first reseller ID if available', function () {",
              "    const data = pm.response.json();",
              "    if (data.items && data.items.length > 0) {",
              "        pm.collectionVariables.set('reseller_id', data.items[0].id);",
              "    }",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "5.2 Bulk Generate Tickets for Billing",
      "description": "分销商批量采购票券，系统记录交易用于后续账单生成",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"product_id\": 106,\n  \"quantity\": 3,\n  \"distribution_mode\": \"direct_sale\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "tickets", "bulk-generate"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 201', function () {",
              "    pm.response.to.have.status(201);",
              "});",
              "",
              "pm.test('Returns batch ID', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('batch_id');",
              "    pm.collectionVariables.set('batch_id', data.batch_id);",
              "});",
              "",
              "pm.test('Returns tickets array', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('tickets');",
              "    pm.expect(data.tickets).to.be.an('array');",
              "    pm.expect(data.tickets.length).to.equal(3);",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "5.3 Query Batches List",
      "description": "财务人员查看所有票券批次记录，用于对账和审计",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/ota/batches",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "batches"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Returns paginated batches', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('items');",
              "    pm.expect(data.items).to.be.an('array');",
              "    pm.expect(data).to.have.property('total');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "5.4 Batch Analytics",
      "description": "运营人员查看批次销售分析：激活率、核销率、转化漏斗",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/ota/batches/{{batch_id}}/analytics",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "batches", "{{batch_id}}", "analytics"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Has analytics data', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('batch_id');",
              "    pm.expect(data).to.have.property('tickets_generated');",
              "    pm.expect(data).to.have.property('tickets_activated');",
              "    pm.expect(data).to.have.property('conversion_rates');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "5.5 Billing Summary",
      "description": "财务人员生成月度账单汇总，按分销商统计应收款项",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/ota/billing/summary?period=2025-12",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "billing", "summary"],
          "query": [
            {
              "key": "period",
              "value": "2025-12"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Has billing data', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('billing_period');",
              "    pm.expect(data).to.have.property('reseller_summaries');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "5.6 OTA Inventory Check",
      "description": "分销商下单前查询商品库存和定价，确保有足够配额",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "X-API-Key",
            "value": "{{ota_api_key}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/ota/inventory?product_ids=106,107",
          "host": ["{{base_url}}"],
          "path": ["api", "ota", "inventory"],
          "query": [
            {
              "key": "product_ids",
              "value": "106,107"
            }
          ]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Has inventory data', function () {",
              "    const data = pm.response.json();",
              "    pm.expect(data).to.have.property('available_quantities');",
              "    pm.expect(data).to.have.property('pricing_context');",
              "    pm.expect(data).to.have.property('product_info');",
              "});"
            ],
            "type": "text/javascript"
          }
        }
      ]
    }
  ],
  "event": []
}
