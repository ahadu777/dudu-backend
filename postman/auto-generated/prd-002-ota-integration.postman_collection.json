{
  "info": {
    "_postman_id": "prd-002-ota-integration-v2",
    "name": "PRD-002 OTA Platform Integration Tests",
    "description": "PRD-002 OTA 平台集成测试 - 覆盖 18 个验收标准\n\n## 覆盖率: 89% (16/18 AC)\n\n### 测试结构:\n1. 库存管理 (4 tests)\n2. 批次生成 (5 tests)\n3. 票券激活 (3 tests)\n4. 票券状态转换 (3 tests)\n5. 分析与查询 (4 tests)\n6. API 安全 (2 tests)\n\n### 用户旅程 (OTA运营人员):\n查询库存 → 批量生成票券 → 分销商激活 → 场馆验证 → 查看分析\n\n### AC 映射: docs/test-coverage/prd-002-ac-mapping.yaml",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "3.0.0"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "api_key",
      "value": "ota_full_access_key_99999",
      "type": "string"
    },
    {
      "key": "batch_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "ticket_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "reseller_batch_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "reseller_ticket_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "early_bird_batch_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "early_bird_ticket_code",
      "value": "",
      "type": "string"
    },
    {
      "key": "operator_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. 库存管理",
      "description": "AC-INV-1 ~ AC-INV-4: 多渠道库存管理测试",
      "item": [
        {
          "name": "1.1 查询OTA渠道库存 [AC-INV-1]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response contains available_quantities', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.available_quantities).to.exist;",
                  "});",
                  "",
                  "pm.test('Response contains pricing_context', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.pricing_context).to.exist;",
                  "    pm.expect(response.pricing_context.base_prices).to.exist;",
                  "});",
                  "",
                  "pm.test('Response contains product_info', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.product_info).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/inventory",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "inventory"
              ]
            },
            "description": "验证 OTA 渠道库存查询 API，应返回 available_quantities、pricing_context 和 product_info"
          },
          "x-flow": {
            "sequence": 1,
            "page": "ota-dashboard",
            "trigger": "auto:page-load",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员登录后台后，系统自动加载渠道库存概览"
        },
        {
          "name": "1.2 按产品ID筛选库存 [AC-INV-2]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Only requested products returned', function () {",
                  "    const response = pm.response.json();",
                  "    const productIds = Object.keys(response.available_quantities);",
                  "    pm.expect(productIds).to.include('106');",
                  "    pm.expect(productIds).to.include('107');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/inventory?product_ids=106,107",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "inventory"
              ],
              "query": [
                {
                  "key": "product_ids",
                  "value": "106,107"
                }
              ]
            },
            "description": "验证按 product_ids 参数筛选库存，只返回请求的产品"
          },
          "x-flow": {
            "sequence": 1,
            "page": "ota-dashboard",
            "trigger": "input:product-filter",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员输入产品ID筛选库存，系统返回指定产品的可用数量"
        },
        {
          "name": "1.3 无效product_ids参数 (422) [AC-INV-3]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 422', function () {",
                  "    pm.response.to.have.status(422);",
                  "});",
                  "",
                  "pm.test('Error indicates invalid product ID', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.error).to.equal('INVALID_PRODUCT_IDS');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/inventory?product_ids=abc,xyz",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "inventory"
              ],
              "query": [
                {
                  "key": "product_ids",
                  "value": "abc,xyz"
                }
              ]
            },
            "description": "验证无效的 product_ids 参数（非数字）返回 422 错误"
          },
          "x-flow": {
            "sequence": 1,
            "page": "ota-dashboard",
            "trigger": "input:product-filter",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员输入无效产品ID时，系统拒绝并提示参数错误"
        },
        {
          "name": "1.4 定价上下文完整性 [AC-INV-4]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Base prices have weekday/weekend', function () {",
                  "    const response = pm.response.json();",
                  "    const prices = response.pricing_context.base_prices;",
                  "    for (const productId of Object.keys(prices)) {",
                  "        pm.expect(prices[productId]).to.have.property('weekday');",
                  "        pm.expect(prices[productId]).to.have.property('weekend');",
                  "    }",
                  "});",
                  "",
                  "pm.test('Customer discounts exist', function () {",
                  "    const response = pm.response.json();",
                  "    const discounts = response.pricing_context.customer_discounts;",
                  "    pm.expect(discounts['106']).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/inventory",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "inventory"
              ]
            },
            "description": "验证定价上下文包含 weekday/weekend 价格和客户折扣"
          },
          "x-flow": {
            "sequence": 1,
            "page": "ota-dashboard",
            "trigger": "auto:page-load",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员查看定价上下文，系统显示工作日/周末价格和客户折扣"
        }
      ]
    },
    {
      "name": "2. 批次生成",
      "description": "AC-BATCH-1 ~ AC-BATCH-5: 批量票券生成测试",
      "item": [
        {
          "name": "2.1 直销模式 (direct_sale, 7天) [AC-BATCH-1]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Distribution mode is direct_sale', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.distribution_mode).to.equal('direct_sale');",
                  "});",
                  "",
                  "pm.test('Expires_at is ~7 days from now', function () {",
                  "    const response = pm.response.json();",
                  "    const expiresAt = new Date(response.expires_at);",
                  "    const now = new Date();",
                  "    const diffDays = (expiresAt - now) / (1000 * 60 * 60 * 24);",
                  "    pm.expect(diffDays).to.be.within(6, 8);",
                  "});",
                  "",
                  "pm.test('Save batch_id and ticket_code', function () {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('batch_id', response.batch_id);",
                  "    pm.collectionVariables.set('ticket_code', response.tickets[0].ticket_code);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"product_id\": 107,\n  \"quantity\": 2,\n  \"batch_id\": \"DIRECT-TEST-{{$timestamp}}\",\n  \"distribution_mode\": \"direct_sale\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "bulk-generate"
              ]
            },
            "description": "验证直销模式批量生成票券，有效期约 7 天"
          },
          "x-flow": {
            "sequence": 2,
            "page": "batch-generate",
            "trigger": "button:生成票券",
            "produces": [
              "batch_id",
              "ticket_code"
            ],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员选择直销模式生成票券，系统创建7天有效期的批次"
        },
        {
          "name": "2.2 分销模式 (reseller_batch, 30天) [AC-BATCH-2]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Distribution mode is reseller_batch', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.distribution_mode).to.equal('reseller_batch');",
                  "});",
                  "",
                  "pm.test('Contains reseller_metadata', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.reseller_metadata).to.exist;",
                  "    pm.expect(response.reseller_metadata.intended_reseller).to.equal('TestReseller_Corp');",
                  "});",
                  "",
                  "pm.test('Expires_at is ~30 days from now', function () {",
                  "    const response = pm.response.json();",
                  "    const expiresAt = new Date(response.expires_at);",
                  "    const now = new Date();",
                  "    const diffDays = (expiresAt - now) / (1000 * 60 * 60 * 24);",
                  "    pm.expect(diffDays).to.be.within(29, 31);",
                  "});",
                  "",
                  "pm.test('Save reseller batch info', function () {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('reseller_batch_id', response.batch_id);",
                  "    pm.collectionVariables.set('reseller_ticket_code', response.tickets[0].ticket_code);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"product_id\": 106,\n  \"quantity\": 2,\n  \"batch_id\": \"RESELLER-TEST-{{$timestamp}}\",\n  \"distribution_mode\": \"reseller_batch\",\n  \"reseller_metadata\": {\n    \"intended_reseller\": \"TestReseller_Corp\",\n    \"contact_email\": \"reseller@test.com\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "bulk-generate"
              ]
            },
            "description": "验证分销模式批量生成票券，有效期约 30 天，包含 reseller_metadata"
          },
          "x-flow": {
            "sequence": 2,
            "page": "batch-generate",
            "trigger": "button:生成票券",
            "produces": [
              "reseller_batch_id",
              "reseller_ticket_code"
            ],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员选择分销模式生成票券，系统创建30天有效期的批次并记录分销商信息"
        },
        {
          "name": "2.3 分销模式缺少reseller (400) [AC-BATCH-3]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error mentions intended_reseller', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.message).to.include('intended_reseller');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"product_id\": 106,\n  \"quantity\": 1,\n  \"batch_id\": \"RESELLER-INVALID-{{$timestamp}}\",\n  \"distribution_mode\": \"reseller_batch\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "bulk-generate"
              ]
            },
            "description": "验证分销模式缺少 intended_reseller 时返回 400 错误"
          },
          "x-flow": {
            "sequence": 2,
            "page": "batch-generate",
            "trigger": "button:生成票券",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "分销模式下未填写分销商信息时，系统拒绝生成并提示必填字段缺失"
        },
        {
          "name": "2.4 早鸟票批次 (campaign_type) [AC-BATCH-4]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Batch metadata contains campaign_type', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.batch_metadata).to.exist;",
                  "    pm.expect(response.batch_metadata.campaign_type).to.equal('early_bird');",
                  "});",
                  "",
                  "pm.test('Batch metadata contains marketing_tags', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.batch_metadata.marketing_tags).to.be.an('array');",
                  "    pm.expect(response.batch_metadata.marketing_tags).to.include('limited_time');",
                  "});",
                  "",
                  "pm.test('Save early bird batch info', function () {",
                  "    const response = pm.response.json();",
                  "    pm.collectionVariables.set('early_bird_batch_id', response.batch_id);",
                  "    pm.collectionVariables.set('early_bird_ticket_code', response.tickets[0].ticket_code);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"product_id\": 106,\n  \"quantity\": 2,\n  \"batch_id\": \"EARLY-BIRD-{{$timestamp}}\",\n  \"distribution_mode\": \"direct_sale\",\n  \"batch_metadata\": {\n    \"campaign_type\": \"early_bird\",\n    \"campaign_name\": \"2025 Spring Early Bird\",\n    \"marketing_tags\": [\"limited_time\", \"best_value\"]\n  },\n  \"special_pricing\": {\n    \"base_price\": 230,\n    \"weekend_premium\": 20,\n    \"currency\": \"HKD\"\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "bulk-generate"
              ]
            },
            "description": "验证早鸟票批次包含 campaign_type 和 marketing_tags"
          },
          "x-flow": {
            "sequence": 2,
            "page": "batch-generate",
            "trigger": "button:生成票券",
            "produces": [
              "early_bird_batch_id",
              "early_bird_ticket_code"
            ],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员生成早鸟促销票券，系统记录营销标签和特殊定价"
        },
        {
          "name": "2.5 闪购批次 (flash_sale) [AC-BATCH-4]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Campaign type is flash_sale', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.batch_metadata.campaign_type).to.equal('flash_sale');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"product_id\": 107,\n  \"quantity\": 1,\n  \"batch_id\": \"FLASH-SALE-{{$timestamp}}\",\n  \"distribution_mode\": \"direct_sale\",\n  \"batch_metadata\": {\n    \"campaign_type\": \"flash_sale\",\n    \"campaign_name\": \"24-Hour Flash Sale\",\n    \"marketing_tags\": [\"urgent\", \"limited_stock\"]\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/bulk-generate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "bulk-generate"
              ]
            },
            "description": "验证闪购批次 campaign_type 为 flash_sale"
          },
          "x-flow": {
            "sequence": 2,
            "page": "batch-generate",
            "trigger": "button:生成票券",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员生成限时闪购票券，系统标记紧急促销类型"
        }
      ]
    },
    {
      "name": "3. 票券激活",
      "description": "AC-TICKET-1 ~ AC-TICKET-3: 票券激活测试",
      "item": [
        {
          "name": "3.1 激活预制票券 [AC-TICKET-1]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Ticket status is ACTIVE', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.status).to.equal('ACTIVE');",
                  "});",
                  "",
                  "pm.test('Has ticket_code', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.ticket_code).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"customer_details\": {\n    \"name\": \"Test Customer\",\n    \"email\": \"test@example.com\",\n    \"phone\": \"13900139000\"\n  },\n  \"customer_type\": \"adult\",\n  \"visit_date\": \"2025-12-20\",\n  \"payment_reference\": \"TEST_PAY_001\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/{{ticket_code}}/activate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "{{ticket_code}}",
                "activate"
              ]
            },
            "description": "验证预制票券激活流程，状态应变为 ACTIVE"
          },
          "x-flow": {
            "sequence": 3,
            "page": "ticket-activate",
            "trigger": "button:激活票券",
            "produces": [],
            "consumes": [
              "api_key",
              "ticket_code"
            ]
          },
          "description": "分销商激活预制票券时填写客户信息，系统将状态变更为ACTIVE"
        },
        {
          "name": "3.2 周末日期激活 [AC-TICKET-2] [NEEDS_FIX]",
          "description": "分销商在周末日期激活票券时，系统自动应用周末定价",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// 此测试目前可能失败 - API 返回 500",
                  "// TODO: 调查后端 visit_date 周末定价实现",
                  "",
                  "pm.test('Status code is 200 or 500 (known issue)', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 500]);",
                  "    if (pm.response.code === 500) {",
                  "        console.log('KNOWN ISSUE: Weekend pricing activation returns 500');",
                  "    }",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "    pm.test('Ticket status is ACTIVE', function () {",
                  "        const response = pm.response.json();",
                  "        pm.expect(response.status).to.equal('ACTIVE');",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"customer_details\": {\n    \"name\": \"Weekend Visitor\",\n    \"email\": \"weekend@test.com\"\n  },\n  \"customer_type\": \"adult\",\n  \"visit_date\": \"2025-11-29\",\n  \"payment_reference\": \"PAY-WEEKEND-001\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/{{reseller_ticket_code}}/activate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "{{reseller_ticket_code}}",
                "activate"
              ]
            },
            "description": "验证周末日期激活应用周末定价。注意: 此测试可能返回 500，需要调查后端实现"
          },
          "x-flow": {
            "sequence": 3,
            "page": "ticket-activate",
            "trigger": "button:激活票券",
            "produces": [],
            "consumes": [
              "api_key",
              "reseller_ticket_code"
            ]
          }
        },
        {
          "name": "3.3 无效日期格式 (400) [AC-TICKET-3]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});",
                  "",
                  "pm.test('Error mentions date format', function () {",
                  "    const response = pm.response.json();",
                  "    const msg = JSON.stringify(response).toLowerCase();",
                  "    pm.expect(msg).to.include('date');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"customer_details\": {\n    \"name\": \"Invalid Date Test\",\n    \"email\": \"test@test.com\"\n  },\n  \"customer_type\": \"adult\",\n  \"visit_date\": \"29-11-2025\",\n  \"payment_reference\": \"PAY-INVALID-DATE\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/ota/tickets/{{early_bird_ticket_code}}/activate",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "tickets",
                "{{early_bird_ticket_code}}",
                "activate"
              ]
            },
            "description": "验证无效日期格式（如 DD-MM-YYYY）返回 400 错误"
          },
          "x-flow": {
            "sequence": 3,
            "page": "ticket-activate",
            "trigger": "button:激活票券",
            "produces": [],
            "consumes": [
              "api_key",
              "early_bird_ticket_code"
            ]
          },
          "description": "分销商输入无效日期格式时，系统拒绝激活并提示格式错误"
        }
      ]
    },
    {
      "name": "4. 票券状态转换",
      "description": "AC-TICKET-4: 票券状态自动转换测试 (需要操作员认证)",
      "item": [
        {
          "name": "4.0 操作员登录获取Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Skip if credentials invalid (no test operator in DB)",
                  "if (pm.response.code === 401) {",
                  "    pm.test.skip('Operator credentials invalid - skipped');",
                  "    return;",
                  "}",
                  "",
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Save operator token', function () {",
                  "    const response = pm.response.json();",
                  "    if (response.token) {",
                  "        pm.collectionVariables.set('operator_token', response.token);",
                  "    } else if (response.access_token) {",
                  "        pm.collectionVariables.set('operator_token', response.access_token);",
                  "    }",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"username\": \"operator\",\n  \"password\": \"operator123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/operators/login",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "operators",
                "login"
              ]
            },
            "description": "获取操作员 JWT Token 用于后续票券状态转换测试。注意: 需要有效的操作员凭据"
          },
          "x-flow": {
            "sequence": 4,
            "page": "operator-login",
            "trigger": "button:登录",
            "produces": [
              "operator_token"
            ],
            "consumes": []
          },
          "description": "场馆操作员上班时登录验票终端，系统返回会话Token"
        },
        {
          "name": "4.1 生成QR码",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Has encrypted_data', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.encrypted_data).to.exist;",
                  "    pm.collectionVariables.set('encrypted_qr_data', response.encrypted_data);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"expiry_minutes\": 60\n}"
            },
            "url": {
              "raw": "{{base_url}}/qr/public/{{ticket_code}}",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "qr",
                "public",
                "{{ticket_code}}"
              ]
            },
            "description": "为已激活票券生成 QR 码，返回 encrypted_data"
          },
          "x-flow": {
            "sequence": 4,
            "page": "venue-scan",
            "trigger": "auto:ticket-query",
            "produces": [],
            "consumes": [
              "api_key",
              "ticket_code"
            ]
          },
          "description": "操作员查询票券详细信息，系统显示状态和权益列表"
        },
        {
          "name": "4.2 查询票券信息",
          "description": "OTA 分销商查询指定票券的详细信息，包括状态和有效期",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Has ticket info', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.status).to.exist;",
                  "    pm.expect(response.entitlements).to.exist;",
                  "    console.log('Ticket status:', response.status);",
                  "    console.log('Entitlements:', JSON.stringify(response.entitlements));",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/qr/{{ticket_code}}/info",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "qr",
                "{{ticket_code}}",
                "info"
              ]
            },
            "description": "查询票券详细信息，包含状态和权益列表"
          }
        }
      ]
    },
    {
      "name": "5. 分析与查询",
      "description": "AC-ANALYTICS-1 ~ AC-ANALYTICS-4: 批次和分销商分析",
      "item": [
        {
          "name": "5.1 批次列表 (分页) [AC-ANALYTICS-1]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has paginated batches', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.items).to.be.an('array');",
                  "    pm.expect(response.total).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/batches?page=1&limit=10",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "batches"
              ],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "limit",
                  "value": "10"
                }
              ]
            },
            "description": "验证批次列表分页查询，返回 items 数组和 total"
          },
          "x-flow": {
            "sequence": 5,
            "page": "ota-analytics",
            "trigger": "auto:page-load",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员查看批次列表，系统分页返回所有批次概览"
        },
        {
          "name": "5.2 批次分析 [AC-ANALYTICS-2]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Has analytics data', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.batch_id).to.exist;",
                  "    pm.expect(response.tickets_generated).to.exist;",
                  "    pm.expect(response.tickets_activated).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/batches/{{batch_id}}/analytics",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "batches",
                "{{batch_id}}",
                "analytics"
              ]
            },
            "description": "验证批次分析数据，包含 tickets_generated 和 tickets_activated"
          },
          "x-flow": {
            "sequence": 5,
            "page": "ota-analytics",
            "trigger": "tap:batch-card",
            "produces": [],
            "consumes": [
              "api_key",
              "batch_id"
            ]
          },
          "description": "OTA运营人员点击批次卡片查看分析，系统显示生成/激活/使用统计"
        },
        {
          "name": "5.3 分销商列表 [AC-ANALYTICS-3]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has paginated resellers', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.items).to.be.an('array');",
                  "    pm.expect(response.total).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/resellers",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "resellers"
              ]
            },
            "description": "验证分销商列表查询，返回分页的分销商数据"
          },
          "x-flow": {
            "sequence": 5,
            "page": "ota-analytics",
            "trigger": "tap:分销商列表",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA运营人员查看分销商列表，系统分页返回所有合作分销商"
        },
        {
          "name": "5.4 计费汇总 [AC-ANALYTICS-4]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has billing data', function () {",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.billing_period).to.exist;",
                  "    pm.expect(response.reseller_summaries).to.exist;",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/billing/summary?period=2025-12",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "billing",
                "summary"
              ],
              "query": [
                {
                  "key": "period",
                  "value": "2025-12"
                }
              ]
            },
            "description": "验证计费汇总查询，包含 billing_period 和 reseller_summaries"
          },
          "x-flow": {
            "sequence": 5,
            "page": "ota-billing",
            "trigger": "auto:page-load",
            "produces": [],
            "consumes": [
              "api_key"
            ]
          },
          "description": "OTA财务人员查看月度计费汇总，系统返回各分销商的结算数据"
        }
      ]
    },
    {
      "name": "6. API 安全",
      "description": "AC-SEC-1 ~ AC-SEC-2: API 认证安全测试",
      "item": [
        {
          "name": "6.1 缺少API Key (401) [AC-SEC-1]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Error indicates missing API key', function () {",
                  "    const response = pm.response.json();",
                  "    const msg = JSON.stringify(response).toLowerCase();",
                  "    pm.expect(msg).to.include('api');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/ota/batches",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "batches"
              ]
            },
            "description": "验证缺少 X-API-Key 请求头时返回 401"
          },
          "x-flow": {
            "sequence": 0,
            "page": "ota-dashboard",
            "trigger": "auto:security-test",
            "produces": [],
            "consumes": []
          },
          "description": "未携带API Key访问OTA接口时，系统返回401认证错误"
        },
        {
          "name": "6.2 无效API Key (401) [AC-SEC-2]",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});",
                  "",
                  "pm.test('Error indicates invalid API key', function () {",
                  "    const response = pm.response.json();",
                  "    const msg = JSON.stringify(response).toLowerCase();",
                  "    pm.expect(msg).to.include('invalid');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "X-API-Key",
                "value": "invalid_key_12345"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/ota/batches",
              "host": [
                "{{base_url}}"
              ],
              "path": [
                "api",
                "ota",
                "batches"
              ]
            },
            "description": "验证无效 API Key 返回 401"
          },
          "x-flow": {
            "sequence": 0,
            "page": "ota-dashboard",
            "trigger": "auto:security-test",
            "produces": [],
            "consumes": []
          },
          "description": "携带无效API Key访问OTA接口时，系统返回401认证错误"
        }
      ]
    }
  ]
}