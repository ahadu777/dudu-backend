{
  "info": {
    "_postman_id": "prd-001-cruise-ticketing-v4",
    "name": "PRD-001 Cruise Package Ticketing Platform Tests",
    "description": "PRD-001 游轮套餐售票平台测试\n\n## 覆盖率: 16/17 AC (1 SKIP)\n\n### 跳过的 AC:\n- AC-PRICE-1 周末加价 [SKIP - 暂未启用，见 order.service.ts:571]\n\n### 测试结构:\n0. Setup (1 test)\n1. 产品目录 (4 tests)\n2. 动态定价 (4 tests) - AC-PRICE-1 已 SKIP\n3. 订单管理 (3 tests) - 需要认证\n4. QR票券 (3 tests) - 需要票券\n5. 套餐功能 (3 tests)\n\n### 用户旅程:\n浏览产品 → 查看详情 → 下单 → 支付 → 获取票券\n\n### AC 映射: docs/test-coverage/prd-001-ac-mapping.yaml",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "4.0.0"
  },
  "variable": [
    {"key": "base_url", "value": "http://localhost:8080", "type": "string"},
    {"key": "auth_token", "value": "", "type": "string"},
    {"key": "order_id", "value": "", "type": "string"},
    {"key": "ticket_code", "value": "", "type": "string"},
    {"key": "qr_token", "value": "", "type": "string"}
  ],
  "item": [
    {
      "name": "0. Setup",
      "description": "测试环境准备和健康检查",
      "item": [
        {
          "name": "F0.1 Health Check",
          "description": "验证服务器健康状态，确保测试环境可用",
          "x-flow": {"sequence": 0, "page": "system", "trigger": "auto:test-setup", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Server is healthy', function() {",
            "    pm.response.to.have.status(200);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/healthz", "host": ["{{base_url}}"], "path": ["healthz"]}
          }
        }
      ]
    },
    {
      "name": "1. 产品目录",
      "description": "AC-CATALOG-1 ~ AC-CATALOG-4: 用户浏览和查询游轮套餐产品",
      "item": [
        {
          "name": "F1.1 产品列表 [AC-CATALOG-1]",
          "description": "用户打开小程序首页，浏览可购买的游轮套餐列表",
          "x-flow": {"sequence": 1, "page": "product-list", "trigger": "auto:page-load", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Response has products array', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('products');",
            "    pm.expect(data.products).to.be.an('array');",
            "});",
            "pm.test('Products have required fields', function() {",
            "    const data = pm.response.json();",
            "    if (data.products.length > 0) {",
            "        pm.expect(data.products[0]).to.have.property('id');",
            "        pm.expect(data.products[0]).to.have.property('name');",
            "        pm.expect(data.products[0]).to.have.property('base_price');",
            "    }",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products", "host": ["{{base_url}}"], "path": ["miniprogram", "products"]}
          }
        },
        {
          "name": "F1.2 产品详情 [AC-CATALOG-2]",
          "description": "用户点击商品卡片进入详情页，查看套餐包含的服务和权益",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "tap:product-card", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Product has functions', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('functions');",
            "    pm.expect(data.functions).to.be.an('array');",
            "});",
            "pm.test('Product has pricing info', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('base_price');",
            "    pm.expect(data.base_price).to.be.a('number');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/106", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "106"]}
          }
        },
        {
          "name": "F1.3 库存可用性 [AC-CATALOG-3]",
          "description": "用户选择出行日期后，系统实时查询并显示当前库存状态",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "input:date-picker", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Has availability info', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('is_available');",
            "    pm.expect(data).to.have.property('available');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/106/availability", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "106", "availability"]}
          }
        },
        {
          "name": "F1.4 无效产品ID [AC-CATALOG-4]",
          "description": "用户通过分享链接访问已下架的商品时，系统提示商品不存在",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "deeplink:share", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 404', function() { pm.response.to.have.status(404); });",
            "pm.test('Has error response', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('code');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/99999", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "99999"]}
          }
        }
      ]
    },
    {
      "name": "2. 动态定价",
      "description": "AC-PRICE-1 ~ AC-PRICE-4: 多变量动态定价验证",
      "item": [
        {
          "name": "F2.1 工作日/周末价格 [AC-PRICE-1]",
          "description": "用户查看产品价格时，系统根据选择的日期显示工作日或周末价格",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "auto:price-calculation", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Has base price and weekend premium', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('base_price');",
            "    pm.expect(data).to.have.property('weekend_premium');",
            "});",
            "pm.test('Weekend premium is positive', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data.weekend_premium).to.be.at.least(0);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/106", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "106"]}
          }
        },
        {
          "name": "F2.2 客户类型折扣 [AC-PRICE-2]",
          "description": "用户选择小童或长者类型时，系统显示优惠价格",
          "x-flow": {"sequence": 3, "page": "order-confirm", "trigger": "input:customer-type", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Has customer discounts', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('customer_discounts');",
            "    pm.expect(data.customer_discounts).to.have.property('child');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/106", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "106"]}
          }
        },
        {
          "name": "F2.3 套餐等级定价 [AC-PRICE-3]",
          "description": "用户浏览不同等级套餐时，系统显示对应价格档次",
          "x-flow": {"sequence": 1, "page": "product-list", "trigger": "scroll:load-more", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Products have tier-based pricing', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data.products).to.be.an('array');",
            "    const prices = data.products.map(p => p.base_price);",
            "    pm.expect(prices.length).to.be.above(0);",
            "    console.log('Product prices:', prices);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products", "host": ["{{base_url}}"], "path": ["miniprogram", "products"]}
          }
        },
        {
          "name": "F2.4 未认证创建订单 [AC-PRICE-4]",
          "description": "用户未登录时点击「立即预订」，系统返回401要求登录",
          "x-flow": {"sequence": 3, "page": "order-confirm", "trigger": "button:立即预订", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 401 (requires auth)', function() {",
            "    pm.response.to.have.status(401);",
            "});",
            "pm.test('Error response returned', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('code');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"product_id\": 106, \"items\": [{\"customer_type\": \"adult\", \"quantity\": 1}], \"visit_date\": \"2025-12-20\"}"},
            "url": {"raw": "{{base_url}}/miniprogram/orders", "host": ["{{base_url}}"], "path": ["miniprogram", "orders"]}
          }
        }
      ]
    },
    {
      "name": "3. 订单管理 (需认证)",
      "description": "AC-ORDER-1 ~ AC-ORDER-3: 订单创建和管理 - 需要有效 auth_token",
      "item": [
        {
          "name": "F3.1 创建订单 [AC-ORDER-1]",
          "description": "用户填写出行人信息后点击「立即预订」，系统创建订单并返回订单号",
          "x-flow": {"sequence": 3, "page": "order-confirm", "trigger": "button:立即预订", "produces": ["order_id"], "consumes": ["auth_token"]},
          "event": [{"listen": "test", "script": {"exec": [
            "// Skip if no auth token or got 401",
            "if (pm.response.code === 401) {",
            "    pm.test.skip('Requires valid auth_token - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 201', function() { pm.response.to.have.status(201); });",
            "pm.test('Order has correct structure', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('id');",
            "    pm.collectionVariables.set('order_id', data.id);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{auth_token}}"}
            ],
            "body": {"mode": "raw", "raw": "{\"order_no\": \"TEST-{{$timestamp}}\", \"product_id\": 106, \"travel_date\": \"2025-12-21\", \"customer_breakdown\": [{\"customer_type\": \"adult\", \"count\": 2}]}"},
            "url": {"raw": "{{base_url}}/miniprogram/orders", "host": ["{{base_url}}"], "path": ["miniprogram", "orders"]}
          }
        },
        {
          "name": "F3.2 订单响应时间 [AC-ORDER-2]",
          "description": "用户下单时系统在2秒内完成订单创建，确保用户体验流畅",
          "x-flow": {"sequence": 3, "page": "order-confirm", "trigger": "auto:performance-test", "produces": [], "consumes": ["auth_token"]},
          "event": [{"listen": "test", "script": {"exec": [
            "if (pm.response.code === 401) {",
            "    pm.test.skip('Requires valid auth_token - skipped');",
            "    return;",
            "}",
            "pm.test('Response time is under 2000ms', function() {",
            "    pm.expect(pm.response.responseTime).to.be.below(2000);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "POST",
            "header": [
              {"key": "Content-Type", "value": "application/json"},
              {"key": "Authorization", "value": "Bearer {{auth_token}}"}
            ],
            "body": {"mode": "raw", "raw": "{\"order_no\": \"PERF-{{$timestamp}}\", \"product_id\": 106, \"travel_date\": \"2025-12-22\", \"customer_breakdown\": [{\"customer_type\": \"adult\", \"count\": 1}]}"},
            "url": {"raw": "{{base_url}}/miniprogram/orders", "host": ["{{base_url}}"], "path": ["miniprogram", "orders"]}
          }
        },
        {
          "name": "F3.3 订单列表查询 [AC-ORDER-3]",
          "description": "用户进入「我的订单」页面查看订单列表",
          "x-flow": {"sequence": 4, "page": "order-list", "trigger": "auto:page-load", "produces": [], "consumes": ["auth_token"]},
          "event": [{"listen": "test", "script": {"exec": [
            "if (pm.response.code === 401) {",
            "    pm.test.skip('Requires valid auth_token - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Returns orders array', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('orders');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "header": [{"key": "Authorization", "value": "Bearer {{auth_token}}"}],
            "url": {"raw": "{{base_url}}/miniprogram/orders", "host": ["{{base_url}}"], "path": ["miniprogram", "orders"]}
          }
        }
      ]
    },
    {
      "name": "4. QR票券 (需票券)",
      "description": "AC-QR-1 ~ AC-QR-3: QR码生成和入场验证 - 需要有效 ticket_code",
      "item": [
        {
          "name": "F4.1 生成QR码 [AC-QR-1]",
          "description": "用户在「我的票券」页面点击显示二维码，系统生成入场用加密QR码",
          "x-flow": {"sequence": 5, "page": "my-tickets", "trigger": "tap:显示二维码", "produces": ["qr_token"], "consumes": ["ticket_code"]},
          "event": [{"listen": "test", "script": {"exec": [
            "const ticketCode = pm.collectionVariables.get('ticket_code');",
            "if (!ticketCode || pm.response.code === 404) {",
            "    pm.test.skip('Requires valid ticket_code - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('QR code data is returned', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('encrypted_data');",
            "    pm.collectionVariables.set('qr_token', data.encrypted_data);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"expiry_minutes\": 60}"},
            "url": {"raw": "{{base_url}}/qr/public/{{ticket_code}}", "host": ["{{base_url}}"], "path": ["qr", "public", "{{ticket_code}}"]}
          }
        },
        {
          "name": "F4.2 QR码包含权益 [AC-QR-2]",
          "description": "操作员扫描QR码后，系统显示票券对应的权益列表",
          "x-flow": {"sequence": 6, "page": "venue-scan", "trigger": "auto:qr-scan", "produces": [], "consumes": ["ticket_code"]},
          "event": [{"listen": "test", "script": {"exec": [
            "const ticketCode = pm.collectionVariables.get('ticket_code');",
            "if (!ticketCode || pm.response.code === 404) {",
            "    pm.test.skip('Requires valid ticket_code - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Ticket has entitlements', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('entitlements');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/qr/{{ticket_code}}/info", "host": ["{{base_url}}"], "path": ["qr", "{{ticket_code}}", "info"]}
          }
        },
        {
          "name": "F4.3 无效QR码解密 [AC-QR-3]",
          "description": "场馆操作员扫描无效二维码时，系统返回错误",
          "x-flow": {"sequence": 6, "page": "venue-scan", "trigger": "auto:qr-decrypt", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 400 (invalid QR)', function() {",
            "    pm.response.to.have.status(400);",
            "});",
            "pm.test('Error response returned', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data).to.have.property('error');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "POST",
            "header": [{"key": "Content-Type", "value": "application/json"}],
            "body": {"mode": "raw", "raw": "{\"encrypted_data\": \"invalid-qr-data\"}"},
            "url": {"raw": "{{base_url}}/qr/decrypt", "host": ["{{base_url}}"], "path": ["qr", "decrypt"]}
          }
        }
      ]
    },
    {
      "name": "5. 套餐功能",
      "description": "AC-FUNC-1 ~ AC-FUNC-3: 套餐功能验证",
      "item": [
        {
          "name": "F5.1 Premium Plan 功能 [AC-FUNC-1]",
          "description": "用户查看 Premium Plan 详情，确认包含渡轮+蒙奇奇礼品+游乐场",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "tap:product-card", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Premium Plan has functions', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data.functions).to.be.an('array');",
            "    pm.expect(data.functions.length).to.be.above(0);",
            "    const codes = data.functions.map(f => f.function_code);",
            "    pm.expect(codes).to.include('ferry');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/106", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "106"]}
          }
        },
        {
          "name": "F5.2 Pet Plan 功能 [AC-FUNC-2]",
          "description": "用户查看 Pet Plan 详情，确认包含宠物相关权益",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "tap:product-card", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "if (pm.response.code === 404) {",
            "    pm.test.skip('Product 107 not found - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Pet Plan has functions', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data.functions).to.be.an('array');",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/107", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "107"]}
          }
        },
        {
          "name": "F5.3 Deluxe Tea Set 功能 [AC-FUNC-3]",
          "description": "用户查看 Deluxe Tea Set 详情，确认包含茶点套餐",
          "x-flow": {"sequence": 2, "page": "product-detail", "trigger": "tap:product-card", "produces": [], "consumes": []},
          "event": [{"listen": "test", "script": {"exec": [
            "if (pm.response.code === 404) {",
            "    pm.test.skip('Product 108 not found - skipped');",
            "    return;",
            "}",
            "pm.test('Status code is 200', function() { pm.response.to.have.status(200); });",
            "pm.test('Deluxe Tea Set has functions', function() {",
            "    const data = pm.response.json();",
            "    pm.expect(data.functions).to.be.an('array');",
            "    pm.expect(data.functions.length).to.be.above(0);",
            "});"
          ], "type": "text/javascript"}}],
          "request": {
            "method": "GET",
            "url": {"raw": "{{base_url}}/miniprogram/products/108", "host": ["{{base_url}}"], "path": ["miniprogram", "products", "108"]}
          }
        }
      ]
    }
  ]
}
