{
  "info": {
    "name": "PRD-002 Missing Coverage Tests",
    "description": "Tests for QR Code APIs, WeChat Verification, and other missing scenarios",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8080",
      "type": "string"
    },
    {
      "key": "api_key",
      "value": "ota_full_access_key_99999",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Setup: Generate Test Ticket",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Ticket generated successfully', function() {",
              "    pm.response.to.have.status(201);",
              "    const json = pm.response.json();",
              "    pm.expect(json.tickets).to.be.an('array').with.length(1);",
              "    pm.collectionVariables.set('test_ticket_code', json.tickets[0].ticket_code);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"product_id\":106,\"quantity\":1,\"batch_id\":\"TEST-MISSING-COV-{{$timestamp}}\"}"
        },
        "url": "{{base_url}}/api/ota/tickets/bulk-generate"
      }
    },
    {
      "name": "Test 1: GET /qr/:code/info - Ticket Info API",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Status code is 200', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response contains ticket status', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('status');",
              "    pm.expect(json.status).to.equal('PRE_GENERATED');",
              "});",
              "",
              "pm.test('Response contains entitlements', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('entitlements');",
              "    pm.expect(json.entitlements).to.be.an('array');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"}
        ],
        "url": "{{base_url}}/qr/{{test_ticket_code}}/info"
      }
    },
    {
      "name": "Test 2: Activate Ticket for QR Generation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Ticket activated successfully', function() {",
              "    pm.response.to.have.status(200);",
              "    const json = pm.response.json();",
              "    pm.expect(json.status).to.equal('ACTIVE');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"customer_details\":{\"name\":\"Test User\",\"email\":\"test@example.com\",\"phone\":\"+1234567890\"},\"payment_reference\":\"PAY-TEST\"}"
        },
        "url": "{{base_url}}/api/ota/tickets/{{test_ticket_code}}/activate"
      }
    },
    {
      "name": "Test 3: POST /qr/:code - QR Code Generation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('QR code generated successfully', function() {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test('Response contains QR image', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('qr_image');",
              "    pm.expect(json.qr_image).to.be.a('string');",
              "});",
              "",
              "pm.test('Response contains expiry information', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(json).to.have.property('expires_at');",
              "    pm.collectionVariables.set('qr_verify_token', json.verify_url ? json.verify_url.split('t=')[1] : '');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"expiry_minutes\":30,\"qr_type\":\"url\"}"
        },
        "url": "{{base_url}}/qr/{{test_ticket_code}}"
      }
    },
    {
      "name": "Test 4: GET /qr/verify - WeChat Verification",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('WeChat verification page returned', function() {",
              "    pm.expect([200, 400]).to.include(pm.response.code);",
              "});",
              "",
              "pm.test('Response is HTML', function() {",
              "    pm.expect(pm.response.headers.get('Content-Type')).to.include('html');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/qr/verify?t={{qr_verify_token}}",
          "host": ["{{base_url}}"],
          "path": ["qr", "verify"],
          "query": [{"key": "t", "value": "{{qr_verify_token}}"}]
        }
      }
    },
    {
      "name": "Test 5: Partner QR Generation Isolation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Partner B cannot generate QR for Partner A ticket', function() {",
              "    pm.expect([403, 404]).to.include(pm.response.code);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "ota251103_key_67890"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"expiry_minutes\":30}"
        },
        "url": "{{base_url}}/qr/{{test_ticket_code}}"
      }
    },
    {
      "name": "Test 6: 100-Unit Reservation Limit",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Request over 100 units rejected', function() {",
              "    pm.expect([400, 422]).to.include(pm.response.code);",
              "});",
              "",
              "pm.test('Error message indicates limit', function() {",
              "    const json = pm.response.json();",
              "    pm.expect(JSON.stringify(json).toLowerCase()).to.include('limit');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"product_id\":106,\"quantity\":101}"
        },
        "url": "{{base_url}}/api/ota/reserve"
      }
    },
    {
      "name": "Test 7: Reseller Metadata Validation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('Reseller batch requires metadata', function() {",
              "    const code = pm.response.code;",
              "    if (code === 422 || code === 400) {",
              "        const json = pm.response.json();",
              "        pm.expect(JSON.stringify(json).toLowerCase()).to.include('reseller');",
              "    } else {",
              "        pm.expect(code).to.equal(201);",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "X-API-Key", "value": "{{api_key}}"},
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"product_id\":106,\"quantity\":5,\"batch_id\":\"RESELLER-TEST-{{$timestamp}}\",\"distribution_mode\":\"reseller_batch\"}"
        },
        "url": "{{base_url}}/api/ota/tickets/bulk-generate"
      }
    }
  ]
}
